<!DOCTYPE html>
<html>
<head>
    <title>{{ 'Edit Form' if is_edit else 'Create Form' }} - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .document-container {
            background: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-width: 900px;
            margin: 20px auto;
            min-height: calc(100vh - 40px);
            position: relative;
        }

        .document-header {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            color: white;
            padding: 20px 40px;
            border-radius: 8px 8px 0 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .document-toolbar {
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 40px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .toolbar-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .document-content {
            padding: 40px;
            min-height: 800px;
            background: white;
        }

        .form-title-editable {
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            border: 2px dashed transparent;
            padding: 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .form-title-editable:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .form-subtitle-editable {
            font-size: 16px;
            color: #6b7280;
            text-align: center;
            margin-bottom: 30px;
            border: 2px dashed transparent;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .form-subtitle-editable:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .form-section {
            margin-bottom: 30px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafafa;
            position: relative;
        }

        .section-header {
            background: #f9fafb;
            padding: 15px 20px;
            border-bottom: 1px solid #e5e7eb;
            font-weight: 600;
            font-size: 16px;
            color: #374151;
            display: flex;
            justify-content: between;
            align-items: center;
            position: relative;
        }

        .section-header:hover .section-controls {
            opacity: 1;
        }

        .section-controls {
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .section-control-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .section-control-btn:hover {
            background: #f3f4f6;
            transform: scale(1.1);
        }

        .form-field {
            display: flex;
            padding: 12px 20px;
            border-bottom: 1px solid #e5e7eb;
            min-height: 50px;
            align-items: center;
            position: relative;
            background: white;
        }

        .form-field:last-child {
            border-bottom: none;
        }

        .form-field:hover {
            background: #f9fafb;
        }

        .form-field:hover .field-controls {
            opacity: 1;
        }

        .field-label {
            font-weight: 500;
            color: #374151;
            min-width: 200px;
            flex-shrink: 0;
            padding-right: 15px;
            border: 2px dashed transparent;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .field-label:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .field-input {
            flex: 1;
            height: 30px;
            border-bottom: 1px solid #d1d5db;
            background: transparent;
            position: relative;
        }

        .field-input:before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: #d1d5db;
        }

        .field-controls {
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 4px;
            margin-left: 10px;
        }

        .field-control-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .field-control-btn:hover {
            background: #f3f4f6;
            transform: scale(1.1);
        }

        .checklist-section {
            background: white;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #e5e7eb;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid #f3f4f6;
            position: relative;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-item:hover {
            background: #f9fafb;
        }

        .checklist-item:hover .item-controls {
            opacity: 1;
        }

        .checkbox-style {
            width: 16px;
            height: 16px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            margin-right: 12px;
            flex-shrink: 0;
            position: relative;
        }

        .checkbox-style.critical {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .checkbox-style.critical:after {
            content: '!';
            position: absolute;
            top: -1px;
            left: 5px;
            color: #ef4444;
            font-weight: bold;
            font-size: 12px;
        }

        .checklist-text {
            flex: 1;
            color: #374151;
            border: 2px dashed transparent;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .checklist-text:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .item-controls {
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            gap: 4px;
            margin-left: 10px;
        }

        .weight-indicator {
            background: #f3f4f6;
            color: #6b7280;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 8px;
            font-weight: 500;
        }

        .critical-indicator {
            background: #fee2e2;
            color: #dc2626;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 4px;
            font-weight: 500;
        }

        .add-section-btn {
            width: 100%;
            padding: 20px;
            border: 2px dashed #d1d5db;
            background: transparent;
            border-radius: 8px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            margin: 20px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .add-section-btn:hover {
            border-color: #3b82f6;
            color: #3b82f6;
            background: #eff6ff;
        }

        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .signature-box {
            text-align: center;
            padding: 20px 0;
        }

        .signature-line {
            border-bottom: 1px solid #374151;
            margin: 20px 0 8px 0;
            height: 1px;
        }

        .signature-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal input, .modal textarea, .modal select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-top: 4px;
            margin-bottom: 16px;
        }

        .modal label {
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .inline-edit {
            border: 2px solid #3b82f6 !important;
            background: white !important;
            outline: none;
            min-height: 20px;
        }

        .save-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            display: none;
            z-index: 1001;
        }

        .floating-toolbar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .floating-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 18px;
        }

        .floating-btn.save {
            background: #10b981;
            color: white;
        }

        .floating-btn.save:hover {
            background: #059669;
            transform: scale(1.1);
        }

        .floating-btn.preview {
            background: #3b82f6;
            color: white;
        }

        .floating-btn.preview:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .editable-input {
            border: none;
            background: transparent;
            width: 100%;
            outline: none;
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            text-align: inherit;
        }

        .grid-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .grid-table th,
        .grid-table td {
            border: 1px solid #d1d5db;
            padding: 12px;
            text-align: left;
            position: relative;
        }

        .grid-table th {
            background: #f9fafb;
            font-weight: 600;
        }

        .grid-table td:hover {
            background: #f9fafb;
        }

        .table-controls {
            position: absolute;
            top: 50%;
            right: 8px;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .grid-table td:hover .table-controls {
            opacity: 1;
        }

        .add-row-btn, .add-col-btn {
            background: #f3f4f6;
            border: 1px dashed #9ca3af;
            padding: 8px;
            cursor: pointer;
            text-align: center;
            color: #6b7280;
            transition: all 0.2s;
        }

        .add-row-btn:hover, .add-col-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="document-container">
        <!-- Document Header -->
        <div class="document-header">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold">
                    {{ 'Edit Form: ' + form_template[1] if is_edit else 'Create New Form Template' }}
                </h1>
                <div class="flex gap-3">
                    <a href="/admin/forms" class="px-4 py-2 bg-white bg-opacity-20 text-white rounded-lg hover:bg-opacity-30 transition-all">
                        ‚Üê Back to Forms
                    </a>
                </div>
            </div>
        </div>

        <!-- Document Toolbar -->
        <div class="document-toolbar">
            <button class="toolbar-btn" onclick="addSection()">
                <span>‚ûï</span> Add Section
            </button>
            <button class="toolbar-btn" onclick="addField()">
                <span>üìù</span> Add Field
            </button>
            <button class="toolbar-btn" onclick="addChecklistItem()">
                <span>‚òëÔ∏è</span> Add Checklist Item
            </button>
            <button class="toolbar-btn" onclick="addTable()">
                <span>‚äû</span> Add Table
            </button>
            <div class="toolbar-btn active" onclick="toggleEditMode()">
                <span>‚úèÔ∏è</span> Edit Mode: ON
            </div>
            <button class="toolbar-btn" onclick="showPreview()">
                <span>üëÅÔ∏è</span> Preview
            </button>
        </div>

        <!-- Document Content -->
        <div class="document-content" id="documentContent">
            <!-- Form Header -->
            <div class="form-header">
                <div class="form-title-editable" contenteditable="true" data-field="title">
                    {{ form_template[1] if is_edit else 'Untitled Form' }}
                </div>
                <div class="form-subtitle-editable" contenteditable="true" data-field="subtitle">
                    {{ form_template[2] if is_edit else 'Official Inspection Document' }}
                </div>
            </div>

            <!-- Establishment Information Section -->
            <div class="form-section" data-section="establishment">
                <div class="section-header">
                    <span contenteditable="true">ESTABLISHMENT INFORMATION</span>
                    <div class="section-controls">
                        <button class="section-control-btn" onclick="addFieldToSection(this)" title="Add Field">
                            <span style="font-size: 12px;">+</span>
                        </button>
                        <button class="section-control-btn" onclick="duplicateSection(this)" title="Duplicate Section">
                            <span style="font-size: 10px;">‚ßâ</span>
                        </button>
                        <button class="section-control-btn" onclick="deleteSection(this)" title="Delete Section">
                            <span style="font-size: 10px;">√ó</span>
                        </button>
                    </div>
                </div>
                <div class="form-field">
                    <div class="field-label" contenteditable="true">Name of Establishment:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
                <div class="form-field">
                    <div class="field-label" contenteditable="true">Address:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
                <div class="form-field">
                    <div class="field-label" contenteditable="true">Owner/Operator:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
                <div class="form-field">
                    <div class="field-label" contenteditable="true">License No:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
            </div>

            <!-- Inspection Details Section -->
            <div class="form-section" data-section="inspection">
                <div class="section-header">
                    <span contenteditable="true">INSPECTION DETAILS</span>
                    <div class="section-controls">
                        <button class="section-control-btn" onclick="addFieldToSection(this)" title="Add Field">
                            <span style="font-size: 12px;">+</span>
                        </button>
                        <button class="section-control-btn" onclick="duplicateSection(this)" title="Duplicate Section">
                            <span style="font-size: 10px;">‚ßâ</span>
                        </button>
                        <button class="section-control-btn" onclick="deleteSection(this)" title="Delete Section">
                            <span style="font-size: 10px;">√ó</span>
                        </button>
                    </div>
                </div>
                <div class="form-field">
                    <div class="field-label" contenteditable="true">Inspector Name:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
                <div class="form-field">
                    <div class="field-label" contenteditable="true">Inspection Date:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
                <div class="form-field">
                    <div class="field-label" contenteditable="true">Time:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
            </div>

            <!-- Checklist Section -->
            <div class="checklist-section" data-section="checklist">
                <div class="section-header">
                    <span contenteditable="true">INSPECTION CHECKLIST</span>
                    <div class="section-controls">
                        <button class="section-control-btn" onclick="addChecklistItemToSection(this)" title="Add Checklist Item">
                            <span style="font-size: 12px;">+</span>
                        </button>
                        <button class="section-control-btn" onclick="duplicateSection(this)" title="Duplicate Section">
                            <span style="font-size: 10px;">‚ßâ</span>
                        </button>
                        <button class="section-control-btn" onclick="deleteSection(this)" title="Delete Section">
                            <span style="font-size: 10px;">√ó</span>
                        </button>
                    </div>
                </div>

                {% if items %}
                    {% for item in items %}
                    <div class="checklist-item" data-category="{{ item[2] }}" data-weight="{{ item[4] }}" data-critical="{{ 'true' if item[5] else 'false' }}">
                        <div class="checkbox-style {{ 'critical' if item[5] else '' }}"></div>
                        <div class="checklist-text" contenteditable="true">{{ item[3] }}</div>
                        {% if item[4] > 1 %}
                        <span class="weight-indicator">Weight: {{ item[4] }}</span>
                        {% endif %}
                        {% if item[5] %}
                        <span class="critical-indicator">Critical</span>
                        {% endif %}
                        <div class="item-controls">
                            <button class="field-control-btn" onclick="editChecklistItem(this)" title="Edit">‚úèÔ∏è</button>
                            <button class="field-control-btn" onclick="duplicateChecklistItem(this)" title="Duplicate">‚ßâ</button>
                            <button class="field-control-btn" onclick="deleteChecklistItem(this)" title="Delete">√ó</button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="checklist-item">
                        <div class="checkbox-style"></div>
                        <div class="checklist-text" contenteditable="true">Food storage temperatures maintained properly</div>
                        <span class="weight-indicator">Weight: 2</span>
                        <span class="critical-indicator">Critical</span>
                        <div class="item-controls">
                            <button class="field-control-btn" onclick="editChecklistItem(this)" title="Edit">‚úèÔ∏è</button>
                            <button class="field-control-btn" onclick="duplicateChecklistItem(this)" title="Duplicate">‚ßâ</button>
                            <button class="field-control-btn" onclick="deleteChecklistItem(this)" title="Delete">√ó</button>
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox-style"></div>
                        <div class="checklist-text" contenteditable="true">Hand washing facilities properly stocked</div>
                        <span class="weight-indicator">Weight: 1</span>
                        <div class="item-controls">
                            <button class="field-control-btn" onclick="editChecklistItem(this)" title="Edit">‚úèÔ∏è</button>
                            <button class="field-control-btn" onclick="duplicateChecklistItem(this)" title="Duplicate">‚ßâ</button>
                            <button class="field-control-btn" onclick="deleteChecklistItem(this)" title="Delete">√ó</button>
                        </div>
                    </div>
                    <div class="checklist-item">
                        <div class="checkbox-style"></div>
                        <div class="checklist-text" contenteditable="true">Food contact surfaces clean and sanitized</div>
                        <span class="weight-indicator">Weight: 2</span>
                        <span class="critical-indicator">Critical</span>
                        <div class="item-controls">
                            <button class="field-control-btn" onclick="editChecklistItem(this)" title="Edit">‚úèÔ∏è</button>
                            <button class="field-control-btn" onclick="duplicateChecklistItem(this)" title="Duplicate">‚ßâ</button>
                            <button class="field-control-btn" onclick="deleteChecklistItem(this)" title="Delete">√ó</button>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Overall Assessment Section -->
            <div class="form-section" data-section="assessment">
                <div class="section-header">
                    <span contenteditable="true">OVERALL ASSESSMENT</span>
                    <div class="section-controls">
                        <button class="section-control-btn" onclick="addFieldToSection(this)" title="Add Field">
                            <span style="font-size: 12px;">+</span>
                        </button>
                        <button class="section-control-btn" onclick="duplicateSection(this)" title="Duplicate Section">
                            <span style="font-size: 10px;">‚ßâ</span>
                        </button>
                        <button class="section-control-btn" onclick="deleteSection(this)" title="Delete Section">
                            <span style="font-size: 10px;">√ó</span>
                        </button>
                    </div>
                </div>
                <div class="form-field">
                    <div class="field-label" contenteditable="true">Action Required:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
                <div class="form-field">
                    <div class="field-label" contenteditable="true">Comments:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
            </div>

            <!-- Add Section Button -->
            <button class="add-section-btn" onclick="addSection()">
                <span>‚ûï</span> Add New Section
            </button>

            <!-- Signature Section -->
            <div class="signature-section">
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-label">Inspector Signature</div>
                </div>
                <div class="signature-box">
                    <div class="signature-line"></div>
                    <div class="signature-label">Date</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Toolbar -->
    <div class="floating-toolbar">
        <button class="floating-btn save" onclick="saveForm()" title="Save Form">
            üíæ
        </button>
        <button class="floating-btn preview" onclick="showPreview()" title="Preview Form">
            üëÅÔ∏è
        </button>
    </div>

    <!-- Save Indicator -->
    <div class="save-indicator" id="saveIndicator">
        ‚úÖ Form Saved Successfully
    </div>

    <!-- Modals -->
    <!-- Add Section Modal -->
    <div class="modal" id="addSectionModal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Add New Section</h3>
            <label>Section Title:</label>
            <input type="text" id="newSectionTitle" placeholder="Enter section title...">
            <label>Section Type:</label>
            <select id="newSectionType">
                <option value="fields">Fields Section</option>
                <option value="checklist">Checklist Section</option>
                <option value="table">Table Section</option>
            </select>
            <div class="flex gap-2 mt-4">
                <button onclick="confirmAddSection()" class="px-4 py-2 bg-blue-500 text-white rounded">Add Section</button>
                <button onclick="closeModal('addSectionModal')" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Edit Checklist Item Modal -->
    <div class="modal" id="editChecklistModal">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-4">Edit Checklist Item</h3>
            <label>Description:</label>
            <textarea id="editItemDescription" rows="3" placeholder="Enter item description..."></textarea>
            <label>Category:</label>
            <select id="editItemCategory">
                {% for category in categories %}
                <option value="{{ category }}">{{ category }}</option>
                {% endfor %}
            </select>
            <label>Weight (1-10):</label>
            <input type="number" id="editItemWeight" min="1" max="10" value="1">
            <label>
                <input type="checkbox" id="editItemCritical" style="width: auto; margin-right: 8px;">
                Critical Item
            </label>
            <div class="flex gap-2 mt-4">
                <button onclick="confirmEditChecklistItem()" class="px-4 py-2 bg-blue-500 text-white rounded">Save Changes</button>
                <button onclick="closeModal('editChecklistModal')" class="px-4 py-2 bg-gray-300 rounded">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let editMode = true;
        let currentEditingItem = null;
        let formData = {
            title: "{{ form_template[1] if is_edit else 'Untitled Form' }}",
            subtitle: "{{ form_template[2] if is_edit else 'Official Inspection Document' }}",
            type: "{{ form_template[3] if is_edit else 'Food Establishment' }}",
            sections: [],
            items: []
        };

        // Initialize form data
        document.addEventListener('DOMContentLoaded', function() {
            collectFormData();
            setupEditableElements();
            setupSortable();
        });

        function setupEditableElements() {
            // Setup contenteditable save on blur
            document.querySelectorAll('[contenteditable="true"]').forEach(element => {
                element.addEventListener('blur', function() {
                    saveFormData();
                });

                element.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });
        }

        function setupSortable() {
            // Make checklist items sortable
            document.querySelectorAll('.checklist-section').forEach(section => {
                Sortable.create(section, {
                    handle: '.checkbox-style',
                    animation: 150,
                    ghostClass: 'opacity-50',
                    onEnd: function() {
                        saveFormData();
                    }
                });
            });

            // Make sections sortable
            Sortable.create(document.getElementById('documentContent'), {
                handle: '.section-header',
                animation: 150,
                ghostClass: 'opacity-50',
                filter: '.form-header, .add-section-btn, .signature-section',
                onEnd: function() {
                    saveFormData();
                }
            });
        }

        function toggleEditMode() {
            editMode = !editMode;
            const toolbar = document.querySelector('.toolbar-btn[onclick="toggleEditMode()"]');
            toolbar.innerHTML = editMode ?
                '<span>‚úèÔ∏è</span> Edit Mode: ON' :
                '<span>üëÄ</span> Edit Mode: OFF';
            toolbar.className = editMode ? 'toolbar-btn active' : 'toolbar-btn';

            // Toggle contenteditable
            document.querySelectorAll('[contenteditable]').forEach(el => {
                el.contentEditable = editMode;
            });
        }

        function addSection() {
            document.getElementById('addSectionModal').style.display = 'flex';
        }

        function confirmAddSection() {
            const title = document.getElementById('newSectionTitle').value.trim();
            const type = document.getElementById('newSectionType').value;

            if (!title) {
                alert('Please enter a section title');
                return;
            }

            const sectionHtml = `
                <div class="form-section" data-section="${type}">
                    <div class="section-header">
                        <span contenteditable="true">${title.toUpperCase()}</span>
                        <div class="section-controls">
                            <button class="section-control-btn" onclick="addFieldToSection(this)" title="Add Field">
                                <span style="font-size: 12px;">+</span>
                            </button>
                            <button class="section-control-btn" onclick="duplicateSection(this)" title="Duplicate Section">
                                <span style="font-size: 10px;">‚ßâ</span>
                            </button>
                            <button class="section-control-btn" onclick="deleteSection(this)" title="Delete Section">
                                <span style="font-size: 10px;">√ó</span>
                            </button>
                        </div>
                    </div>
                    ${type === 'checklist' ? '' : `
                    <div class="form-field">
                        <div class="field-label" contenteditable="true">Field Label:</div>
                        <div class="field-input"></div>
                        <div class="field-controls">
                            <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                            <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                        </div>
                    </div>
                    `}
                </div>
            `;

            const addButton = document.querySelector('.add-section-btn');
            addButton.insertAdjacentHTML('beforebegin', sectionHtml);

            setupEditableElements();
            closeModal('addSectionModal');
            saveFormData();
        }

        function addFieldToSection(button) {
            const section = button.closest('.form-section');
            const fieldHtml = `
                <div class="form-field">
                    <div class="field-label" contenteditable="true">New Field:</div>
                    <div class="field-input"></div>
                    <div class="field-controls">
                        <button class="field-control-btn" onclick="duplicateField(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteField(this)" title="Delete">√ó</button>
                    </div>
                </div>
            `;
            section.insertAdjacentHTML('beforeend', fieldHtml);
            setupEditableElements();
            saveFormData();
        }

        function addChecklistItemToSection(button) {
            const section = button.closest('.checklist-section, .form-section');
            const itemHtml = `
                <div class="checklist-item" data-category="General" data-weight="1" data-critical="false">
                    <div class="checkbox-style"></div>
                    <div class="checklist-text" contenteditable="true">New checklist item</div>
                    <span class="weight-indicator">Weight: 1</span>
                    <div class="item-controls">
                        <button class="field-control-btn" onclick="editChecklistItem(this)" title="Edit">‚úèÔ∏è</button>
                        <button class="field-control-btn" onclick="duplicateChecklistItem(this)" title="Duplicate">‚ßâ</button>
                        <button class="field-control-btn" onclick="deleteChecklistItem(this)" title="Delete">√ó</button>
                    </div>
                </div>
            `;
            section.insertAdjacentHTML('beforeend', itemHtml);
            setupEditableElements();
            saveFormData();
        }

        function addChecklistItem() {
            // Add to the first checklist section found
            const checklistSection = document.querySelector('.checklist-section');
            if (checklistSection) {
                const button = checklistSection.querySelector('.section-control-btn');
                addChecklistItemToSection(button);
            }
        }

        function editChecklistItem(button) {
            const item = button.closest('.checklist-item');
            currentEditingItem = item;

            document.getElementById('editItemDescription').value = item.querySelector('.checklist-text').textContent;
            document.getElementById('editItemCategory').value = item.dataset.category;
            document.getElementById('editItemWeight').value = item.dataset.weight;
            document.getElementById('editItemCritical').checked = item.dataset.critical === 'true';

            document.getElementById('editChecklistModal').style.display = 'flex';
        }

        function confirmEditChecklistItem() {
            if (!currentEditingItem) return;

            const description = document.getElementById('editItemDescription').value.trim();
            const category = document.getElementById('editItemCategory').value;
            const weight = parseInt(document.getElementById('editItemWeight').value);
            const critical = document.getElementById('editItemCritical').checked;

            if (!description) {
                alert('Please enter a description');
                return;
            }

            // Update item data
            currentEditingItem.dataset.category = category;
            currentEditingItem.dataset.weight = weight;
            currentEditingItem.dataset.critical = critical;

            // Update display
            currentEditingItem.querySelector('.checklist-text').textContent = description;

            // Update weight indicator
            const weightIndicator = currentEditingItem.querySelector('.weight-indicator');
            if (weightIndicator) {
                weightIndicator.textContent = `Weight: ${weight}`;
            }

            // Update critical indicator
            const checkbox = currentEditingItem.querySelector('.checkbox-style');
            const criticalIndicator = currentEditingItem.querySelector('.critical-indicator');

            if (critical) {
                checkbox.classList.add('critical');
                if (!criticalIndicator) {
                    const newCritical = document.createElement('span');
                    newCritical.className = 'critical-indicator';
                    newCritical.textContent = 'Critical';
                    currentEditingItem.appendChild(newCritical);
                }
            } else {
                checkbox.classList.remove('critical');
                if (criticalIndicator) {
                    criticalIndicator.remove();
                }
            }

            closeModal('editChecklistModal');
            saveFormData();
        }

        function duplicateField(button) {
            const field = button.closest('.form-field');
            const clone = field.cloneNode(true);
            field.parentNode.insertBefore(clone, field.nextSibling);
            setupEditableElements();
            saveFormData();
        }

        function deleteField(button) {
            if (confirm('Delete this field?')) {
                button.closest('.form-field').remove();
                saveFormData();
            }
        }

        function duplicateChecklistItem(button) {
            const item = button.closest('.checklist-item');
            const clone = item.cloneNode(true);
            item.parentNode.insertBefore(clone, item.nextSibling);
            setupEditableElements();
            saveFormData();
        }

        function deleteChecklistItem(button) {
            if (confirm('Delete this checklist item?')) {
                button.closest('.checklist-item').remove();
                saveFormData();
            }
        }

        function duplicateSection(button) {
            const section = button.closest('.form-section, .checklist-section');
            const clone = section.cloneNode(true);
            section.parentNode.insertBefore(clone, section.nextSibling);
            setupEditableElements();
            saveFormData();
        }

        function deleteSection(button) {
            if (confirm('Delete this entire section?')) {
                button.closest('.form-section, .checklist-section').remove();
                saveFormData();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Clear form
            if (modalId === 'addSectionModal') {
                document.getElementById('newSectionTitle').value = '';
                document.getElementById('newSectionType').value = 'fields';
            }
        }

        function collectFormData() {
            formData.title = document.querySelector('[data-field="title"]').textContent.trim();
            formData.subtitle = document.querySelector('[data-field="subtitle"]').textContent.trim();

            // Collect checklist items
            formData.items = [];
            document.querySelectorAll('.checklist-item').forEach((item, index) => {
                formData.items.push({
                    order: index + 1,
                    category: item.dataset.category || 'General',
                    description: item.querySelector('.checklist-text').textContent.trim(),
                    weight: parseInt(item.dataset.weight) || 1,
                    critical: item.dataset.critical === 'true'
                });
            });
        }

        function saveFormData() {
            collectFormData();
            // Auto-save functionality could be implemented here
            console.log('Form data updated:', formData);
        }

        async function saveForm() {
            collectFormData();

            if (!formData.title.trim()) {
                alert('Please enter a form title');
                return;
            }

            const data = {
                form_id: {{ form_template[0] if is_edit else 'null' }},
                form_name: formData.title,
                form_description: formData.subtitle,
                form_type: formData.type,
                items: formData.items
            };

            try {
                const response = await fetch('/admin/forms/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    showSaveIndicator();
                    setTimeout(() => {
                        window.location.href = '/admin/forms';
                    }, 1500);
                } else {
                    alert('Error saving form: ' + result.error);
                }
            } catch (error) {
                alert('Error saving form: ' + error.message);
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function showPreview() {
            window.open(`/admin/forms/preview/{{ form_template[0] if is_edit else '' }}`, '_blank');
        }

        // Click outside modal to close
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Auto-save on changes
        let autoSaveTimeout;
        document.addEventListener('input', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(saveFormData, 1000);
        });
    </script>
    {% include 'zozi_badge.html' %}
</body>
</html>