<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Builder - Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
            padding: 8px 16px;
            font-size: 12px;
        }

        .content {
            padding: 30px;
        }

        .form-selector {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .form-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .form-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background: white;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #ddd;
            margin-bottom: 30px;
        }

        .tab {
            padding: 15px 30px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .version-badge {
            background: #ffc107;
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .item-list, .field-list {
            margin-top: 20px;
        }

        .item, .field-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .item.editing, .field-item.editing {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .item-header, .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-info, .field-info {
            flex: 1;
        }

        .item-actions, .field-actions {
            display: flex;
            gap: 10px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.show {
            display: block;
        }

        .add-new-section {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 2px dashed #667eea;
        }

        .add-new-section h3 {
            margin-bottom: 15px;
            color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>üîß Form Builder</h1>
            <a href="/admin" class="btn btn-secondary">‚Üê Back to Dashboard</a>
        </div>

        <div class="content">
            <!-- Messages -->
            <div id="successMessage" class="message success"></div>
            <div id="errorMessage" class="message error"></div>

            <!-- Form Selector -->
            <div class="form-selector">
                <label for="formType">Select Form Type to Edit:</label>
                <select id="formType" onchange="selectForm()">
                    <option value="">-- Choose a Form --</option>
                    {% for template in templates %}
                    <option value="{{ template[0] }}" data-version="{{ template[6] }}">{{ template[1] }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Form Editor (shows after selecting a form) -->
            <div id="formEditor" style="display:none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 id="formTitle">Editing Form</h2>
                    <div style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
                        <span class="version-badge">Version: <span id="formVersion">1.0</span></span>
                        <div id="lastEditedInfo" style="font-size:12px; color:#666; font-style:italic; text-align:right;"></div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('items')">üìã Checklist Items</button>
                    <button class="tab" onclick="switchTab('fields')">üìù Form Fields</button>
                </div>

                <!-- TAB 1: Checklist Items -->
                <div id="items-tab" class="tab-content active">
                    <!-- Add New Item -->
                    <div class="add-new-section">
                        <h3>‚ûï Add New Checklist Item</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Category</label>
                                <input type="text" id="newCategory" placeholder="e.g., FOOD, SAFETY" />
                            </div>
                            <div class="form-group">
                                <label>Weight</label>
                                <input type="number" id="newWeight" value="1" min="1" max="10" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="newDescription" placeholder="Enter checklist item description"></textarea>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="newCritical" />
                            <label for="newCritical">Mark as Critical Item</label>
                        </div>
                        <button class="btn btn-primary" onclick="createItem()" style="margin-top:15px;">Add Item</button>
                    </div>

                    <!-- Items List -->
                    <div id="itemsList" class="item-list"></div>
                </div>

                <!-- TAB 2: Form Fields -->
                <div id="fields-tab" class="tab-content">
                    <!-- Add New Field -->
                    <div class="add-new-section">
                        <h3>‚ûï Add New Form Field</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Field Name (code)</label>
                                <input type="text" id="newFieldName" placeholder="e.g., telephone_no" />
                            </div>
                            <div class="form-group">
                                <label>Field Label (display)</label>
                                <input type="text" id="newFieldLabel" placeholder="e.g., Telephone Number" />
                            </div>
                            <div class="form-group">
                                <label>Field Type</label>
                                <select id="newFieldType">
                                    <option value="text">Text</option>
                                    <option value="textarea">Text Area</option>
                                    <option value="number">Number</option>
                                    <option value="date">Date</option>
                                    <option value="time">Time</option>
                                    <option value="tel">Telephone</option>
                                    <option value="email">Email</option>
                                    <option value="select">Dropdown (Select)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Field Group</label>
                                <select id="newFieldGroup">
                                    <option value="establishment_info">Establishment Info</option>
                                    <option value="inspection_details">Inspection Details</option>
                                    <option value="results">Results</option>
                                    <option value="main">Main</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Placeholder Text</label>
                                <input type="text" id="newFieldPlaceholder" placeholder="Enter placeholder..." />
                            </div>
                            <div class="form-group">
                                <label>Options (comma-separated, for dropdown)</label>
                                <input type="text" id="newFieldOptions" placeholder="Option1,Option2,Option3" />
                            </div>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="newFieldRequired" />
                            <label for="newFieldRequired">Required Field</label>
                        </div>
                        <button class="btn btn-primary" onclick="createField()" style="margin-top:15px;">Add Field</button>
                    </div>

                    <!-- Fields List -->
                    <div id="fieldsList" class="field-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTemplateId = null;
        let currentVersion = '1.0';
        let items = [];
        let fields = [];

        function selectForm() {
            const select = document.getElementById('formType');
            const selectedOption = select.options[select.selectedIndex];
            currentTemplateId = select.value;
            currentVersion = selectedOption.dataset.version || '1.0';

            if (!currentTemplateId) {
                document.getElementById('formEditor').style.display = 'none';
                return;
            }

            document.getElementById('formTitle').textContent = 'Editing: ' + selectedOption.text;
            document.getElementById('formVersion').textContent = currentVersion;
            document.getElementById('formEditor').style.display = 'block';

            // Load template info (including last edited details)
            loadTemplateInfo();

            // Load both tabs
            loadFormItems();
            loadFormFields();
        }

        function loadTemplateInfo() {
            fetch(`/api/admin/forms/template/${currentTemplateId}/info`)
                .then(response => response.json())
                .then(data => {
                    const lastEditedDiv = document.getElementById('lastEditedInfo');
                    if (data.last_edited_by) {
                        const editDate = new Date(data.last_edited_date);
                        const formattedDate = editDate.toLocaleString();
                        lastEditedDiv.innerHTML = `Last edited by <strong>${data.last_edited_by}</strong> (${data.last_edited_role || 'admin'})<br>${formattedDate}`;
                    } else {
                        lastEditedDiv.innerHTML = 'No edits yet';
                    }
                })
                .catch(error => {
                    console.error('Error loading template info:', error);
                });
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // ============================================================================
        // CHECKLIST ITEMS TAB
        // ============================================================================

        function loadFormItems() {
            fetch(`/api/admin/forms/template/${currentTemplateId}/items`)
                .then(response => response.json())
                .then(data => {
                    items = data.items;
                    renderItems();
                })
                .catch(error => {
                    showError('Failed to load checklist items: ' + error);
                });
        }

        function renderItems() {
            const container = document.getElementById('itemsList');
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No checklist items yet</h3>
                        <p>Add your first checklist item above</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map((item, index) => `
                <div class="item" id="item-${item.id}">
                    <div class="item-header">
                        <div class="item-info">
                            <strong>Item #${item.item_order}</strong> -
                            <span style="color:#667eea;">${item.category}</span> -
                            Weight: ${item.weight}
                            ${item.is_critical ? '<span style="background:#dc3545;color:white;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:10px;">CRITICAL</span>' : ''}
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-secondary" onclick="moveItemUp(${index})" ${index === 0 ? 'disabled' : ''} style="padding:6px 12px;font-size:16px;">‚Üë</button>
                            <button class="btn btn-secondary" onclick="moveItemDown(${index})" ${index === items.length - 1 ? 'disabled' : ''} style="padding:6px 12px;font-size:16px;">‚Üì</button>
                            <button class="btn btn-warning" onclick="editItem(${item.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteItem(${item.id})">Delete</button>
                        </div>
                    </div>
                    <div style="margin-top:10px;color:#555;">${item.description}</div>
                    <div id="edit-form-${item.id}" style="display:none;margin-top:15px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Category</label>
                                <input type="text" id="edit-category-${item.id}" value="${item.category}" />
                            </div>
                            <div class="form-group">
                                <label>Weight</label>
                                <input type="number" id="edit-weight-${item.id}" value="${item.weight}" min="1" max="10" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="edit-description-${item.id}">${item.description}</textarea>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="edit-critical-${item.id}" ${item.is_critical ? 'checked' : ''} />
                            <label>Critical Item</label>
                        </div>
                        <div style="margin-top:15px;display:flex;gap:10px;">
                            <button class="btn btn-primary" onclick="saveItem(${item.id})">Save Changes</button>
                            <button class="btn btn-secondary" onclick="cancelEdit(${item.id})">Cancel</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Store current items for reordering
            window.currentItems = items;
        }

        function createItem() {
            const data = {
                form_template_id: parseInt(currentTemplateId),
                category: document.getElementById('newCategory').value,
                description: document.getElementById('newDescription').value,
                weight: parseInt(document.getElementById('newWeight').value),
                is_critical: document.getElementById('newCritical').checked ? 1 : 0
            };

            if (!data.category || !data.description) {
                showError('Please fill in all required fields');
                return;
            }

            fetch('/api/admin/forms/item', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                showSuccess('Checklist item created successfully!');
                loadFormItems();
                loadTemplateInfo();  // Refresh last edited info
                incrementVersion();
                // Clear form
                document.getElementById('newCategory').value = '';
                document.getElementById('newDescription').value = '';
                document.getElementById('newWeight').value = '1';
                document.getElementById('newCritical').checked = false;
            })
            .catch(error => showError('Failed to create item: ' + error));
        }

        function editItem(itemId) {
            document.getElementById(`item-${itemId}`).classList.add('editing');
            document.getElementById(`edit-form-${itemId}`).style.display = 'block';
        }

        function cancelEdit(itemId) {
            document.getElementById(`item-${itemId}`).classList.remove('editing');
            document.getElementById(`edit-form-${itemId}`).style.display = 'none';
        }

        function saveItem(itemId) {
            const data = {
                category: document.getElementById(`edit-category-${itemId}`).value,
                description: document.getElementById(`edit-description-${itemId}`).value,
                weight: parseInt(document.getElementById(`edit-weight-${itemId}`).value),
                is_critical: document.getElementById(`edit-critical-${itemId}`).checked ? 1 : 0
            };

            fetch(`/api/admin/forms/item/${itemId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                showSuccess('Item updated successfully!');
                loadFormItems();
                loadTemplateInfo();  // Refresh last edited info
                incrementVersion();
            })
            .catch(error => showError('Failed to update item: ' + error));
        }

        function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?\n\nIt will be removed from future forms but preserved in completed inspections.')) {
                return;
            }

            fetch(`/api/admin/forms/item/${itemId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                showSuccess('Item deleted successfully!');
                loadFormItems();
                loadTemplateInfo();  // Refresh last edited info
                incrementVersion();
            })
            .catch(error => showError('Failed to delete item: ' + error));
        }

        function moveItemUp(index) {
            if (index <= 0) return;

            // Swap items
            const items = [...window.currentItems];
            [items[index], items[index - 1]] = [items[index - 1], items[index]];

            // Update order
            reorderItems(items);
        }

        function moveItemDown(index) {
            if (index >= window.currentItems.length - 1) return;

            // Swap items
            const items = [...window.currentItems];
            [items[index], items[index + 1]] = [items[index + 1], items[index]];

            // Update order
            reorderItems(items);
        }

        function reorderItems(items) {
            // Create array of {id, order} for API
            const reorderData = {
                items: items.map((item, newIndex) => ({
                    id: item.id,
                    order: newIndex + 1  // 1-based indexing
                }))
            };

            fetch('/api/admin/forms/items/reorder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(reorderData)
            })
            .then(response => response.json())
            .then(result => {
                showSuccess('Items reordered successfully!');
                loadFormItems();  // Refresh display
                loadTemplateInfo();  // Refresh last edited info
                incrementVersion();
            })
            .catch(error => showError('Failed to reorder items: ' + error));
        }

        // ============================================================================
        // FORM FIELDS TAB
        // ============================================================================

        function loadFormFields() {
            fetch(`/api/admin/forms/template/${currentTemplateId}/fields`)
                .then(response => response.json())
                .then(data => {
                    fields = data.fields;
                    renderFields();
                })
                .catch(error => {
                    showError('Failed to load form fields: ' + error);
                });
        }

        function renderFields() {
            const container = document.getElementById('fieldsList');
            if (fields.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <h3>No form fields yet</h3>
                        <p>Add your first form field above</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = fields.map(field => `
                <div class="field-item" id="field-${field.id}">
                    <div class="field-header">
                        <div class="field-info">
                            <strong>${field.field_label}</strong>
                            <span style="color:#999;">(${field.field_name})</span> -
                            <span style="color:#667eea;">${field.field_type}</span>
                            ${field.required ? '<span style="background:#dc3545;color:white;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:10px;">REQUIRED</span>' : ''}
                        </div>
                        <div class="field-actions">
                            <button class="btn btn-warning" onclick="editField(${field.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteField(${field.id})">Delete</button>
                        </div>
                    </div>
                    <div style="margin-top:10px;color:#555;">
                        Group: ${field.field_group} |
                        Placeholder: "${field.placeholder || 'None'}"
                        ${field.options ? `| Options: ${field.options}` : ''}
                    </div>
                    <div id="edit-field-form-${field.id}" style="display:none;margin-top:15px;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Field Label</label>
                                <input type="text" id="edit-field-label-${field.id}" value="${field.field_label}" />
                            </div>
                            <div class="form-group">
                                <label>Field Type</label>
                                <select id="edit-field-type-${field.id}">
                                    <option value="text" ${field.field_type === 'text' ? 'selected' : ''}>Text</option>
                                    <option value="textarea" ${field.field_type === 'textarea' ? 'selected' : ''}>Text Area</option>
                                    <option value="number" ${field.field_type === 'number' ? 'selected' : ''}>Number</option>
                                    <option value="date" ${field.field_type === 'date' ? 'selected' : ''}>Date</option>
                                    <option value="time" ${field.field_type === 'time' ? 'selected' : ''}>Time</option>
                                    <option value="tel" ${field.field_type === 'tel' ? 'selected' : ''}>Telephone</option>
                                    <option value="email" ${field.field_type === 'email' ? 'selected' : ''}>Email</option>
                                    <option value="select" ${field.field_type === 'select' ? 'selected' : ''}>Dropdown</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Placeholder</label>
                                <input type="text" id="edit-field-placeholder-${field.id}" value="${field.placeholder || ''}" />
                            </div>
                            <div class="form-group">
                                <label>Field Group</label>
                                <select id="edit-field-group-${field.id}">
                                    <option value="establishment_info" ${field.field_group === 'establishment_info' ? 'selected' : ''}>Establishment Info</option>
                                    <option value="inspection_details" ${field.field_group === 'inspection_details' ? 'selected' : ''}>Inspection Details</option>
                                    <option value="results" ${field.field_group === 'results' ? 'selected' : ''}>Results</option>
                                    <option value="main" ${field.field_group === 'main' ? 'selected' : ''}>Main</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Options (comma-separated, for dropdown)</label>
                            <input type="text" id="edit-field-options-${field.id}" value="${field.options || ''}" />
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="edit-field-required-${field.id}" ${field.required ? 'checked' : ''} />
                            <label>Required Field</label>
                        </div>
                        <div style="margin-top:15px;display:flex;gap:10px;">
                            <button class="btn btn-primary" onclick="saveField(${field.id})">Save Changes</button>
                            <button class="btn btn-secondary" onclick="cancelFieldEdit(${field.id})">Cancel</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function createField() {
            const data = {
                form_template_id: parseInt(currentTemplateId),
                field_name: document.getElementById('newFieldName').value,
                field_label: document.getElementById('newFieldLabel').value,
                field_type: document.getElementById('newFieldType').value,
                field_group: document.getElementById('newFieldGroup').value,
                placeholder: document.getElementById('newFieldPlaceholder').value,
                options: document.getElementById('newFieldOptions').value,
                required: document.getElementById('newFieldRequired').checked ? 1 : 0
            };

            if (!data.field_name || !data.field_label) {
                showError('Please fill in field name and label');
                return;
            }

            fetch('/api/admin/forms/field', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                showSuccess('Form field created successfully!');
                loadFormFields();
                loadTemplateInfo();  // Refresh last edited info
                incrementVersion();
                // Clear form
                document.getElementById('newFieldName').value = '';
                document.getElementById('newFieldLabel').value = '';
                document.getElementById('newFieldPlaceholder').value = '';
                document.getElementById('newFieldOptions').value = '';
                document.getElementById('newFieldRequired').checked = false;
            })
            .catch(error => showError('Failed to create field: ' + error));
        }

        function editField(fieldId) {
            document.getElementById(`field-${fieldId}`).classList.add('editing');
            document.getElementById(`edit-field-form-${fieldId}`).style.display = 'block';
        }

        function cancelFieldEdit(fieldId) {
            document.getElementById(`field-${fieldId}`).classList.remove('editing');
            document.getElementById(`edit-field-form-${fieldId}`).style.display = 'none';
        }

        function saveField(fieldId) {
            const field = fields.find(f => f.id === fieldId);
            const data = {
                field_label: document.getElementById(`edit-field-label-${fieldId}`).value,
                field_type: document.getElementById(`edit-field-type-${fieldId}`).value,
                field_order: field.field_order,
                placeholder: document.getElementById(`edit-field-placeholder-${fieldId}`).value,
                options: document.getElementById(`edit-field-options-${fieldId}`).value,
                field_group: document.getElementById(`edit-field-group-${fieldId}`).value,
                required: document.getElementById(`edit-field-required-${fieldId}`).checked ? 1 : 0
            };

            fetch(`/api/admin/forms/field/${fieldId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                showSuccess('Field updated successfully!');
                loadFormFields();
                loadTemplateInfo();  // Refresh last edited info
                incrementVersion();
            })
            .catch(error => showError('Failed to update field: ' + error));
        }

        function deleteField(fieldId) {
            if (!confirm('Are you sure you want to delete this field?\n\nIt will be removed from future forms but preserved in completed inspections.')) {
                return;
            }

            fetch(`/api/admin/forms/field/${fieldId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(result => {
                showSuccess('Field deleted successfully!');
                loadFormFields();
                loadTemplateInfo();  // Refresh last edited info
                incrementVersion();
            })
            .catch(error => showError('Failed to delete field: ' + error));
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        function incrementVersion() {
            fetch(`/api/admin/forms/template/${currentTemplateId}/version`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                currentVersion = result.new_version;
                document.getElementById('formVersion').textContent = currentVersion;
                // Refresh the "last edited by" info after version increment
                loadTemplateInfo();
            });
        }

        function showSuccess(message) {
            const el = document.getElementById('successMessage');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function showError(message) {
            const el = document.getElementById('errorMessage');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }
    </script>
</body>
</html>
