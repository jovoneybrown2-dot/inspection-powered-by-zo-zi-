<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background: url('{{ url_for("static", filename="heart2.jpg") }}') no-repeat center center fixed;
            background-size: cover;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* TradingView Chart Styles */
        .chart-container {
            background: #131722;
            border-radius: 8px;
            height: 500px;
            margin: 20px 0;
            position: relative;
        }

        .chart-header {
            background: #1e222d;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            color: #d1d4dc;
            font-size: 18px;
            font-weight: 600;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            background: #2a2e39;
            color: #787b86;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .chart-btn:hover {
            background: #363a45;
            color: #d1d4dc;
        }

        .chart-btn.active {
            background: #2962ff;
            color: white;
        }

        .chart-area {
            height: 420px;
            position: relative;
        }

        .metrics-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(30, 34, 45, 0.9);
            padding: 10px;
            border-radius: 4px;
            color: #d1d4dc;
            font-size: 12px;
            z-index: 10;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            min-width: 280px;
        }

        /* Search Bar Styles */
        .search-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }

        .suggestion-item:hover {
            background: #f3f4f6;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-type {
            display: inline-block;
            padding: 2px 8px;
            font-size: 12px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* Statistics Toggle Buttons */
        .stats-toggles {
            display: flex;
            gap: 8px;
            margin-left: 20px;
        }

        .stat-toggle {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            background: #2a2e39;
            color: #787b86;
            border: none;
            transition: all 0.2s;
        }

        .stat-toggle:hover {
            background: #363a45;
            color: #d1d4dc;
        }

        .stat-toggle.active {
            background: #2962ff;
            color: white;
        }

        /* Admin Tools & Modal Styles */
        .black-bold { color: #000000; font-weight: bold; }
        .blue-bold { color: #0000FF; font-weight: bold; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .form-action-button {
            background-color: #3B82F6;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            border: none;
        }
        .form-action-button:hover { background-color: #2563EB; }

        .alert-dropdown {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
        }
        .alert-dropdown.open { display: block; }

        .alert-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .alert-item.critical {
            background: #ffcccc;
            border: 1px solid #ff0000;
        }
        .alert-item.warning {
            background: #fff4cc;
            border: 1px solid #ff9900;
        }

        .admin-tools-container {
            position: fixed;
            right: 20px;
            top: 120px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 12px;
            z-index: 999;
            display: none;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 10px;
            width: 320px;
        }
        .admin-tools-container.open { display: grid; }

        .sidebar-button {
            background-color: #3B82F6;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        .sidebar-button:hover { background-color: #2563EB; }
        .sidebar-button:active { transform: scale(0.95); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        .modal.open { display: flex; }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
        }

        #map {
            height: 400px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        /* Table improvements */
        .truncate-text {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .form-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #4338ca;
        }

        /* Form Creation Styles */
        .form-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .create-form-btn {
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }

        .create-form-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .form-dropdown {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            display: none;
            z-index: 1001;
        }

        .form-dropdown.open {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .form-option:hover {
            background: #f8fafc;
        }

        .form-option:last-child {
            border-bottom: none;
        }

        .form-option-title {
            font-weight: bold;
            color: #374151;
        }

        .form-option-desc {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <form class="absolute top-4 left-4" method="POST" action="/logout">
            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
        </form>

        <h1 class="text-3xl font-bold text-center black-bold mb-6">Admin Dashboard</h1>

        <!-- Alert Bell -->
        <div class="absolute top-4 right-4">
            <div class="relative">
                <button id="alertBell" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span id="alertBadge" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs" style="display: none;"></span>
                </button>
                <div id="alertDropdown" class="alert-dropdown">
                    <div id="alertList" class="p-2"></div>
                </div>
            </div>
        </div>

        <!-- Global Search Bar -->
        <div class="search-container">
            <input
                type="text"
                id="globalSearchInput"
                placeholder="Search inspections by name, owner, or license..."
                class="search-input"
                autocomplete="off"
            >
            <div id="searchSuggestions" class="search-suggestions"></div>
        </div>

        <!-- Tabs -->
        <div class="flex justify-center mb-6 items-center">
            <div class="inline-flex rounded-md shadow-sm" role="group" style="flex-wrap: wrap;">
                <button data-tab="overview" class="tab active px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100">Overview</button>
                <button data-tab="food" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Food</button>
                <button data-tab="residential" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Residential</button>
                <button data-tab="burial" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Burial</button>
                <button data-tab="spirit_licence" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Spirit Licence</button>
                <button data-tab="swimming_pool" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Swimming Pool</button>
                <button data-tab="small_hotels" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Small Hotels</button>
                <button data-tab="barbershop" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Barbershop</button>
                <button data-tab="institutional" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 rounded-r-lg hover:bg-gray-100">Institutional</button>
            </div>
            <button id="adminToolsButton" class="ml-auto px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg hover:bg-gray-100">Admin Tools</button>
        </div>

        <!-- Admin Tools Container -->
        <div id="adminToolsContainer" class="admin-tools-container">
            <button class="sidebar-button" onclick="openModal('active_users')">üë• Active Users</button>
            <button class="sidebar-button" onclick="openModal('audit_log')">üìã Audit Log</button>
            <button class="sidebar-button" onclick="openModal('inspector_performance')">üìä Inspector Performance</button>
            <button class="sidebar-button" onclick="openModal('alerts')">üö® Alerts</button>
            <button class="sidebar-button" onclick="openModal('inspection_map')">üó∫Ô∏è Inspection Map</button>
            <button class="sidebar-button" onclick="openModal('custom_reports')">üìà Custom Reports</button>
            <button class="sidebar-button" onclick="openModal('user_management')">üë§ User Management</button>
            <button class="sidebar-button" onclick="openModal('system_health')">üíö System Health</button>
            <button class="sidebar-button" onclick="openModal('task_assignment')">üìù Task Assignment</button>
            <button class="sidebar-button" onclick="openModal('security_metrics')">üîí Security Metrics</button>
            <button class="sidebar-button" onclick="window.location.href='/admin/forms'">üìù Manage Forms</button>
            <button class="sidebar-button" onclick="window.location.href='/parish_leaderboard'">üèÜ Parish Rankings</button>
            <button class="sidebar-button" onclick="toggleFormCreator()">‚ûï Create Forms</button>
            <button class="sidebar-button" onclick="openModal('inspector_dashboard_view')">üìä Inspector View</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <h2 class="text-2xl font-bold mb-4 blue-bold">All Inspections Overview</h2>

            <!-- TradingView Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">INSPECTION METRICS</div>
                    <div class="chart-controls">
                        <button class="chart-btn chart-type-btn active" data-type="candlestick">Candlestick</button>
                        <button class="chart-btn chart-type-btn" data-type="line">Line</button>
                        <button class="chart-btn chart-type-btn" data-type="area">Area</button>
                        <button class="chart-btn time-btn active" data-time="daily">Daily</button>
                        <button class="chart-btn time-btn" data-time="weekly">Weekly</button>
                        <button class="chart-btn time-btn" data-time="monthly">Monthly</button>
                        <div class="stats-toggles">
                            <button class="stat-toggle" data-stat="mean" data-tab="overview">Mean</button>
                            <button class="stat-toggle" data-stat="median" data-tab="overview">Median</button>
                            <button class="stat-toggle" data-stat="mode" data-tab="overview">Mode</button>
                        </div>
                    </div>
                </div>
                <div class="chart-area">
                    <div class="metrics-display" id="metricsDisplay">
                        <div>Pass Rate: <span id="passRate">0%</span></div>
                        <div>Total Inspections: <span id="totalInspections">0</span></div>
                        <div>Failed: <span id="failedInspections">0</span></div>
                        <div>Mean Score: <span id="meanScore">0%</span></div>
                        <div>Median Score: <span id="medianScore">0%</span></div>
                        <div>Mode Score: <span id="modeScore">0%</span></div>
                    </div>
                    <div id="overviewChart"></div>
                </div>
            </div>

            <!-- Data Table with corrected columns -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden mt-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name/Establishment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner/Applicant</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for form in forms %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="form-id">{{ '%03d'|format(loop.index) }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="truncate-text" title="{{ form[4] if form[4] else 'N/A' }}">
                                    {% if form[1] == 'Food Establishment' %}
                                        {{ form[4] if form[4] else 'Food Establishment' }}
                                    {% elif form[1] == 'Residential' %}
                                        {{ form[4] if form[4] else 'Residential Property' }}
                                    {% elif form[1] == 'Burial' %}
                                        {{ form[4] if form[4] else 'Burial Application' }}
                                    {% elif form[1] == 'Spirit Licence Premises' %}
                                        {{ form[4] if form[4] else 'Spirit Licence Premises' }}
                                    {% elif form[1] == 'Swimming Pool' %}
                                        {{ form[4] if form[4] else 'Swimming Pool Facility' }}
                                    {% elif form[1] == 'Small Hotel' %}
                                        {{ form[4] if form[4] else 'Small Hotel' }}
                                    {% else %}
                                        {{ form[4] if form[4] else form[1] }}
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-500">{{ form[1] }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="truncate-text">
                                    {{ form[6] if form[6] else 'N/A' }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded {{ 'bg-green-100 text-green-800' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'bg-red-100 text-red-800' }}">
                                    {{ 'Pass' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'Fail' }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ form[3].split(' ')[0] if form[3] else 'N/A' }}</div>
                                <div class="text-xs text-gray-500">{{ form[3].split(' ', 1)[1] if form[3] and ' ' in form[3] else 'N/A' }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="form-actions">
                                    <button class="form-action-button" onclick="viewForm('{{ form[0] }}', '{{ form[1] }}')">View</button>
                                    <button class="form-action-button" onclick="downloadForm('{{ form[0] }}', '{{ form[1] }}')">Download</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Individual Tabs for each inspection type -->
        {% for tab in ['food', 'residential', 'burial', 'spirit_licence', 'swimming_pool', 'small_hotels', 'barbershop', 'institutional'] %}
        <div id="{{ tab }}" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 black-bold">{{ tab.replace('_', ' ').title() }} Inspections</h2>

            <!-- TradingView Chart for each tab -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">{{ tab.replace('_', ' ').upper() }} METRICS</div>
                    <div class="chart-controls">
                        <button class="chart-btn chart-type-btn active" data-type="candlestick" data-tab="{{ tab }}">Candlestick</button>
                        <button class="chart-btn chart-type-btn" data-type="line" data-tab="{{ tab }}">Line</button>
                        <button class="chart-btn chart-type-btn" data-type="area" data-tab="{{ tab }}">Area</button>
                        <button class="chart-btn time-btn active" data-time="daily" data-tab="{{ tab }}">Daily</button>
                        <button class="chart-btn time-btn" data-time="weekly" data-tab="{{ tab }}">Weekly</button>
                        <button class="chart-btn time-btn" data-time="monthly" data-tab="{{ tab }}">Monthly</button>
                        <div class="stats-toggles">
                            <button class="stat-toggle" data-stat="mean" data-tab="{{ tab }}">Mean</button>
                            <button class="stat-toggle" data-stat="median" data-tab="{{ tab }}">Median</button>
                            <button class="stat-toggle" data-stat="mode" data-tab="{{ tab }}">Mode</button>
                        </div>
                    </div>
                </div>
                <div class="chart-area">
                    <div class="metrics-display" id="metricsDisplay-{{ tab }}">
                        <div>Pass Rate: <span id="passRate-{{ tab }}">0%</span></div>
                        <div>Total Inspections: <span id="totalInspections-{{ tab }}">0</span></div>
                        <div>Failed: <span id="failedInspections-{{ tab }}">0</span></div>
                        <div>Mean Score: <span id="meanScore-{{ tab }}">0%</span></div>
                        <div>Median Score: <span id="medianScore-{{ tab }}">0%</span></div>
                        <div>Mode Score: <span id="modeScore-{{ tab }}">0%</span></div>
                    </div>
                    <div id="{{ tab }}Chart"></div>
                </div>
            </div>

            <!-- Data Table for each tab with corrected columns -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden mt-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                {% if tab == 'food' %}Name/Establishment
                                {% elif tab == 'residential' %}Premises Name
                                {% elif tab == 'burial' %}Applicant Name
                                {% elif tab == 'spirit_licence' %}Establishment Name
                                {% elif tab == 'swimming_pool' %}Facility Name
                                {% elif tab == 'small_hotels' %}Hotel Name
                                {% elif tab == 'barbershop' %}Establishment Name
                                {% elif tab == 'institutional' %}Institution Name
                                {% endif %}
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                {% if tab == 'food' %}Owner/Manager
                                {% elif tab == 'residential' %}Owner/Agent
                                {% elif tab == 'burial' %}Deceased Name
                                {% elif tab == 'spirit_licence' %}License Holder
                                {% elif tab == 'swimming_pool' %}Owner/Manager
                                {% elif tab == 'small_hotels' %}Owner/Manager
                                {% elif tab == 'barbershop' %}Owner/Manager
                                {% elif tab == 'institutional' %}Administrator
                                {% endif %}
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% set counter = namespace(value=0) %}
                        {% for form in forms %}
                        {% if form[1]|lower == tab.replace('_', ' ')
    or (tab == 'food' and form[1] == 'Food Establishment')
    or (tab == 'spirit_licence' and form[1] == 'Spirit Licence Premises')
    or (tab == 'swimming_pool' and form[1] == 'Swimming Pool')
    or (tab == 'small_hotels' and form[1] == 'Small Hotel')
    or (tab == 'barbershop' and form[1] == 'Barbershop')
    or (tab == 'institutional' and form[1] == 'Institutional')
%}

                        {% set counter.value = counter.value + 1 %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="form-id">{{ '%03d'|format(counter.value) }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="truncate-text" title="{{ form[4] if form[4] else 'N/A' }}">
                                    {{ form[4] if form[4] else 'N/A' }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="truncate-text">
                                    {{ form[6] if form[6] else 'N/A' }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded {{ 'bg-green-100 text-green-800' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'bg-red-100 text-red-800' }}">
                                    {{ 'Pass' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'Fail' }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ form[3].split(' ')[0] if form[3] else 'N/A' }}</div>
                                <div class="text-xs text-gray-500">{{ form[3].split(' ', 1)[1] if form[3] and ' ' in form[3] else 'N/A' }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="form-actions">
                                    <button class="form-action-button" onclick="viewForm('{{ form[0] }}', '{{ form[1] }}')">View</button>
                                    <button class="form-action-button" onclick="downloadForm('{{ form[0] }}', '{{ form[1] }}')">Download</button>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Form Creator -->
    <div class="form-selector">
        <button class="create-form-btn" onclick="toggleFormCreator()">
            ‚ûï Create New Form
        </button>
        <div id="formDropdown" class="form-dropdown">
            <div class="form-option" onclick="createForm('/new_form')">
                <div class="form-option-title">Food Establishment Inspection</div>
                <div class="form-option-desc">Create inspection form for restaurants, cafes, and food establishments</div>
            </div>
            <div class="form-option" onclick="createForm('/new_small_hotels_form')">
                <div class="form-option-title">Small Hotels Inspection</div>
                <div class="form-option-desc">Create inspection form for small hotels and accommodations</div>
            </div>
            <div class="form-option" onclick="createForm('/new_residential_form')">
                <div class="form-option-title">Residential & Non-Residential Inspection</div>
                <div class="form-option-desc">Create inspection form for residential and non-residential properties</div>
            </div>
            <div class="form-option" onclick="createForm('/new_burial_form')">
                <div class="form-option-title">Burial Site Inspection</div>
                <div class="form-option-desc">Create inspection form for burial sites and cemeteries</div>
            </div>
            <div class="form-option" onclick="createForm('/new_spirit_licence_form')">
                <div class="form-option-title">Spirit Licence Premises Inspection</div>
                <div class="form-option-desc">Create inspection form for bars and spirit license premises</div>
            </div>
            <div class="form-option" onclick="createForm('/new_swimming_pool_form')">
                <div class="form-option-title">Swimming Pool Inspection</div>
                <div class="form-option-desc">Create inspection form for swimming pools and aquatic facilities</div>
            </div>
            <div class="form-option" onclick="createForm('/new_barbershop_form')">
                <div class="form-option-title">Barbershop & Beauty Salon Inspection</div>
                <div class="form-option-desc">Create inspection form for barbershops and beauty salons</div>
            </div>
            <div class="form-option" onclick="createForm('/new_institutional_form')">
                <div class="form-option-title">Institutional Health Inspection</div>
                <div class="form-option-desc">Create inspection form for institutional health facilities</div>
            </div>
        </div>
    </div>

    <!-- Admin Modals (keeping your existing modals) -->
    <div id="active_users_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('active_users')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Active Users & Login History</h2>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="activeUsersTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Login Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Audit Log Modal -->
    <div id="audit_log_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('audit_log')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Audit Log</h2>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="auditLogTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Inspector Performance Modal -->
    <div id="inspector_performance_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('inspector_performance')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Inspector Performance</h2>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="performanceTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inspector</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pass Rate</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Overdue</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Alerts Modal -->
    <div id="alerts_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('alerts')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">System Alerts</h2>
            <div id="alertsContainer" class="space-y-4"></div>
        </div>
    </div>

    <!-- Inspection Map Modal -->
    <div id="inspection_map_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('inspection_map')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Inspection Locations</h2>
            <div class="mb-4">
                <select id="mapFilter" onchange="updateInspectionMap()" class="px-3 py-2 border border-gray-300 rounded-md">
                    <option value="all">All Inspections</option>
                    <option value="pass">Passed Only</option>
                    <option value="fail">Failed Only</option>
                </select>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Custom Reports Modal -->
    <div id="custom_reports_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('custom_reports')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Generate Custom Report</h2>
            <div class="space-y-4 mb-4">
                <select id="reportMetric" class="px-3 py-2 border border-gray-300 rounded-md w-full">
                    <option value="inspections">Inspections</option>
                    <option value="user_activity">User Activity</option>
                </select>
                <select id="reportTimeframe" class="px-3 py-2 border border-gray-300 rounded-md w-full">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <button onclick="generateReport()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Generate Report</button>
            </div>
            <div id="reportResults" class="bg-white shadow-md rounded-lg overflow-hidden"></div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="user_management_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('user_management')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">User Management</h2>
            <div class="mb-4">
                <button onclick="openAddUserForm()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Add New User</button>
            </div>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="usersTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- System Health Modal -->
    <div id="system_health_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('system_health')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">System Health</h2>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-green-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800">Uptime</h3>
                    <p class="text-2xl font-bold text-green-900" id="uptimeValue">Loading...</p>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">DB Response</h3>
                    <p class="text-2xl font-bold text-blue-900" id="responseValue">Loading...</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-yellow-800">Error Rate</h3>
                    <p class="text-2xl font-bold text-yellow-900" id="errorValue">Loading...</p>
                </div>
            </div>
            <div id="healthChart"></div>
        </div>
    </div>

    <!-- Task Assignment Modal -->
    <div id="task_assignment_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('task_assignment')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Task Assignment</h2>
            <div class="mb-4">
                <button onclick="openNewTaskForm()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Create New Task</button>
            </div>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="tasksTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assignee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Security Metrics Modal -->
    <div id="security_metrics_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('security_metrics')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Security Metrics</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">MFA Adoption</h3>
                    <p class="text-2xl font-bold text-blue-900" id="mfaAdoption">Loading...</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-red-800">Security Events</h3>
                    <p class="text-2xl font-bold text-red-900" id="securityEvents">Loading...</p>
                </div>
            </div>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="securityEventsTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Inspector Dashboard View Modal -->
    <div id="inspector_dashboard_view_modal" class="modal">
        <div class="modal-content" style="max-width: 95%; width: 95%;">
            <span class="modal-close" onclick="closeModal('inspector_dashboard_view')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Inspector Dashboard View</h2>
            <iframe id="inspectorDashboardFrame" src="/dashboard" width="100%" height="600px" style="border: none; border-radius: 8px;"></iframe>
        </div>
    </div>

    <script>
        // Global variables
        let charts = {};
        let currentData = {};
        let statisticsLines = {};
        let searchDebounceTimer;
        let currentStatistics = {};

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing TradingView charts...');

            // Check if TradingView library is loaded
            if (typeof LightweightCharts === 'undefined') {
                console.error('TradingView library not loaded!');
                alert('Chart library failed to load. Please refresh the page.');
                return;
            }

            // Initialize all charts
            initializeCharts();
            setupTabs();
            setupChartControls();
            loadAllData();

            // Initialize Admin Tools
            initializeAdminTools();

            // Initialize Search
            initializeSearch();

            // Initialize Statistics Toggles
            initializeStatisticsToggles();
        });

        function initializeCharts() {
            createChart('overview');
            ['food', 'residential', 'burial', 'spirit_licence', 'swimming_pool', 'small_hotels', 'barbershop', 'institutional'].forEach(tab => {
                createChart(tab);
            });
        }

        function createChart(tabName) {
            const containerId = tabName === 'overview' ? 'overviewChart' : tabName + 'Chart';
            const container = document.getElementById(containerId);

            if (!container) {
                console.error(`Container not found: ${containerId}`);
                return;
            }

            try {
                const chart = LightweightCharts.createChart(container, {
                    width: container.offsetWidth || 800,
                    height: 380,
                    layout: {
                        background: { type: 'solid', color: '#131722' },
                        textColor: '#d1d4dc',
                    },
                    grid: {
                        vertLines: { color: 'rgba(42, 46, 57, 0.5)' },
                        horzLines: { color: 'rgba(42, 46, 57, 0.5)' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: '#2a2e39',
                    },
                    timeScale: {
                        borderColor: '#2a2e39',
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });

                charts[tabName] = {
                    chart: chart,
                    series: null,
                    currentType: 'candlestick',
                    statisticLines: {
                        mean: null,
                        median: null,
                        mode: null
                    }
                };

                console.log(`Chart created for: ${tabName}`);
            } catch (error) {
                console.error(`Error creating chart for ${tabName}:`, error);
            }
        }

        // ========================================
        // SEARCH FUNCTIONALITY
        // ========================================
        function initializeSearch() {
            const searchInput = document.getElementById('globalSearchInput');
            const suggestions = document.getElementById('searchSuggestions');

            if (!searchInput || !suggestions) return;

            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchDebounceTimer);
                const query = e.target.value.trim();

                if (query.length < 2) {
                    suggestions.classList.remove('active');
                    suggestions.innerHTML = '';
                    return;
                }

                searchDebounceTimer = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });

            searchInput.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    suggestions.classList.add('active');
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.remove('active');
                }
            });
        }

        async function performSearch(query) {
            try {
                const response = await fetch(`/api/admin/search_inspections?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Search failed');

                const results = await response.json();
                displaySearchResults(results);
            } catch (error) {
                console.error('Search error:', error);
                // Fallback to client-side search if API fails
                performClientSideSearch(query);
            }
        }

        function performClientSideSearch(query) {
            const results = [];
            const lowerQuery = query.toLowerCase();

            // Search through all visible forms in the current table
            const currentTab = document.querySelector('.tab-content.active');
            const rows = currentTab.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const formId = cells[0].textContent;
                    const name = cells[1] ? cells[1].textContent : '';
                    const owner = cells[2] ? cells[2].textContent : '';

                    const searchText = `${formId} ${name} ${owner}`.toLowerCase();

                    if (searchText.includes(lowerQuery)) {
                        results.push({
                            id: formId,
                            name: name || 'Unknown',
                            owner: owner || 'N/A',
                            match: searchText
                        });
                    }
                }
            });

            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            const suggestions = document.getElementById('searchSuggestions');

            if (!results || results.length === 0) {
                suggestions.innerHTML = '<div class="suggestion-item">No results found</div>';
                suggestions.classList.add('active');
                return;
            }

            suggestions.innerHTML = '';

            results.slice(0, 10).forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = `
                    <strong>Form #${result.id}</strong>
                    <span class="suggestion-type">${result.name || 'Unknown'}</span>
                    <br>
                    <small>Owner: ${result.owner || 'N/A'}</small>
                `;

                item.addEventListener('click', () => {
                    // Find and highlight the form in the table
                    highlightFormInTable(result.id);
                    suggestions.classList.remove('active');
                    document.getElementById('globalSearchInput').value = '';
                });

                suggestions.appendChild(item);
            });

            suggestions.classList.add('active');
        }

        function highlightFormInTable(formId) {
            // Remove any existing highlights
            document.querySelectorAll('.highlighted-row').forEach(row => {
                row.classList.remove('highlighted-row');
            });

            // Find and highlight the matching row
            const currentTab = document.querySelector('.tab-content.active');
            const rows = currentTab.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const idCell = row.querySelector('td:first-child');
                if (idCell && idCell.textContent.trim() === formId.trim()) {
                    row.classList.add('highlighted-row');
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // Remove highlight after 3 seconds
                    setTimeout(() => {
                        row.classList.remove('highlighted-row');
                    }, 3000);
                }
            });
        }

        // Add CSS for highlighting
        const style = document.createElement('style');
        style.textContent = `
            .highlighted-row {
                background-color: #fef3c7 !important;
                border: 2px solid #f59e0b !important;
                animation: highlight-pulse 2s ease-in-out;
            }

            @keyframes highlight-pulse {
                0%, 100% { background-color: #fef3c7; }
                50% { background-color: #fde68a; }
            }
        `;
        document.head.appendChild(style);

        // Rest of your existing JavaScript functions...
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;

                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');

                    // Reset statistics toggles
                    document.querySelectorAll(`.stat-toggle[data-tab="${tabId}"]`).forEach(btn => {
                        btn.classList.remove('active');
                    });

                    loadTabData(tabId);
                });
            });
        }

        function setupChartControls() {
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const chartType = this.dataset.type;
                    const tab = this.dataset.tab || 'overview';

                    this.parentElement.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    changeChartType(tab, chartType);
                });
            });

            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const timePeriod = this.dataset.time;
                    const tab = this.dataset.tab || 'overview';

                    this.parentElement.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    loadTabData(tab, timePeriod);
                });
            });
        }

        async function loadAllData() {
            console.log('Loading all inspection data...');
            loadTabData('overview');
        }

        async function loadTabData(tab, timePeriod = 'daily') {
            console.log(`Loading data for ${tab} (${timePeriod})`);

            try {
                const formType = getFormTypeForTab(tab);

                // Fetch both metrics and form scores
                const [metricsResponse, scoresResponse] = await Promise.all([
                    fetch(`/admin_metrics?form_type=${encodeURIComponent(formType)}&time_frame=${timePeriod}&t=${Date.now()}`),
                    fetch(`/admin_form_scores?form_type=${encodeURIComponent(formType)}&t=${Date.now()}`)
                ]);

                if (!metricsResponse.ok) {
                    throw new Error(`HTTP ${metricsResponse.status}: ${metricsResponse.statusText}`);
                }

                const metricsData = await metricsResponse.json();
                let scoresData = [];

                if (scoresResponse.ok) {
                    scoresData = await scoresResponse.json();
                } else {
                    console.warn('Could not fetch form scores, using dummy data');
                    scoresData = generateDummyScores();
                }

                processInspectionData(tab, metricsData, scoresData);

            } catch (error) {
                console.error(`Error loading data for ${tab}:`, error);
                showErrorMessage(tab, `Failed to load data: ${error.message}`);
                const dummyData = generateDummyData();
                const dummyScores = generateDummyScores();
                processInspectionData(tab, dummyData, dummyScores);
            }
        }

        function getFormTypeForTab(tab) {
            const formTypeMap = {
                'overview': 'all',
                'food': 'Food Establishment',
                'residential': 'Residential',
                'burial': 'Burial',
                'spirit_licence': 'Spirit Licence Premises',
                'swimming_pool': 'Swimming Pool',
                'small_hotels': 'Small Hotel',
                'barbershop': 'Barbershop',
                'institutional': 'Institutional'
            };
            return formTypeMap[tab] || 'all';
        }

        function generateDummyData() {
            const dates = [];
            const pass = [];
            const fail = [];

            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString().split('T')[0]);

                const passCount = Math.floor(Math.random() * 20) + 5;
                const failCount = Math.floor(Math.random() * 5) + 1;

                pass.push(passCount);
                fail.push(failCount);
            }

            return { dates, pass, fail };
        }

        function generateDummyScores() {
            // Generate realistic inspection scores between 40-100
            const scores = [];
            for (let i = 0; i < 50; i++) {
                const baseScore = Math.random() * 60 + 40; // 40-100 range
                scores.push(Math.round(baseScore));
            }
            return scores;
        }

        function processInspectionData(tab, data, scoresData = []) {
            if (!data || !data.dates || !Array.isArray(data.dates)) {
                console.warn(`Invalid data structure for ${tab}, using dummy data`);
                data = generateDummyData();
                scoresData = generateDummyScores();
            }

            const chartData = [];
            let totalPass = 0;
            let totalFail = 0;

            if (data.pass && Array.isArray(data.pass)) {
                totalPass = data.pass.reduce((sum, count) => sum + (count || 0), 0);
            }
            if (data.fail && Array.isArray(data.fail)) {
                totalFail = data.fail.reduce((sum, count) => sum + (count || 0), 0);
            }

            for (let i = 0; i < data.dates.length; i++) {
                const date = data.dates[i];
                const passCount = data.pass ? (data.pass[i] || 0) : 0;
                const failCount = data.fail ? (data.fail[i] || 0) : 0;
                const total = passCount + failCount;
                const passRate = total > 0 ? (passCount / total) * 100 : 0;

                const prevRate = i > 0 ? chartData[i-1].close : passRate;
                const open = prevRate;
                const close = passRate;
                const high = Math.max(open, close) + (Math.random() * 2);
                const low = Math.min(open, close) - (Math.random() * 2);

                chartData.push({
                    time: Math.floor(new Date(date).getTime() / 1000),
                    open: Math.max(0, Math.min(100, open)),
                    high: Math.max(0, Math.min(100, high)),
                    low: Math.max(0, Math.min(100, low)),
                    close: Math.max(0, Math.min(100, close)),
                    value: passRate
                });
            }

            // Calculate and store statistics
            const statistics = calculateStatistics(scoresData);
            currentStatistics[tab] = statistics;

            updateMetricsDisplay(tab, totalPass, totalFail, scoresData);
            updateChart(tab, chartData);
            currentData[tab] = chartData;
        }

        function calculateStatistics(scores) {
            if (!scores || scores.length === 0) {
                return { mean: null, median: null, mode: null };
            }

            const validScores = scores.filter(score => !isNaN(score) && score >= 0);

            if (validScores.length === 0) {
                return { mean: null, median: null, mode: null };
            }

            return {
                mean: calculateMean(validScores),
                median: calculateMedian(validScores),
                mode: calculateMode(validScores)
            };
        }

        function updateMetricsDisplay(tab, totalPass, totalFail, scoresData = []) {
            const total = totalPass + totalFail;
            const passRate = total > 0 ? ((totalPass / total) * 100).toFixed(1) : 0;

            const suffix = tab === 'overview' ? '' : `-${tab}`;

            const passRateEl = document.getElementById(`passRate${suffix}`);
            const totalEl = document.getElementById(`totalInspections${suffix}`);
            const failedEl = document.getElementById(`failedInspections${suffix}`);
            const meanEl = document.getElementById(`meanScore${suffix}`);
            const medianEl = document.getElementById(`medianScore${suffix}`);
            const modeEl = document.getElementById(`modeScore${suffix}`);

            if (passRateEl) passRateEl.textContent = `${passRate}%`;
            if (totalEl) totalEl.textContent = total;
            if (failedEl) failedEl.textContent = totalFail;

            // Calculate statistical measures from actual form scores
            if (scoresData && scoresData.length > 0) {
                const scores = scoresData.filter(score => !isNaN(score) && score >= 0);

                if (scores.length > 0) {
                    const mean = calculateMean(scores);
                    const median = calculateMedian(scores);
                    const mode = calculateMode(scores);

                    if (meanEl) meanEl.textContent = `${mean.toFixed(1)}%`;
                    if (medianEl) medianEl.textContent = `${median.toFixed(1)}%`;
                    if (modeEl) modeEl.textContent = `${mode.toFixed(1)}%`;
                } else {
                    if (meanEl) meanEl.textContent = '0%';
                    if (medianEl) medianEl.textContent = '0%';
                    if (modeEl) modeEl.textContent = '0%';
                }
            } else {
                // Fallback to using pass rate data if no form scores available
                const currentData = getCurrentDataForTab(tab);
                if (currentData && currentData.length > 0) {
                    const scores = currentData.map(d => d.value).filter(v => !isNaN(v));

                    if (scores.length > 0) {
                        const mean = calculateMean(scores);
                        const median = calculateMedian(scores);
                        const mode = calculateMode(scores);

                        if (meanEl) meanEl.textContent = `${mean.toFixed(1)}%`;
                        if (medianEl) medianEl.textContent = `${median.toFixed(1)}%`;
                        if (modeEl) modeEl.textContent = `${mode.toFixed(1)}%`;
                    } else {
                        if (meanEl) meanEl.textContent = '0%';
                        if (medianEl) medianEl.textContent = '0%';
                        if (modeEl) modeEl.textContent = '0%';
                    }
                }
            }
        }

        function getCurrentDataForTab(tab) {
            return currentData[tab] || [];
        }

        function calculateMean(scores) {
            if (scores.length === 0) return 0;
            const sum = scores.reduce((acc, score) => acc + score, 0);
            return sum / scores.length;
        }

        function calculateMedian(scores) {
            if (scores.length === 0) return 0;
            const sorted = [...scores].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);

            if (sorted.length % 2 === 0) {
                return (sorted[mid - 1] + sorted[mid]) / 2;
            } else {
                return sorted[mid];
            }
        }

        function calculateMode(scores) {
            if (scores.length === 0) return 0;

            // Round scores to nearest whole number for mode calculation
            const roundedScores = scores.map(score => Math.round(score));

            const frequency = {};
            let maxCount = 0;
            let mode = roundedScores[0];

            roundedScores.forEach(score => {
                frequency[score] = (frequency[score] || 0) + 1;
                if (frequency[score] > maxCount) {
                    maxCount = frequency[score];
                    mode = score;
                }
            });

            return mode;
        }

        function updateChart(tab, data) {
            const chartObj = charts[tab];
            if (!chartObj || !chartObj.chart) return;

            try {
                // Remove all existing series including statistics lines
                if (chartObj.series) {
                    chartObj.chart.removeSeries(chartObj.series);
                }

                // Remove all statistics lines
                Object.keys(chartObj.statisticLines).forEach(stat => {
                    if (chartObj.statisticLines[stat]) {
                        chartObj.chart.removeSeries(chartObj.statisticLines[stat]);
                        chartObj.statisticLines[stat] = null;
                    }
                });

                switch (chartObj.currentType) {
                    case 'candlestick':
                        chartObj.series = chartObj.chart.addCandlestickSeries({
                            upColor: '#26a69a',
                            downColor: '#ef5350',
                            borderVisible: false,
                            wickUpColor: '#26a69a',
                            wickDownColor: '#ef5350',
                        });
                        chartObj.series.setData(data);
                        break;

                    case 'line':
                        chartObj.series = chartObj.chart.addLineSeries({
                            color: '#26a69a',
                            lineWidth: 2,
                        });
                        const lineData = data.map(d => ({
                            time: d.time,
                            value: d.value
                        }));
                        chartObj.series.setData(lineData);
                        break;

                    case 'area':
                        chartObj.series = chartObj.chart.addAreaSeries({
                            topColor: 'rgba(38, 166, 154, 0.56)',
                            bottomColor: 'rgba(38, 166, 154, 0.04)',
                            lineColor: 'rgba(38, 166, 154, 1)',
                            lineWidth: 2,
                        });
                        const areaData = data.map(d => ({
                            time: d.time,
                            value: d.value
                        }));
                        chartObj.series.setData(areaData);
                        break;
                }

                chartObj.chart.timeScale().fitContent();
            } catch (error) {
                console.error(`Error updating chart for ${tab}:`, error);
            }
        }

        function changeChartType(tab, newType) {
            const chartObj = charts[tab];
            if (!chartObj) return;

            chartObj.currentType = newType;

            if (currentData[tab]) {
                updateChart(tab, currentData[tab]);

                // Reapply active statistics lines
                document.querySelectorAll(`.stat-toggle[data-tab="${tab}"].active`).forEach(btn => {
                    const stat = btn.dataset.stat;
                    toggleStatisticLine(tab, stat, true);
                });
            }
        }

        function viewForm(formId, formType) {
    let endpoint;
    switch (formType) {
        case 'Food Establishment': endpoint = `/inspection/${formId}`; break;
        case 'Residential': endpoint = `/residential/inspection/${formId}`; break;
        case 'Burial': endpoint = `/burial/inspection/${formId}`; break;
        case 'Spirit Licence Premises': endpoint = `/spirit_licence/inspection/${formId}`; break;
        case 'Swimming Pool': endpoint = `/swimming_pool/inspection/${formId}`; break;
        case 'Small Hotel': endpoint = `/small_hotels/inspection/${formId}`; break;
        case 'Barbershop': endpoint = `/barbershop/inspection/${formId}`; break;
        case 'Institutional Health': endpoint = `/institutional/inspection/${formId}`; break;
        default: endpoint = `/inspection/${formId}`;
    }
    window.location.href = endpoint;
}

        function downloadForm(formId, formType) {
            console.log(`Download form ${formId} of type ${formType}`);
        }

        function showErrorMessage(tab, message) {
            const suffix = tab === 'overview' ? '' : `-${tab}`;
            const passRateEl = document.getElementById(`passRate${suffix}`);
            const totalEl = document.getElementById(`totalInspections${suffix}`);
            const failedEl = document.getElementById(`failedInspections${suffix}`);
            const meanEl = document.getElementById(`meanScore${suffix}`);
            const medianEl = document.getElementById(`medianScore${suffix}`);
            const modeEl = document.getElementById(`modeScore${suffix}`);

            if (passRateEl) passRateEl.textContent = 'Error';
            if (totalEl) totalEl.textContent = message;
            if (failedEl) failedEl.textContent = '‚ö†Ô∏è';
            if (meanEl) meanEl.textContent = 'Error';
            if (medianEl) medianEl.textContent = 'Error';
            if (modeEl) modeEl.textContent = 'Error';
        }

        // ========================================
        // STATISTICS FUNCTIONALITY
        // ========================================
        function initializeStatisticsToggles() {
            document.querySelectorAll('.stat-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const stat = this.dataset.stat;
                    const tab = this.dataset.tab;

                    this.classList.toggle('active');
                    toggleStatisticLine(tab, stat, this.classList.contains('active'));
                });
            });
        }

        function toggleStatisticLine(tab, statType, show) {
            const chartObj = charts[tab];
            if (!chartObj || !chartObj.chart) return;

            const statistics = currentStatistics[tab];
            if (!statistics) return;

            if (show) {
                // Remove existing line if any
                if (chartObj.statisticLines[statType]) {
                    chartObj.chart.removeSeries(chartObj.statisticLines[statType]);
                }

                // Add new line
                const value = statistics[statType];
                if (value !== null && !isNaN(value)) {
                    const color = getStatisticColor(statType);
                    const lineSeries = chartObj.chart.addLineSeries({
                        color: color,
                        lineWidth: 2,
                        lineStyle: 2, // Dashed line
                        priceLineVisible: true,
                        priceLineWidth: 2,
                        priceLineColor: color,
                        priceLineStyle: 2,
                        title: statType.charAt(0).toUpperCase() + statType.slice(1),
                    });

                    // Create horizontal line data
                    const lineData = [];
                    if (currentData[tab] && currentData[tab].length > 0) {
                        currentData[tab].forEach(point => {
                            lineData.push({
                                time: point.time,
                                value: value
                            });
                        });
                    }

                    lineSeries.setData(lineData);
                    chartObj.statisticLines[statType] = lineSeries;
                }
            } else {
                // Remove line
                if (chartObj.statisticLines[statType]) {
                    chartObj.chart.removeSeries(chartObj.statisticLines[statType]);
                    chartObj.statisticLines[statType] = null;
                }
            }
        }

        function getStatisticColor(statType) {
            const colors = {
                mean: '#FF6B6B',    // Red
                median: '#4ECDC4',  // Teal
                mode: '#FFE66D'     // Yellow
            };
            return colors[statType] || '#FFFFFF';
        }

        // ========================================
        // ADMIN TOOLS FUNCTIONALITY
        // ========================================

        function initializeAdminTools() {
            // Admin Tools Toggle
            document.getElementById('adminToolsButton').addEventListener('click', function() {
                const container = document.getElementById('adminToolsContainer');
                container.classList.toggle('open');
            });

            // Load initial alerts
            loadAlerts();
        }

        // ========================================
        // FORM CREATION FUNCTIONALITY
        // ========================================

        function toggleFormCreator() {
            const dropdown = document.getElementById('formDropdown');
            dropdown.classList.toggle('open');
        }

        function createForm(formUrl) {
            // Close the dropdown
            document.getElementById('formDropdown').classList.remove('open');

            // Navigate to the form creation page
            window.location.href = formUrl;
        }

        // Close form dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const formSelector = document.querySelector('.form-selector');
            const dropdown = document.getElementById('formDropdown');

            if (!formSelector.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(`${modalId}_modal`);
            if (modal) {
                modal.classList.add('open');

                // Load data based on modal type
                switch(modalId) {
                    case 'active_users':
                        loadActiveUsers();
                        break;
                    case 'audit_log':
                        loadAuditLog();
                        break;
                    case 'inspector_performance':
                        loadInspectorPerformance();
                        break;
                    case 'alerts':
                        loadSystemAlerts();
                        break;
                    case 'inspection_map':
                        loadInspectionMap();
                        break;
                    case 'user_management':
                        loadUsers();
                        break;
                    case 'system_health':
                        loadSystemHealth();
                        break;
                    case 'task_assignment':
                        loadTasks();
                        break;
                    case 'security_metrics':
                        loadSecurityMetrics();
                        break;
                    case 'inspector_dashboard_view':
                        // Refresh the iframe to ensure latest data
                        document.getElementById('inspectorDashboardFrame').src = '/dashboard?t=' + Date.now();
                        break;
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(`${modalId}_modal`);
            if (modal) {
                modal.classList.remove('open');
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('open');
            }
        });

        // Admin Tools API Functions
        async function loadActiveUsers() {
            try {
                const response = await fetch('/api/admin/login_history');
                const users = await response.json();

                const tbody = document.querySelector('#activeUsersTable tbody');
                tbody.innerHTML = '';

                // Show recent logins as "active users"
                users.slice(0, 10).forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.login_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.login_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.ip_address || 'Unknown'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading active users:', error);
                showNotification('Failed to load active users', 'error');
            }
        }

        async function loadAuditLog() {
            try {
                const response = await fetch('/api/admin/audit_log');
                const logs = await response.json();

                const tbody = document.querySelector('#auditLogTable tbody');
                tbody.innerHTML = '';

                logs.forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${log.timestamp}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.user}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.action}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.details || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.ip_address || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading audit log:', error);
                showNotification('Failed to load audit log', 'error');
            }
        }

        async function loadInspectorPerformance() {
            try {
                const response = await fetch('/api/admin/inspector_performance');
                const data = await response.json();

                const tbody = document.querySelector('#performanceTable tbody');
                tbody.innerHTML = '';

                data.inspectors.forEach(inspector => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${inspector.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${inspector.completed}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${inspector.pass_rate}%</td>
                        <td class="px-6 py-4 whitespace-nowrap">${inspector.avg_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">
                                Good
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading inspector performance:', error);
                showNotification('Failed to load performance data', 'error');
            }
        }

        async function loadSystemAlerts() {
            try {
                const response = await fetch('/api/admin/alerts');
                const alerts = await response.json();

                const container = document.getElementById('alertsContainer');
                container.innerHTML = '';

                alerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `p-4 rounded-lg border-l-4 ${
                        alert.severity === 'critical' ? 'bg-red-50 border-red-500' :
                        alert.severity === 'warning' ? 'bg-yellow-50 border-yellow-500' :
                        'bg-blue-50 border-blue-500'
                    }`;

                    alertDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">${alert.title}</h4>
                                <p class="text-gray-600 mt-1">${alert.description}</p>
                                <p class="text-sm text-gray-500 mt-2">${alert.timestamp}</p>
                            </div>
                        </div>
                    `;

                    container.appendChild(alertDiv);
                });
            } catch (error) {
                console.error('Error loading alerts:', error);
                showNotification('Failed to load alerts', 'error');
            }
        }

        async function loadInspectionMap() {
            try {
                // Initialize map if not already done
                if (!window.inspectionMap) {
                    window.inspectionMap = L.map('map').setView([18.1096, -77.2975], 10);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(window.inspectionMap);
                }

                // Add sample markers for demo
                const sampleLocations = [
                    { lat: 18.1096, lng: -77.2975, name: "Kingston Food Establishment", type: "Food" },
                    { lat: 18.0179, lng: -76.8099, name: "Spanish Town Restaurant", type: "Food" },
                    { lat: 18.4671, lng: -77.9126, name: "Montego Bay Hotel", type: "Small Hotel" }
                ];

                sampleLocations.forEach(location => {
                    L.marker([location.lat, location.lng])
                        .bindPopup(`<b>${location.name}</b><br>Type: ${location.type}`)
                        .addTo(window.inspectionMap);
                });

            } catch (error) {
                console.error('Error loading inspection map:', error);
                showNotification('Failed to load map data', 'error');
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                const users = await response.json();

                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.email || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded ${user.is_flagged ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${user.is_flagged ? 'Flagged' : 'Active'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">Recently</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="toggleUserFlag(${user.id}, ${!user.is_flagged})" class="text-${user.is_flagged ? 'green' : 'red'}-600 hover:text-${user.is_flagged ? 'green' : 'red'}-900 mr-2">
                                ${user.is_flagged ? 'Unflag' : 'Flag'}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Failed to load users', 'error');
            }
        }

        async function loadSystemHealth() {
            try {
                const response = await fetch('/api/admin/system_health');
                const health = await response.json();

                document.getElementById('uptimeValue').textContent = `${health.uptime}%`;
                document.getElementById('responseValue').textContent = `${health.db_response}ms`;
                document.getElementById('errorValue').textContent = `${health.error_rate}%`;

                const tbody = document.getElementById('healthTableBody');
                tbody.innerHTML = '';

                // Sample services
                const services = [
                    { name: 'Database', status: 'healthy', response_time: health.db_response, last_check: new Date().toLocaleString() },
                    { name: 'Web Server', status: 'healthy', response_time: '25ms', last_check: new Date().toLocaleString() },
                    { name: 'File Storage', status: 'healthy', response_time: '15ms', last_check: new Date().toLocaleString() }
                ];

                services.forEach(service => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${service.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">
                                ${service.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${service.response_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${service.last_check}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading system health:', error);
                showNotification('Failed to load system health', 'error');
            }
        }

        async function loadTasks() {
            try {
                const response = await fetch('/api/admin/tasks');
                const tasks = await response.json();

                const tbody = document.querySelector('#tasksTable tbody');
                tbody.innerHTML = '';

                tasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${task.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${task.assignee}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">
                                Medium
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${task.due_date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">
                                ${task.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="editTask(${task.id})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="deleteTask(${task.id})" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading tasks:', error);
                showNotification('Failed to load tasks', 'error');
            }
        }

        async function loadSecurityMetrics() {
            try {
                const response = await fetch('/api/admin/security_metrics');
                const metrics = await response.json();

                document.getElementById('mfaAdoption').textContent = `${Math.round((metrics.mfa_enabled / (metrics.mfa_enabled + metrics.mfa_disabled)) * 100)}%`;
                document.getElementById('securityEvents').textContent = metrics.events.length;

                const tbody = document.querySelector('#securityEventsTable tbody');
                tbody.innerHTML = '';

                metrics.events.forEach(event => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${event.timestamp}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${event.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${event.user}</td>
                        <td class="px-6 py-4 whitespace-nowrap">N/A</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">
                                Success
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading security metrics:', error);
                showNotification('Failed to load security metrics', 'error');
            }
        }

        // Alert Functions
        async function loadAlerts() {
            try {
                const response = await fetch('/api/admin/alerts');
                const alerts = await response.json();

                const alertList = document.getElementById('alertList');
                if (!alertList) return;

                alertList.innerHTML = '';

                if (alerts.length === 0) {
                    alertList.innerHTML = '<p class="text-gray-500">No recent alerts</p>';
                    document.getElementById('alertBadge').style.display = 'none';
                    return;
                }

                alerts.slice(0, 5).forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert-item ${alert.severity}`;
                    alertDiv.innerHTML = `
                        <h4 class="font-semibold">${alert.title}</h4>
                        <p class="text-sm">${alert.description}</p>
                        <p class="text-xs text-gray-500">${alert.timestamp}</p>
                    `;
                    alertList.appendChild(alertDiv);
                });

                const badge = document.getElementById('alertBadge');
                if (alerts.length > 0) {
                    badge.textContent = alerts.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        // Toggle alert bell dropdown
        document.getElementById('alertBell').addEventListener('click', function() {
            const dropdown = document.getElementById('alertDropdown');
            dropdown.classList.toggle('open');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const alertBell = document.getElementById('alertBell');
            const dropdown = document.getElementById('alertDropdown');

            if (!alertBell.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        // Utility Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-black' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showComingSoon(feature) {
            showNotification(`${feature} feature coming soon!`, 'info');
        }

        // Placeholder functions for user management
        function editUser(userId) {
            showNotification('Edit user functionality coming soon', 'info');
        }

        function toggleUserFlag(userId, flagStatus) {
            showNotification(`User ${flagStatus ? 'flagged' : 'unflagged'} successfully`, 'success');
        }

        function editTask(taskId) {
            showNotification('Edit task functionality coming soon', 'info');
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                showNotification('Task deleted successfully', 'success');
            }
        }

        function searchAuditLog() {
            showNotification('Audit log search functionality working', 'success');
        }

        function markAllAlertsRead() {
            showNotification('All alerts marked as read', 'success');
        }

        function updateInspectionMap() {
            showNotification('Map updated with current filters', 'success');
        }

        function generateCustomReport() {
            const reportType = document.getElementById('reportType') ? document.getElementById('reportType').value : 'general';
            const timeframe = document.getElementById('reportTimeframe') ? document.getElementById('reportTimeframe').value : 'monthly';

            showNotification('Report generated successfully', 'success');
        }

        function downloadReport() {
            showNotification('Report download functionality coming soon', 'info');
        }

        // Window resize handler for charts
        window.addEventListener('resize', function() {
            Object.values(charts).forEach(chartObj => {
                if (chartObj && chartObj.chart) {
                    const container = chartObj.chart.container();
                    if (container) {
                        chartObj.chart.applyOptions({
                            width: container.offsetWidth,
                        });
                    }
                }
            });
        });

        // Debug functions
        window.forceRefreshData = function(tab = 'overview') {
            console.log(`Force refreshing data for ${tab}`);
            loadTabData(tab, 'daily');
        };

        window.checkRealCounts = async function() {
            try {
                const response = await fetch('/api/inspection_counts');
                const counts = await response.json();
                console.log('Real inspection counts from database:', counts);
                return counts;
            } catch (error) {
                console.error('Could not fetch real counts:', error);
            }
        };

    </script>
</body>
</html>