<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Messaging System Styles */
.messaging-toggle {
    position: fixed;
    top: 60px;
    right: 20px;
    z-index: 1000;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.messaging-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
}

.messaging-toggle svg {
    width: 24px;
    height: 24px;
    fill: white;
}

.message-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4757;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.messaging-panel {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 999;
    display: flex;
    flex-direction: column;
}

.messaging-panel.open {
    right: 0;
}

.messaging-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.messaging-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.close-messaging {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.users-list {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.loading-message {
    padding: 20px;
    text-align: center;
    color: #666;
}

.error-message {
    padding: 20px;
    text-align: center;
    color: #e53e3e;
    background: #fed7d7;
    margin: 10px;
    border-radius: 8px;
}

.user-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-item:hover {
    background: #f8f9ff;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 16px;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: #333;
    margin: 0 0 4px 0;
}

.user-role {
    font-size: 12px;
    color: #666;
    text-transform: capitalize;
}

.user-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #10b981;
    margin-left: auto;
}

.unread-count {
    background: #ff4757;
    color: white;
    border-radius: 10px;
    padding: 2px 6px;
    font-size: 11px;
    font-weight: bold;
    margin-left: auto;
}

/* Chat Window Styles */
.chat-window {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 350px;
    height: 450px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    display: none;
    flex-direction: column;
    z-index: 1001;
    border: 1px solid #e5e7eb;
}

.chat-window.open {
    display: flex;
}

.chat-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-user-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.chat-username {
    font-weight: 600;
}

.close-chat {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
}

.chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    background: #f8f9fa;
}

.message {
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
}

.message.sent {
    align-items: flex-end;
}

.message.received {
    align-items: flex-start;
}

.message-bubble {
    max-width: 80%;
    padding: 10px 15px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
}

.message.sent .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 5px;
}

.message.received .message-bubble {
    background: white;
    color: #333;
    border: 1px solid #e5e7eb;
    border-bottom-left-radius: 5px;
}

.message-time {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
}

.chat-input-area {
    padding: 15px;
    background: white;
    border-top: 1px solid #e5e7eb;
    border-radius: 0 0 10px 10px;
}

.chat-input-form {
    display: flex;
    gap: 10px;
}

.chat-input {
    flex: 1;
    padding: 10px 15px;
    border: 1px solid #e5e7eb;
    border-radius: 20px;
    outline: none;
    font-size: 14px;
}

.chat-input:focus {
    border-color: #667eea;
}

.send-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
}

.send-button:hover {
    transform: scale(1.05);
}

.send-button svg {
    width: 16px;
    height: 16px;
    fill: white;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .messaging-panel {
        width: 100%;
        right: -100%;
    }

    .chat-window {
        width: calc(100% - 40px);
        height: 400px;
        bottom: 10px;
        right: 20px;
    }
}
        body {
            font-family: Arial, sans-serif;
            background: url('{{ url_for("static", filename="heart2.jpg") }}') no-repeat center center fixed;
            background-size: cover;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* TradingView Chart Styles */
        .chart-container {
            background: #131722;
            border-radius: 8px;
            height: 500px;
            margin: 20px 0;
            position: relative;
        }

        .chart-header {
            background: #1e222d;
            padding: 15px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            display: none; /* Hide chart title to prevent blocking data */
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .timeframe-group {
            display: flex;
            gap: 5px;
            margin-left: 15px;
            border-left: 1px solid #444;
            padding-left: 15px;
        }

        .chart-btn {
            background: #2a2e39;
            color: #787b86;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .chart-btn:hover {
            background: #363a45;
            color: #d1d4dc;
        }

        .chart-btn.active {
            background: #2962ff;
            color: white;
        }

        .chart-btn.time-btn {
            padding: 6px 12px;
            font-size: 12px;
            min-width: 60px;
        }

        .chart-area {
            height: 420px;
            position: relative;
        }

        .metrics-display {
            display: flex;
            gap: 20px;
            align-items: center;
            color: #d1d4dc;
            font-size: 12px;
            margin-left: 20px;
        }

        .metrics-display > div {
            white-space: nowrap;
        }

        /* Search Bar Styles */
        .search-container {
            position: relative;
            max-width: 500px;
            margin: 0 auto 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f3f4f6;
        }

        .suggestion-item:hover {
            background: #f3f4f6;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-type {
            display: inline-block;
            padding: 2px 8px;
            font-size: 12px;
            background: #e5e7eb;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* Statistics Toggle Buttons */
        .stats-toggles {
            display: flex;
            gap: 8px;
            margin-left: 20px;
        }

        .stat-toggle {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            background: #2a2e39;
            color: #787b86;
            border: none;
            transition: all 0.2s;
        }

        .stat-toggle:hover {
            background: #363a45;
            color: #d1d4dc;
        }

        .stat-toggle.active {
            background: #2962ff;
            color: white;
        }

        /* Threshold Controls */
        .threshold-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 20px;
            padding: 6px 12px;
            background: #1e222d;
            border-radius: 4px;
            border: 1px solid #2a2e39;
        }

        .threshold-input {
            width: 60px;
            padding: 4px 8px;
            background: #2a2e39;
            border: 1px solid #363a45;
            border-radius: 4px;
            color: #d1d4dc;
            font-size: 12px;
            text-align: center;
        }

        .threshold-input:focus {
            outline: none;
            border-color: #2962ff;
        }

        .threshold-toggle {
            padding: 4px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            background: #2a2e39;
            color: #787b86;
            border: none;
            transition: all 0.2s;
        }

        .threshold-toggle:hover {
            background: #363a45;
            color: #d1d4dc;
        }

        .threshold-toggle.active {
            background: #ef5350;
            color: white;
        }

        .threshold-label {
            font-size: 12px;
            color: #787b86;
            white-space: nowrap;
        }

        /* Alert Sidebar Panel */
        .alert-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #1e222d;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 9999;
            display: flex;
            flex-direction: column;
        }

        .alert-sidebar.open {
            right: 0;
        }

        .alert-sidebar-header {
            background: #131722;
            padding: 20px;
            border-bottom: 1px solid #2a2e39;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-sidebar-title {
            font-size: 18px;
            font-weight: bold;
            color: #d1d4dc;
        }

        .alert-sidebar-close {
            background: transparent;
            border: none;
            color: #787b86;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .alert-sidebar-close:hover {
            background: #2a2e39;
            color: #d1d4dc;
        }

        .alert-filters {
            padding: 16px 20px;
            border-bottom: 1px solid #2a2e39;
            background: #131722;
        }

        .alert-filter-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .alert-filter-btn {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            background: #2a2e39;
            color: #787b86;
            border: none;
            transition: all 0.2s;
        }

        .alert-filter-btn:hover {
            background: #363a45;
            color: #d1d4dc;
        }

        .alert-filter-btn.active {
            background: #2962ff;
            color: white;
        }

        .alert-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .alert-card {
            background: #2a2e39;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid #ef5350;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alert-card:hover {
            background: #363a45;
            transform: translateX(-4px);
        }

        .alert-card.acknowledged {
            border-left-color: #4caf50;
            opacity: 0.6;
        }

        .alert-card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .alert-card-title {
            font-weight: bold;
            color: #ef5350;
            font-size: 14px;
        }

        .alert-card.acknowledged .alert-card-title {
            color: #4caf50;
        }

        .alert-card-time {
            font-size: 11px;
            color: #787b86;
        }

        .alert-card-body {
            color: #d1d4dc;
            font-size: 13px;
            line-height: 1.5;
        }

        .alert-card-details {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 12px;
            color: #787b86;
        }

        .alert-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #363a45;
        }

        .alert-action-btn {
            flex: 1;
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .alert-action-btn.acknowledge {
            background: #4caf50;
            color: white;
        }

        .alert-action-btn.acknowledge:hover {
            background: #45a049;
        }

        .alert-action-btn.view {
            background: #2962ff;
            color: white;
        }

        .alert-action-btn.view:hover {
            background: #1e4fd6;
        }

        .alert-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef5350;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        .alert-toggle-btn {
            position: relative;
            background: #2a2e39;
            border: none;
            color: #d1d4dc;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .alert-toggle-btn:hover {
            background: #363a45;
        }

        .alert-toggle-btn.has-alerts {
            animation: glowRed 2s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(239, 83, 80, 0.6);
        }

        @keyframes glowRed {
            0%, 100% {
                box-shadow: 0 0 20px rgba(239, 83, 80, 0.4),
                            0 0 40px rgba(239, 83, 80, 0.2);
            }
            50% {
                box-shadow: 0 0 30px rgba(239, 83, 80, 0.8),
                            0 0 60px rgba(239, 83, 80, 0.4),
                            0 0 80px rgba(239, 83, 80, 0.2);
            }
        }

        .alert-empty {
            text-align: center;
            padding: 40px 20px;
            color: #787b86;
        }

        .alert-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .bulk-actions {
            padding: 12px 20px;
            border-top: 1px solid #2a2e39;
            background: #131722;
            display: flex;
            gap: 8px;
        }

        .bulk-action-btn {
            flex: 1;
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .bulk-action-btn.acknowledge-all {
            background: #4caf50;
            color: white;
        }

        .bulk-action-btn.acknowledge-all:hover {
            background: #45a049;
        }

        .bulk-action-btn.clear-all {
            background: #787b86;
            color: white;
        }

        .bulk-action-btn.clear-all:hover {
            background: #6a6d78;
        }

        /* Admin Tools & Modal Styles */
        .black-bold { color: #000000; font-weight: bold; }
        .blue-bold { color: #0000FF; font-weight: bold; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .form-action-button {
            background-color: #3B82F6;
            color: white;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            border: none;
        }
        .form-action-button:hover { background-color: #2563EB; }

        .alert-dropdown {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: none;
        }
        .alert-dropdown.open { display: block; }

        .alert-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .alert-item.critical {
            background: #ffcccc;
            border: 1px solid #ff0000;
        }
        .alert-item.warning {
            background: #fff4cc;
            border: 1px solid #ff9900;
        }

        .admin-tools-container {
            position: fixed;
            right: 20px;
            top: 120px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 12px;
            z-index: 999;
            display: none;
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(7, 1fr);
            gap: 10px;
            width: 320px;
        }
        .admin-tools-container.open { display: grid; }

        .sidebar-button {
            background-color: #3B82F6;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }
        .sidebar-button:hover { background-color: #2563EB; }
        .sidebar-button:active { transform: scale(0.95); }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1002;
            justify-content: center;
            align-items: center;
        }
        .modal.open { display: flex; }

        .modal-content {
            background: white;
            border-radius: 8px;
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
        }

        #map {
            height: 400px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        /* Table improvements */
        .truncate-text {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .form-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #4338ca;
        }

        /* Form Creation Styles */
        .form-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .create-form-btn {
            background: #10b981;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            border: none;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }

        .create-form-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .form-dropdown {
            position: absolute;
            bottom: 70px;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 300px;
            display: none;
            z-index: 1001;
        }

        .form-dropdown.open {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-option {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .form-option:hover {
            background: #f8fafc;
        }

        .form-option:last-child {
            border-bottom: none;
        }

        .form-option-title {
            font-weight: bold;
            color: #374151;
        }

        .form-option-desc {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <form class="absolute top-4 left-4" method="POST" action="/logout">
            <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
        </form>

        <h1 class="text-3xl font-bold text-center black-bold mb-6">Admin Dashboard</h1>


        <!-- Alert Bell -->
        <div class="absolute top-4 right-4">
            <div class="relative">
                <button id="alertBell" class="bg-gray-200 p-2 rounded-full hover:bg-gray-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#000000" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span id="alertBadge" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs" style="display: none;"></span>
                </button>
                <div id="alertDropdown" class="alert-dropdown">
                    <div id="alertList" class="p-2"></div>
                </div>
            </div>
        </div>

        <button id="messagingToggleBtn" class="messaging-toggle">
    <svg viewBox="0 0 24 24" width="24" height="24" fill="white">
        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z"/>
        <path d="M7 9H17V11H7V9ZM7 12H15V14H7V12Z"/>
    </svg>
    <div id="messageBadge" class="message-badge" style="display: none;">0</div>
</button>

        <button id="alertSidebarToggle" class="alert-toggle-btn" style="position: fixed; bottom: 120px; right: 20px; z-index: 1000;">
            üö® Alerts
            <span id="alertSidebarBadge" class="alert-badge" style="display: none;">0</span>
        </button>

<!-- Messaging Panel -->
<div id="messagingPanel" class="messaging-panel">
    <div class="messaging-header">
        <h3>üí¨ Messages</h3>
        <button class="close-messaging" onclick="toggleMessaging()">√ó</button>
    </div>
    <div class="users-list" id="usersList">
        <!-- Users will be loaded here -->
    </div>
</div>

<!-- Chat Window -->
<div id="chatWindow" class="chat-window">
    <div class="chat-header">
        <div class="chat-user-info">
            <div class="chat-avatar" id="chatAvatar">U</div>
            <div class="chat-username" id="chatUsername">User</div>
        </div>
        <button class="close-chat" onclick="closeChatWindow()">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <!-- Messages will appear here -->
    </div>
    <div class="chat-input-area">
        <form class="chat-input-form" onsubmit="sendMessage(event)">
            <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." required>
            <input type="hidden" id="currentChatUserId">
            <button type="submit" class="send-button">
                <svg viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10L17 12 2 14L2.01 21Z"/>
                </svg>
            </button>
        </form>
    </div>
</div>

        <!-- Global Search Bar -->
        <div class="search-container">
            <input
    type="text"
    id="globalSearchInput"
    placeholder="Search by establishment name, owner, or license holder..."
    class="search-input"
    autocomplete="off"
>
            <div id="searchSuggestions" class="search-suggestions"></div>
        </div>

        <!-- Tabs -->
        <div class="flex justify-center mb-6 items-center">
            <div class="inline-flex rounded-md shadow-sm" role="group" style="flex-wrap: wrap;">
                <button data-tab="overview" class="tab active px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100">Overview</button>
                <button data-tab="food" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Food</button>
                <button data-tab="residential" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Residential</button>
                <button data-tab="burial" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Burial</button>
                <button data-tab="spirit_licence" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Spirit Licence</button>
                <button data-tab="swimming_pool" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Swimming Pool</button>
                <button data-tab="small_hotels" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Small Hotels</button>
                <button data-tab="barbershop" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Barbershop</button>
                <button data-tab="institutional" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Institutional</button>
                <button data-tab="meat_processing" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100">Meat Processing</button>
                <button data-tab="distribution" class="tab px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-lg hover:bg-gray-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üìä Distribution</button>
            </div>
            <button id="adminToolsButton" class="ml-auto px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg hover:bg-gray-100">Admin Tools</button>
        </div>

        <!-- Alert Sidebar Panel -->
        <div id="alertSidebar" class="alert-sidebar">
            <div class="alert-sidebar-header">
                <div class="alert-sidebar-title">üö® Threshold Alerts</div>
                <button class="alert-sidebar-close" onclick="toggleAlertSidebar()">√ó</button>
            </div>

            <!-- Alert Threshold Settings -->
            <div style="padding: 16px 20px; border-bottom: 1px solid #2a2e39; background: #1a1e2a;">
                <div style="margin-bottom: 8px; color: #787b86; font-size: 12px;">Alert Threshold Setting</div>
                <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <label style="color: #d1d4dc; font-size: 14px;">Alert when score below:</label>
                    <input type="number" id="globalThreshold" value="70" min="0" max="100" step="1"
                           style="width: 70px; padding: 6px 10px; background: #2a2e39; border: 1px solid #363a45;
                                  border-radius: 4px; color: #d1d4dc; font-size: 14px; text-align: center;">
                    <span style="color: #d1d4dc; font-size: 14px;">%</span>
                    <button onclick="saveThresholdSetting()"
                            style="padding: 6px 16px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
                                   color: white; border: none; border-radius: 4px; font-size: 12px; font-weight: 600;
                                   cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                        üíæ Save
                    </button>
                    <span id="thresholdSaveStatus" style="color: #4CAF50; font-size: 11px; display: none;">‚úì Saved</span>
                </div>
                <div style="margin-top: 8px; color: #787b86; font-size: 11px; font-style: italic;">
                    This sets the threshold for all inspection types. Click Save to persist your changes.
                </div>
            </div>

            <div class="alert-filters">
                <div class="alert-filter-row">
                    <button class="alert-filter-btn active" data-filter="all" onclick="filterAlerts('all')">All</button>
                    <button class="alert-filter-btn" data-filter="unacknowledged" onclick="filterAlerts('unacknowledged')">Unacknowledged</button>
                    <button class="alert-filter-btn" data-filter="acknowledged" onclick="filterAlerts('acknowledged')">Acknowledged</button>
                </div>
                <div class="alert-filter-row">
                    <button class="alert-filter-btn" data-filter="food" onclick="filterAlerts('food')">Food</button>
                    <button class="alert-filter-btn" data-filter="residential" onclick="filterAlerts('residential')">Residential</button>
                    <button class="alert-filter-btn" data-filter="burial" onclick="filterAlerts('burial')">Burial</button>
                    <button class="alert-filter-btn" data-filter="spirit" onclick="filterAlerts('spirit')">Spirit</button>
                </div>
                <div class="alert-filter-row">
                    <button class="alert-filter-btn" data-filter="swimming" onclick="filterAlerts('swimming')">Swimming Pool</button>
                    <button class="alert-filter-btn" data-filter="small" onclick="filterAlerts('small')">Small Hotels</button>
                    <button class="alert-filter-btn" data-filter="barbershop" onclick="filterAlerts('barbershop')">Barbershop</button>
                    <button class="alert-filter-btn" data-filter="institutional" onclick="filterAlerts('institutional')">Institutional</button>
                </div>
            </div>

            <div class="alert-list" id="sidebarAlertList">
                <!-- Alert cards will be dynamically inserted here -->
            </div>

            <div class="bulk-actions">
                <button class="bulk-action-btn acknowledge-all" onclick="acknowledgeAllAlerts()">‚úì Acknowledge All</button>
                <button class="bulk-action-btn clear-all" onclick="clearAcknowledgedAlerts()">üóëÔ∏è Clear Acknowledged</button>
            </div>
        </div>

        <!-- Admin Tools Container -->
        <div id="adminToolsContainer" class="admin-tools-container">
            <button class="sidebar-button" onclick="openModal('active_users')">üë• Active Users</button>
            <button class="sidebar-button" onclick="openModal('audit_log')">üìã Audit Log</button>
            <button class="sidebar-button" onclick="openModal('inspector_performance')">üìä Inspector Performance</button>
            <button class="sidebar-button" onclick="openModal('alerts')">üö® Alerts</button>
            <button class="sidebar-button" onclick="openModal('inspection_map')">üó∫Ô∏è Inspection Map</button>
            <button class="sidebar-button" onclick="openModal('custom_reports')">üìà Custom Reports</button>
            <button class="sidebar-button" onclick="openModal('user_management')">üë§ User Management</button>
            <button class="sidebar-button" onclick="openModal('system_health')">üíö System Health</button>
            <button class="sidebar-button" onclick="openModal('task_assignment')">üìù Task Assignment</button>
            <button class="sidebar-button" onclick="openModal('security_metrics')">üîí Security Metrics</button>
            <button class="sidebar-button" onclick="window.location.href='/admin/form_builder'">üîß Form Builder</button>
            <button class="sidebar-button" onclick="window.location.href='/admin/forms'">üìù Manage Forms</button>
            <button class="sidebar-button" onclick="window.location.href='/parish_leaderboard'">üèÜ Parish Rankings</button>
            <button class="sidebar-button" onclick="toggleFormCreator()">‚ûï Create Forms</button>
            <button class="sidebar-button" onclick="openModal('inspector_dashboard_view')">üìä Inspector View</button>
            <button class="sidebar-button" onclick="window.location.href='/admin/support-access'">üîì Support Access</button>
            <button class="sidebar-button" onclick="window.location.href='/admin/audit-logs'">üìú Security Audit Logs</button>
            <button class="sidebar-button" onclick="window.location.href='/admin/system-info'">üîê System Security Info</button>
            <button class="sidebar-button" onclick="window.location.href='/admin/security'" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 16px;">üõ°Ô∏è Security Dashboard</button>
        </div>

        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <h2 class="text-2xl font-bold mb-4 blue-bold">All Inspections Overview</h2>

            <!-- TradingView Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">INSPECTION METRICS</div>
                    <div class="chart-controls">
                        <button class="chart-btn chart-type-btn active" data-type="candlestick">Candlestick</button>
                        <button class="chart-btn chart-type-btn" data-type="line">Line</button>
                        <button class="chart-btn chart-type-btn" data-type="area">Area</button>
                        <div class="timeframe-group">
                            <button class="chart-btn time-btn" data-time="5min">5 Min</button>
                            <button class="chart-btn time-btn" data-time="30min">30 Min</button>
                            <button class="chart-btn time-btn" data-time="1hour">1 Hour</button>
                            <button class="chart-btn time-btn active" data-time="daily">Daily</button>
                            <button class="chart-btn time-btn" data-time="weekly">Weekly</button>
                            <button class="chart-btn time-btn" data-time="monthly">Monthly</button>
                        </div>
                        <div class="stats-toggles">
                            <button class="stat-toggle" data-stat="mean" data-tab="overview">Mean</button>
                            <button class="stat-toggle" data-stat="median" data-tab="overview">Median</button>
                            <button class="stat-toggle" data-stat="mode" data-tab="overview">Mode</button>
                        </div>
                        <div class="metrics-display" id="metricsDisplay">
                            <div>Pass Rate: <span id="passRate">0%</span></div>
                            <div>Total: <span id="totalInspections">0</span></div>
                            <div>Failed: <span id="failedInspections">0</span></div>
                            <div>Mean: <span id="meanScore">0%</span></div>
                            <div>Median: <span id="medianScore">0%</span></div>
                            <div>Mode: <span id="modeScore">0%</span></div>
                        </div>
                    </div>
                </div>
                <div class="chart-area">
                    <div id="overviewChart"></div>
                </div>
            </div>

            <!-- Data Table with corrected columns -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden mt-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name/Establishment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner/Applicant</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for form in forms %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="form-id">{{ '%03d'|format(loop.index) }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="truncate-text" title="{{ form[4] if form[4] else 'N/A' }}">
                                    {% if form[1] == 'Food Establishment' %}
                                        {{ form[4] if form[4] else 'Food Establishment' }}
                                    {% elif form[1] == 'Residential' %}
                                        {{ form[4] if form[4] else 'Residential Property' }}
                                    {% elif form[1] == 'Burial' %}
                                        {{ form[4] if form[4] else 'Burial Application' }}
                                    {% elif form[1] == 'Spirit Licence Premises' %}
                                        {{ form[4] if form[4] else 'Spirit Licence Premises' }}
                                    {% elif form[1] == 'Swimming Pool' %}
                                        {{ form[4] if form[4] else 'Swimming Pool Facility' }}
                                    {% elif form[1] == 'Small Hotel' %}
                                        {{ form[4] if form[4] else 'Small Hotel' }}
                                    {% elif form[1] == 'Meat Processing' %}
                                        {{ form[4] if form[4] else 'Meat Processing Facility' }}
                                    {% else %}
                                        {{ form[4] if form[4] else form[1] }}
                                    {% endif %}
                                </div>
                                <div class="text-xs text-gray-500">{{ form[1] }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="truncate-text">
                                    {{ form[6] if form[6] else 'N/A' }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded {{ 'bg-green-100 text-green-800' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'bg-red-100 text-red-800' }}">
                                    {{ 'Pass' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'Fail' }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ form[3].strftime('%Y-%m-%d') if form[3] and form[3].__class__.__name__ == 'datetime' else (form[3].split(' ')[0] if form[3] and ' ' in (form[3]|string) else (form[3] if form[3] else 'N/A')) }}</div>
                                <div class="text-xs text-gray-500">{{ form[3].strftime('%H:%M:%S') if form[3] and form[3].__class__.__name__ == 'datetime' else (form[3].split(' ', 1)[1] if form[3] and ' ' in (form[3]|string) and ((form[3]|string).split(' ', 1)|length) > 1 else '') }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="form-actions">
                                    <button class="form-action-button" onclick="viewForm('{{ form[0] }}', '{{ form[1] }}')">View</button>
                                    <button class="form-action-button" onclick="downloadForm('{{ form[0] }}', '{{ form[1] }}')">Download</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Individual Tabs for each inspection type -->
        {% for tab in ['food', 'residential', 'burial', 'spirit_licence', 'swimming_pool', 'small_hotels', 'barbershop', 'institutional', 'meat_processing'] %}
        <div id="{{ tab }}" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 black-bold">{{ tab.replace('_', ' ').title() }} Inspections</h2>

            <!-- TradingView Chart for each tab -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">{{ tab.replace('_', ' ').upper() }} METRICS</div>
                    <div class="chart-controls">
                        <button class="chart-btn chart-type-btn active" data-type="candlestick" data-tab="{{ tab }}">Candlestick</button>
                        <button class="chart-btn chart-type-btn" data-type="line" data-tab="{{ tab }}">Line</button>
                        <button class="chart-btn chart-type-btn" data-type="area" data-tab="{{ tab }}">Area</button>
                        <div class="timeframe-group">
                            <button class="chart-btn time-btn" data-time="5min" data-tab="{{ tab }}">5 Min</button>
                            <button class="chart-btn time-btn" data-time="30min" data-tab="{{ tab }}">30 Min</button>
                            <button class="chart-btn time-btn" data-time="1hour" data-tab="{{ tab }}">1 Hour</button>
                            <button class="chart-btn time-btn active" data-time="daily" data-tab="{{ tab }}">Daily</button>
                            <button class="chart-btn time-btn" data-time="weekly" data-tab="{{ tab }}">Weekly</button>
                            <button class="chart-btn time-btn" data-time="monthly" data-tab="{{ tab }}">Monthly</button>
                        </div>
                        <div class="stats-toggles">
                            <button class="stat-toggle" data-stat="mean" data-tab="{{ tab }}">Mean</button>
                            <button class="stat-toggle" data-stat="median" data-tab="{{ tab }}">Median</button>
                            <button class="stat-toggle" data-stat="mode" data-tab="{{ tab }}">Mode</button>
                        </div>
                        <div class="metrics-display" id="metricsDisplay-{{ tab }}">
                            <div>Pass Rate: <span id="passRate-{{ tab }}">0%</span></div>
                            <div>Total: <span id="totalInspections-{{ tab }}">0</span></div>
                            <div>Failed: <span id="failedInspections-{{ tab }}">0</span></div>
                            <div>Mean: <span id="meanScore-{{ tab }}">0%</span></div>
                            <div>Median: <span id="medianScore-{{ tab }}">0%</span></div>
                            <div>Mode: <span id="modeScore-{{ tab }}">0%</span></div>
                        </div>
                    </div>
                </div>
                <div class="chart-area">
                    <div id="{{ tab }}Chart"></div>
                </div>
            </div>

            <!-- Data Table for each tab with corrected columns -->
            <div class="bg-white shadow-md rounded-lg overflow-hidden mt-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                {% if tab == 'food' %}Name/Establishment
                                {% elif tab == 'residential' %}Premises Name
                                {% elif tab == 'burial' %}Applicant Name
                                {% elif tab == 'spirit_licence' %}Establishment Name
                                {% elif tab == 'swimming_pool' %}Facility Name
                                {% elif tab == 'small_hotels' %}Hotel Name
                                {% elif tab == 'barbershop' %}Establishment Name
                                {% elif tab == 'institutional' %}Institution Name
                                {% endif %}
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                {% if tab == 'food' %}Owner/Manager
                                {% elif tab == 'residential' %}Owner/Agent
                                {% elif tab == 'burial' %}Deceased Name
                                {% elif tab == 'spirit_licence' %}License Holder
                                {% elif tab == 'swimming_pool' %}Owner/Manager
                                {% elif tab == 'small_hotels' %}Owner/Manager
                                {% elif tab == 'barbershop' %}Owner/Manager
                                {% elif tab == 'institutional' %}Administrator
                                {% endif %}
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% set counter = namespace(value=0) %}
                        {% for form in forms %}
                        {% if form[1]|lower == tab.replace('_', ' ')
    or (tab == 'food' and form[1] == 'Food Establishment')
    or (tab == 'spirit_licence' and form[1] == 'Spirit Licence Premises')
    or (tab == 'swimming_pool' and form[1] == 'Swimming Pool')
    or (tab == 'small_hotels' and form[1] == 'Small Hotel')
    or (tab == 'barbershop' and form[1] == 'Barbershop')
    or (tab == 'institutional' and form[1] == 'Institutional Health')
    or (tab == 'meat_processing' and form[1] == 'Meat Processing')
%}

                        {% set counter.value = counter.value + 1 %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="form-id">{{ '%03d'|format(counter.value) }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="truncate-text" title="{{ form[4] if form[4] else 'N/A' }}">
                                    {{ form[4] if form[4] else 'N/A' }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="truncate-text">
                                    {{ form[6] if form[6] else 'N/A' }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-xs rounded {{ 'bg-green-100 text-green-800' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'bg-red-100 text-red-800' }}">
                                    {{ 'Pass' if form[5] in ['Pass', 'Completed', 'Satisfactory'] else 'Fail' }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ form[3].strftime('%Y-%m-%d') if form[3] and form[3].__class__.__name__ == 'datetime' else (form[3].split(' ')[0] if form[3] and ' ' in (form[3]|string) else (form[3] if form[3] else 'N/A')) }}</div>
                                <div class="text-xs text-gray-500">{{ form[3].strftime('%H:%M:%S') if form[3] and form[3].__class__.__name__ == 'datetime' else (form[3].split(' ', 1)[1] if form[3] and ' ' in (form[3]|string) and ((form[3]|string).split(' ', 1)|length) > 1 else '') }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="form-actions">
                                    <button class="form-action-button" onclick="viewForm('{{ form[0] }}', '{{ form[1] }}')">View</button>
                                    <button class="form-action-button" onclick="downloadForm('{{ form[0] }}', '{{ form[1] }}')">Download</button>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}

        <!-- Distribution Tab -->
        <div id="distribution" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 black-bold">Form Distribution Analytics</h2>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
                    <div class="text-sm font-medium opacity-90">Total Inspections</div>
                    <div class="text-3xl font-bold mt-2" id="totalDistributionCount">0</div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
                    <div class="text-sm font-medium opacity-90">Overall Pass Rate</div>
                    <div class="text-3xl font-bold mt-2" id="overallPassRate">0%</div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
                    <div class="text-sm font-medium opacity-90">Form Types</div>
                    <div class="text-3xl font-bold mt-2" id="formTypesCount">0</div>
                </div>
            </div>

            <!-- Pie Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Form Type Distribution Chart -->
                <div class="bg-white shadow-lg rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">üìä Form Type Distribution</h3>
                    <div class="relative" style="height: 400px;">
                        <canvas id="formTypeDistributionChart"></canvas>
                    </div>
                </div>

                <!-- Pass/Fail by Form Type Chart -->
                <div class="bg-white shadow-lg rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">‚úì Pass/Fail Rates by Form Type</h3>
                    <div class="relative" style="height: 400px;">
                        <canvas id="passFailByTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Statistics Table -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Form Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pass</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fail</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pass Rate</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage of Total</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="distributionTableBody">
                        <!-- Table rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Form Creator -->
    <div class="form-selector">
        <button class="create-form-btn" onclick="toggleFormCreator()">
            ‚ûï Create New Form
        </button>
        <div id="formDropdown" class="form-dropdown">
            <div class="form-option" onclick="createForm('/new_form')">
                <div class="form-option-title">Food Establishment Inspection</div>
                <div class="form-option-desc">Create inspection form for restaurants, cafes, and food establishments</div>
            </div>
            <div class="form-option" onclick="createForm('/new_small_hotels_form')">
                <div class="form-option-title">Small Hotels Inspection</div>
                <div class="form-option-desc">Create inspection form for small hotels and accommodations</div>
            </div>
            <div class="form-option" onclick="createForm('/new_residential_form')">
                <div class="form-option-title">Residential & Non-Residential Inspection</div>
                <div class="form-option-desc">Create inspection form for residential and non-residential properties</div>
            </div>
            <div class="form-option" onclick="createForm('/new_burial_form')">
                <div class="form-option-title">Burial Site Inspection</div>
                <div class="form-option-desc">Create inspection form for burial sites and cemeteries</div>
            </div>
            <div class="form-option" onclick="createForm('/new_spirit_licence_form')">
                <div class="form-option-title">Spirit Licence Premises Inspection</div>
                <div class="form-option-desc">Create inspection form for bars and spirit license premises</div>
            </div>
            <div class="form-option" onclick="createForm('/new_swimming_pool_form')">
                <div class="form-option-title">Swimming Pool Inspection</div>
                <div class="form-option-desc">Create inspection form for swimming pools and aquatic facilities</div>
            </div>
            <div class="form-option" onclick="createForm('/new_barbershop_form')">
                <div class="form-option-title">Barbershop & Beauty Salon Inspection</div>
                <div class="form-option-desc">Create inspection form for barbershops and beauty salons</div>
            </div>
            <div class="form-option" onclick="createForm('/new_institutional_form')">
                <div class="form-option-title">Institutional Health Inspection</div>
                <div class="form-option-desc">Create inspection form for institutional health facilities</div>
            </div>
        </div>
    </div>

    <!-- Admin Modals (keeping your existing modals) -->
    <div id="active_users_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('active_users')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Active Users & Login History</h2>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="activeUsersTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Login Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Audit Log Modal -->
    <div id="audit_log_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('audit_log')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Audit Log</h2>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="auditLogTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Inspector Performance Modal -->
    <div id="inspector_performance_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('inspector_performance')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Inspector Performance</h2>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="performanceTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inspector</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pass Rate</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Overdue</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Alerts Modal -->
    <div id="alerts_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('alerts')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">System Alerts</h2>
            <div id="alertsContainer" class="space-y-4"></div>
        </div>
    </div>

    <!-- Inspection Map Modal -->
    <div id="inspection_map_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('inspection_map')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Inspection Locations</h2>
            <div class="mb-4">
                <select id="mapFilter" onchange="updateInspectionMap()" class="px-3 py-2 border border-gray-300 rounded-md">
                    <option value="all">All Inspections</option>
                    <option value="pass">Passed Only</option>
                    <option value="fail">Failed Only</option>
                </select>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Custom Reports Modal -->
    <div id="custom_reports_modal" class="modal">
        <div class="modal-content" style="max-width: 1200px; width: 95%;">
            <span class="modal-close" onclick="closeModal('custom_reports')">√ó</span>
            <h2 class="text-3xl font-bold mb-6 text-center text-blue-800">üìä Inspection Analytics Dashboard</h2>

            <!-- Controls Section -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                    <!-- Report Type Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                        <select id="reportType" class="px-3 py-2 border border-gray-300 rounded-md w-full text-sm">
                            <option value="comprehensive">üìä Comprehensive Dashboard</option>
                            <option value="basic_summary">üìÑ Executive Summary</option>
                            <option value="trend_analysis">üìà Trend Analysis</option>
                            <option value="failure_breakdown">‚ùå Failure Breakdown</option>
                            <option value="inspector_performance">üë§ Inspector Performance</option>
                            <option value="scores_by_type">üéØ Scores by Type</option>
                            <option value="monthly_trends">üìÖ Monthly Trends</option>
                            <option value="establishment_ranking">üèÜ Establishment Rankings</option>
                            <option value="parish_analysis">üó∫Ô∏è Parish Analysis</option>
                        </select>
                    </div>

                    <!-- Inspection Type Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Inspection Type</label>
                        <select id="reportInspectionType" class="px-3 py-2 border border-gray-300 rounded-md w-full text-sm">
                            <option value="all">All Types</option>
                            <option value="Food Establishment">Food Establishment</option>
                            <option value="Spirit Licence Premises">Spirit Licence</option>
                            <option value="Swimming Pool">Swimming Pool</option>
                            <option value="Small Hotel">Small Hotel</option>
                            <option value="Barbershop">Barbershop</option>
                            <option value="Institutional Health">Institutional</option>
                            <option value="Residential">Residential</option>
                            <option value="Burial Site">Burial Site</option>
                        </select>
                    </div>

                    <!-- Time Period -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Time Period</label>
                        <select id="reportTimeframe" class="px-3 py-2 border border-gray-300 rounded-md w-full text-sm">
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 3 Months</option>
                            <option value="180">Last 6 Months</option>
                            <option value="365">Last Year</option>
                            <option value="all">All Time</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>

                    <!-- Generate Button -->
                    <div class="flex items-end">
                        <button onclick="generateCustomReport()" id="generateReportBtn"
                                class="w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-md hover:from-blue-700 hover:to-blue-800 text-sm font-medium shadow-md">
                            üîç Generate Report
                        </button>
                    </div>

                    <!-- Export Buttons -->
                    <div class="flex items-end gap-2">
                        <button onclick="exportReportPDF()" id="exportPDFBtn" disabled
                                class="flex-1 px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-400 text-sm font-medium">
                            üìÑ PDF
                        </button>
                        <button onclick="exportReportCSV()" id="exportCSVBtn" disabled
                                class="flex-1 px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 text-sm font-medium">
                            üìä CSV
                        </button>
                    </div>
                </div>

                <!-- Custom Date Range -->
                <div id="customDateRange" class="grid grid-cols-2 gap-4 mt-4" style="display: none;">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                        <input type="date" id="startDate" class="px-3 py-2 border border-gray-300 rounded-md w-full text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                        <input type="date" id="endDate" class="px-3 py-2 border border-gray-300 rounded-md w-full text-sm">
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" style="display: none;">
                <!-- Summary Cards -->
                <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Cards will be generated here -->
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Pass/Fail Rate Over Time -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-3 text-gray-800">üìà Pass/Fail Rates Over Time</h3>
                        <div id="trendChart" class="h-64"></div>
                    </div>

                    <!-- Inspector Performance -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-3 text-gray-800">üë§ Inspector Performance</h3>
                        <div id="inspectorChart" class="h-64"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Scores by Type -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-3 text-gray-800">üìä Average Scores by Type</h3>
                        <div id="scoresChart" class="h-64"></div>
                    </div>

                    <!-- Monthly Trends -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-3 text-gray-800">üìÖ Monthly Inspection Trends</h3>
                        <div id="monthlyChart" class="h-64"></div>
                    </div>
                </div>

                <!-- Full Width Charts -->
                <div class="grid grid-cols-1 gap-6">
                    <!-- Top Performing vs Failing -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-3 text-gray-800">üèÜ Top Performing vs Failing Establishments</h3>
                        <div id="establishmentChart" class="h-80"></div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="dashboardLoading" class="text-center py-8" style="display: none;">
                <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent text-blue-600 rounded-full" role="status" aria-label="loading">
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-2 text-gray-600">Generating analytics dashboard...</p>
            </div>

            <!-- Initial State -->
            <div id="dashboardInitial" class="text-center py-12">
                <div class="text-6xl mb-4">üìä</div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">Advanced Inspection Analytics & Reporting</h3>
                <p class="text-gray-600 mb-6">Select report type, inspection type, and time period above, then click "Generate Report"</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-left max-w-4xl mx-auto">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="font-bold text-blue-900 mb-2">üìÑ Executive Reports</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>‚Ä¢ Comprehensive Dashboard</li>
                            <li>‚Ä¢ Executive Summary</li>
                            <li>‚Ä¢ Monthly Trends</li>
                        </ul>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="font-bold text-green-900 mb-2">üìà Performance Analysis</h4>
                        <ul class="text-sm text-green-700 space-y-1">
                            <li>‚Ä¢ Trend Analysis</li>
                            <li>‚Ä¢ Inspector Performance</li>
                            <li>‚Ä¢ Establishment Rankings</li>
                        </ul>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-bold text-purple-900 mb-2">üéØ Detailed Insights</h4>
                        <ul class="text-sm text-purple-700 space-y-1">
                            <li>‚Ä¢ Failure Breakdown</li>
                            <li>‚Ä¢ Scores by Type</li>
                            <li>‚Ä¢ Parish Analysis</li>
                        </ul>
                    </div>
                </div>

                <div class="mt-8 bg-yellow-50 p-4 rounded-lg max-w-2xl mx-auto border border-yellow-200">
                    <p class="text-sm text-yellow-800">
                        <strong>üí° Tip:</strong> After generating a report, use the PDF or CSV buttons to download professional formatted reports for presentations or further analysis.
                    </p>
                </div>
            </div>

            <!-- Report Display Area -->
            <div id="reportContent" style="display: none;">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="reportHeader" class="mb-6 pb-4 border-b">
                        <h3 id="reportTitle" class="text-2xl font-bold text-gray-800"></h3>
                        <p id="reportSubtitle" class="text-gray-600 mt-2"></p>
                    </div>
                    <div id="reportBody">
                        <!-- Report content will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="user_management_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('user_management')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">
                User Management
                <span id="userCountBadge" class="text-sm font-normal text-gray-600 ml-2">(Loading...)</span>
            </h2>
            <div class="mb-4">
                <button onclick="openAddUserForm()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Add New User</button>
                <button onclick="loadUsers()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 ml-2">üîÑ Refresh</button>
            </div>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="usersTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>


<!-- ADD THIS NEW MODAL RIGHT HERE -->
<div id="add_user_modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="modal-close" onclick="closeModal('add_user')">&times;</span>
        <h2 class="text-2xl font-bold mb-4 black-bold">Add New User</h2>

        <form id="addUserForm" class="space-y-4">
            <div>
                <label for="newUsername" class="block text-sm font-medium text-gray-700">Username</label>
                <input type="text" id="newUsername" name="username" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <small class="text-gray-500">Username must be unique</small>
            </div>

            <div>
                <label for="newEmail" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="newEmail" name="email" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label for="newPassword" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="newPassword" name="password" required minlength="6"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <small class="text-gray-500">Minimum 6 characters</small>
            </div>

            <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <div>
                <label for="newUserRole" class="block text-sm font-medium text-gray-700">Role</label>
                <select id="newUserRole" name="role" required
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select a role</option>
                    <option value="inspector">Inspector</option>
                    <option value="admin">Admin</option>
                    <option value="medical_officer">Medical Officer</option>
                </select>
            </div>

            <div id="addUserError" class="text-red-600 text-sm" style="display: none;"></div>
            <div id="addUserSuccess" class="text-green-600 text-sm" style="display: none;"></div>

            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="closeModal('add_user')"
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Create User
                </button>
            </div>
        </form>
    </div>
</div>

    <!-- System Health Modal -->
    <div id="system_health_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('system_health')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">System Health</h2>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-green-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800">Uptime</h3>
                    <p class="text-2xl font-bold text-green-900" id="uptimeValue">Loading...</p>
                </div>
                <div class="bg-blue-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">DB Response</h3>
                    <p class="text-2xl font-bold text-blue-900" id="responseValue">Loading...</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-yellow-800">Error Rate</h3>
                    <p class="text-2xl font-bold text-yellow-900" id="errorValue">Loading...</p>
                </div>
            </div>
            <div id="healthChart"></div>
        </div>
    </div>

    <!-- Task Assignment Modal -->
    <div id="task_assignment_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('task_assignment')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Task Assignment</h2>
            <div class="mb-4">
                <button onclick="openNewTaskForm()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Create New Task</button>
            </div>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="tasksTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assignee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- New Task Form Modal -->
    <div id="newTaskModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeNewTaskForm()">√ó</span>
            <h2 class="text-2xl font-bold mb-6 black-bold">Create New Task</h2>
            <form id="newTaskForm" class="space-y-4">
                <div>
                    <label for="taskTitle" class="block text-sm font-medium text-gray-700 mb-2">Task Title</label>
                    <input type="text" id="taskTitle" name="title" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label for="taskDescription" class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea id="taskDescription" name="description" rows="3" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div>
                    <label for="taskAssignee" class="block text-sm font-medium text-gray-700 mb-2">Assign To User</label>
                    <select id="taskAssignee" name="assignee" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select User...</option>
                        <!-- Fallback options - will be replaced by dynamic loading -->
                        <option value="admin">admin</option>
                        <option value="inspector1">inspector1</option>
                        <option value="inspector2">inspector2</option>
                        <option value="all">All Users</option>
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>

                <div>
                    <label for="taskPriority" class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                    <select id="taskPriority" name="priority" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                </div>

                <div>
                    <label for="taskDueDate" class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                    <input type="datetime-local" id="taskDueDate" name="due_date" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeNewTaskForm()"
                            class="px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">Cancel</button>
                    <button type="submit"
                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Create Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Metrics Modal -->
    <div id="security_metrics_modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('security_metrics')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Security Metrics</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800">MFA Adoption</h3>
                    <p class="text-2xl font-bold text-blue-900" id="mfaAdoption">Loading...</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg">
                    <h3 class="font-semibold text-red-800">Security Events</h3>
                    <p class="text-2xl font-bold text-red-900" id="securityEvents">Loading...</p>
                </div>
            </div>
            <div class="bg-white shadow-md rounded-lg overflow-hidden">
                <table id="securityEventsTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Inspector Dashboard View Modal -->
    <div id="inspector_dashboard_view_modal" class="modal">
        <div class="modal-content" style="max-width: 95%; width: 95%;">
            <span class="modal-close" onclick="closeModal('inspector_dashboard_view')">√ó</span>
            <h2 class="text-2xl font-bold mb-4 black-bold">Inspector Dashboard View</h2>
            <iframe id="inspectorDashboardFrame" src="/dashboard" width="100%" height="600px" style="border: none; border-radius: 8px;"></iframe>
        </div>
    </div>

    <script>
        // Global variables
        let charts = {};
        let currentData = {};
        let statisticsLines = {};
        let searchDebounceTimer;
        let currentStatistics = {};

        // MESSAGING SYSTEM VARIABLES - FIXED VERSION
        let messagingOpen = false;
        let currentChatUser = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Admin Dashboard...');

            // Check if TradingView library is loaded
            if (typeof LightweightCharts === 'undefined') {
                console.error('TradingView library not loaded!');
                alert('Chart library failed to load. Please refresh the page.');
                return;
            }

            // Initialize all charts
            initializeCharts();

            // Load dynamic form types for dropdown
            loadFormTypes();

            // Handle custom date range toggle for reports
            const timeframeSelect = document.getElementById('reportTimeframe');
            const customDateRange = document.getElementById('customDateRange');

            if (timeframeSelect) {
                timeframeSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customDateRange.style.display = 'grid';
                    } else {
                        customDateRange.style.display = 'none';
                    }
                });
            }
            setupTabs();
            setupChartControls();
            loadAllData();

            // Initialize Admin Tools
            initializeAdminTools();

            // Initialize Search
            initializeSearch();

            // Initialize Statistics Toggles
            initializeStatisticsToggles();

            // FIXED MESSAGING INITIALIZATION
            initializeMessaging();
        });

        // FIXED MESSAGING FUNCTIONS
        function initializeMessaging() {
            console.log('Setting up messaging system...');

            // Add click event listener to messaging button
            const messagingBtn = document.getElementById('messagingToggleBtn');
            if (messagingBtn) {
                messagingBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Messaging button clicked!');
                    toggleMessaging();
                });
                console.log('Messaging button event listener added');
            } else {
                console.error('Messaging button not found!');
            }

            // Initialize some demo data
            setTimeout(() => {
                showMessageBadge(3);
            }, 1000);
        }

        // Toggle messaging panel - Updated to use real data only
        function toggleMessaging() {
            console.log('toggleMessaging called!');
            const panel = document.getElementById('messagingPanel');

            if (!panel) {
                console.error('messagingPanel element not found!');
                return;
            }

            messagingOpen = !messagingOpen;

            if (messagingOpen) {
                panel.classList.add('open');
                loadUsersList();
                initializeMessagePolling(); // Start polling when messaging is opened
                console.log('Opening messaging panel');
            } else {
                panel.classList.remove('open');
                console.log('Closing messaging panel');
            }
        }

        // Load users list - only real users from system
        async function loadUsersList() {
            console.log('Loading users list...');
            const usersList = document.getElementById('usersList');

            if (!usersList) {
                console.error('usersList element not found!');
                return;
            }

            // Show loading state
            usersList.innerHTML = '<div class="loading-message">Loading users...</div>';

            try {
                // Fetch all users from the system
                const response = await fetch('/api/admin/users');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                console.log('Users loaded from API:', users);

                if (!users || users.length === 0) {
                    usersList.innerHTML = '<div class="loading-message">No users found in the system.</div>';
                    return;
                }

                displayUsers(users);

            } catch (error) {
                console.error('Error loading users:', error);

                // Show error message - no demo fallback
                usersList.innerHTML = `
                    <div class="error-message">
                        Failed to load users: ${error.message}<br>
                        <small>Please check your connection and try again.</small>
                    </div>
                `;
            }
        }

        // Display users in the list - only real users from the system
        function displayUsers(users) {
            const usersList = document.getElementById('usersList');

            if (!users || users.length === 0) {
                usersList.innerHTML = '<div class="loading-message">No users found in the system</div>';
                return;
            }

            usersList.innerHTML = '';

            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.onclick = () => openChat(user);

                const avatar = user.username.charAt(0).toUpperCase();
                const roleColor = getRoleColor(user.role);

                // Build unread indicator
                let unreadIndicator = '<div class="user-status"></div>';
                if (user.unread_count && user.unread_count > 0) {
                    unreadIndicator = `<div class="unread-count">${user.unread_count}</div>`;
                }

                userItem.innerHTML = `
                    <div class="user-avatar" style="background: ${roleColor};">${avatar}</div>
                    <div class="user-info">
                        <div class="user-name">${user.username}</div>
                        <div class="user-role">${formatRole(user.role)}</div>
                    </div>
                    ${unreadIndicator}
                `;

                usersList.appendChild(userItem);
            });

            console.log('Real users displayed successfully:', users.length);
        }

        // Open chat with a user
        function openChat(user) {
            console.log('Opening chat with:', user);
            currentChatUser = user;

            // Update chat window header
            document.getElementById('chatAvatar').textContent = user.username.charAt(0).toUpperCase();
            document.getElementById('chatUsername').textContent = user.username;
            document.getElementById('currentChatUserId').value = user.id;

            // Load demo messages for this user
            loadDemoMessages(user.id);

            // Show chat window, hide contact list
            document.getElementById('chatWindow').classList.add('open');
            document.getElementById('messagingPanel').classList.remove('open');
            messagingOpen = false;

            // Clear unread count
            updateUnreadCount(user.id, 0);
        }

        // Check for unread messages on page load
        async function checkUnreadMessages() {
            try {
                const response = await fetch('/api/admin/unread_message_count');
                if (!response.ok) throw new Error('Failed to get unread count');

                const data = await response.json();
                if (data.count > 0) {
                    showMessageBadge(data.count);
                }
            } catch (error) {
                console.error('Error checking unread messages:', error);
                // Don't show any badge if API fails
            }
        }

        // Load messages for a specific user - only real messages
        async function loadChatMessages(userId) {
            try {
                const response = await fetch(`/api/admin/messages/${userId}`);
                if (!response.ok) throw new Error('Failed to load messages');

                const messages = await response.json();

                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = '';

                if (messages.length === 0) {
                    messagesContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No messages yet. Start the conversation!</div>';
                } else {
                    messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = `message ${msg.is_sent ? 'sent' : 'received'}`;
                        div.innerHTML = `
                            <div class="message-bubble">${msg.content}</div>
                            <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                        `;
                        messagesContainer.appendChild(div);
                    });
                }

                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Error loading messages:', error);
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = `
                    <div style="text-align: center; color: #e53e3e; padding: 20px; background: #fed7d7; margin: 10px; border-radius: 8px;">
                        Failed to load messages: ${error.message}
                    </div>
                `;
            }
        }

        // Send message function
        async function sendMessage(event) {
            event.preventDefault();

            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            const recipientId = document.getElementById('currentChatUserId').value;

            if (!content || !recipientId) {
                console.log('Missing content or recipient');
                return;
            }

            console.log('Sending message:', content, 'to user:', recipientId);

            // Add message to chat immediately (optimistic update)
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message sent';
            messageDiv.innerHTML = `
                <div class="message-bubble">${content}</div>
                <div class="message-time">${new Date().toLocaleTimeString()}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Clear input
            input.value = '';

            try {
                // Try to send via API
                const response = await fetch('/api/admin/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipient_id: parseInt(recipientId),
                        content: content
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to send message');
                }

                console.log('Message sent successfully');

            } catch (error) {
                console.warn('Failed to send message via API:', error);
                // Message is already shown optimistically, so we just log the error
                // In a real app, you might want to show a retry button or mark as failed
            }
        }

        // Close chat window
        function closeChatWindow() {
            document.getElementById('chatWindow').classList.remove('open');
            currentChatUser = null;
        }

        // Helper function to get role color
        function getRoleColor(role) {
            const colors = {
                'admin': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'inspector': 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'medical_officer': 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
            };
            return colors[role] || 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }

        // Helper function to format role
        function formatRole(role) {
            switch(role) {
                case 'medical_officer': return 'Medical Officer';
                case 'admin': return 'Admin';
                case 'inspector': return 'Inspector';
                default: return role;
            }
        }

        // Show message badge - only for real unread messages
        function showMessageBadge(count) {
            const badge = document.getElementById('messageBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Update unread count for a user in the UI
        function updateUnreadCount(userId, count) {
            const userItems = document.querySelectorAll('.user-item');
            userItems.forEach(item => {
                // Find the user by matching the onclick handler or data attribute
                if (item.onclick && item.onclick.toString().includes(`openChat`) &&
                    item.querySelector('.user-name') &&
                    item.querySelector('.user-name').textContent) {

                    const unreadEl = item.querySelector('.unread-count');
                    if (count > 0) {
                        if (unreadEl) {
                            unreadEl.textContent = count;
                        } else {
                            // Add unread count
                            const newUnread = document.createElement('div');
                            newUnread.className = 'unread-count';
                            newUnread.textContent = count;
                            item.appendChild(newUnread);
                        }
                    } else {
                        if (unreadEl) {
                            unreadEl.remove();
                            // Add status dot back
                            const statusDot = document.createElement('div');
                            statusDot.className = 'user-status';
                            item.appendChild(statusDot);
                        }
                    }
                }
            });

            // Update global message badge
            checkUnreadMessages();
        }

        // Periodically check for new messages
        function startMessagePolling() {
            setInterval(() => {
                checkUnreadMessages();

                // If a chat is open, refresh the messages
                if (currentChatUser && currentChatUser.id) {
                    loadChatMessages(currentChatUser.id);
                }
            }, 5000); // Check every 5 seconds
        }

        // Rest of your original code continues here...
        function initializeCharts() {
            createChart('overview');
            ['food', 'residential', 'burial', 'spirit_licence', 'swimming_pool', 'small_hotels', 'barbershop', 'institutional'].forEach(tab => {
                createChart(tab);
            });
        }

        function createChart(tabName) {
            const containerId = tabName === 'overview' ? 'overviewChart' : tabName + 'Chart';
            const container = document.getElementById(containerId);

            if (!container) {
                console.error(`Container not found: ${containerId}`);
                return;
            }

            try {
                const chart = LightweightCharts.createChart(container, {
                    width: container.offsetWidth || 800,
                    height: 380,
                    layout: {
                        background: { type: 'solid', color: '#131722' },
                        textColor: '#d1d4dc',
                    },
                    grid: {
                        vertLines: { color: 'rgba(42, 46, 57, 0.5)' },
                        horzLines: { color: 'rgba(42, 46, 57, 0.5)' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: '#2a2e39',
                    },
                    timeScale: {
                        borderColor: '#2a2e39',
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });

                charts[tabName] = {
                    chart: chart,
                    series: null,
                    currentType: 'candlestick',
                    statisticLines: {
                        mean: null,
                        median: null,
                        mode: null
                    }
                };

                console.log(`Chart created for: ${tabName}`);
            } catch (error) {
                console.error(`Error creating chart for ${tabName}:`, error);
            }
        }

        // ========================================
        // SEARCH FUNCTIONALITY - FIXED VERSION
        // ========================================
        function initializeSearch() {
            const searchInput = document.getElementById('globalSearchInput');
            const suggestions = document.getElementById('searchSuggestions');

            if (!searchInput || !suggestions) return;

            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchDebounceTimer);
                const query = e.target.value.trim();

                if (query.length < 2) {
                    suggestions.classList.remove('active');
                    suggestions.innerHTML = '';
                    return;
                }

                searchDebounceTimer = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });

            searchInput.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    suggestions.classList.add('active');
                }
            });

            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.classList.remove('active');
                }
            });
        }

        async function performSearch(query) {
            try {
                const response = await fetch(`/api/admin/search_inspections?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Search failed');

                const results = await response.json();
                displaySearchResults(results);
            } catch (error) {
                console.error('Search error:', error);
                // Fallback to client-side search if API fails
                performClientSideSearch(query);
            }
        }

        function performClientSideSearch(query) {
            const results = [];
            const lowerQuery = query.toLowerCase();

            // Search through all visible forms in the current table
            const currentTab = document.querySelector('.tab-content.active');
            const rows = currentTab.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const formId = cells[0].textContent.trim();
                    const establishmentCell = cells[1];

                    // Get establishment name and form type from the cell structure
                    const establishmentDiv = establishmentCell.querySelector('.truncate-text');
                    const typeDiv = establishmentCell.querySelector('.text-xs.text-gray-500');

                    const establishmentName = establishmentDiv ? establishmentDiv.textContent.trim() : '';
                    const formType = typeDiv ? typeDiv.textContent.trim() : 'Food Establishment';

                    const owner = cells[2] ? cells[2].textContent.trim() : '';

                    // Search primarily by establishment name, then owner
                    if (establishmentName.toLowerCase().includes(lowerQuery) || owner.toLowerCase().includes(lowerQuery)) {
                        // Map form types correctly for navigation
                        let mappedFormType = formType;
                        switch (formType) {
                            case 'Institutional':
                                mappedFormType = 'Institutional Health';
                                break;
                            case 'Spirit Licence Premises':
                                mappedFormType = 'Spirit Licence Premises';
                                break;
                            case 'Small Hotel':
                                mappedFormType = 'Small Hotel';
                                break;
                            case 'Swimming Pool':
                                mappedFormType = 'Swimming Pool';
                                break;
                            case 'Food Establishment':
                                mappedFormType = 'Food Establishment';
                                break;
                            case 'Residential':
                                mappedFormType = 'Residential';
                                break;
                            case 'Burial':
                                mappedFormType = 'Burial';
                                break;
                            case 'Barbershop':
                                mappedFormType = 'Barbershop';
                                break;
                            default:
                                mappedFormType = formType;
                        }

                        results.push({
                            id: formId,
                            name: establishmentName || 'Unknown',
                            owner: owner || 'N/A',
                            formType: mappedFormType,
                            match: `${establishmentName} ${owner}`.toLowerCase()
                        });
                    }
                }
            });

            displaySearchResults(results);
        }

        function displaySearchResults(results) {
    const suggestions = document.getElementById('searchSuggestions');

    if (!results || results.length === 0) {
        suggestions.innerHTML = '<div class="suggestion-item">No results found</div>';
        suggestions.classList.add('active');
        return;
    }

    suggestions.innerHTML = '';

    results.slice(0, 10).forEach(result => {
        const item = document.createElement('div');
        item.className = 'suggestion-item';
        item.style.cursor = 'pointer';

        item.innerHTML = `
            <strong>${result.name}</strong>
            <span class="suggestion-type">Form #${result.id}</span>
            <br>
            <small>Owner: ${result.owner}</small>
        `;

        item.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            console.log('Search result clicked:', result);

            try {
                // Extract just the numeric part of the form ID
                const numericId = String(result.id).replace(/\D/g, '');

                // FIX: Use 'type' instead of 'formType' to match backend API
                const formType = result.type || result.formType || 'Food Establishment';

                console.log('Navigating to Form ID:', numericId, 'Form Type:', formType);

                // Construct the correct URL based on form type
                let endpoint;
                switch (formType) {
                    case 'Food Establishment':
                        endpoint = `/inspection/${numericId}`;
                        break;
                    case 'Residential':
                        endpoint = `/residential/inspection/${numericId}`;
                        break;
                    case 'Burial':
                        endpoint = `/burial/inspection/${numericId}`;
                        break;
                    case 'Spirit Licence Premises':
                        endpoint = `/spirit_licence/inspection/${numericId}`;
                        break;
                    case 'Swimming Pool':
                        endpoint = `/swimming_pool/inspection/${numericId}`;
                        break;
                    case 'Small Hotel':
                        endpoint = `/small_hotels/inspection/${numericId}`;
                        break;
                    case 'Barbershop':
                        endpoint = `/barbershop/inspection/${numericId}`;
                        break;
                    case 'Institutional Health':
                    case 'Institutional':
                        endpoint = `/institutional/inspection/${numericId}`;
                        break;
                    default:
                        console.warn(`Unknown form type: ${formType}, defaulting to food inspection`);
                        endpoint = `/inspection/${numericId}`;
                }

                console.log('Navigating to URL:', endpoint);

                // Show user feedback before navigation
                showNotification(`Opening ${formType} inspection for ${result.name}...`, 'success');

                // Navigate after a brief delay to show the notification
                setTimeout(() => {
                    window.location.href = endpoint;
                }, 500);

            } catch (error) {
                console.error('Error in search result click:', error);
                showNotification('Error opening inspection form. Please try again.', 'error');
            }

            // Close suggestions
            suggestions.classList.remove('active');

            // Clear search input
            document.getElementById('globalSearchInput').value = '';
        });

        suggestions.appendChild(item);
    });

    suggestions.classList.add('active');
}

        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;

                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');

                    // Reset statistics toggles
                    document.querySelectorAll(`.stat-toggle[data-tab="${tabId}"]`).forEach(btn => {
                        btn.classList.remove('active');
                    });

                    loadTabData(tabId);
                });
            });
        }

        function setupChartControls() {
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const chartType = this.dataset.type;
                    const tab = this.dataset.tab || 'overview';

                    this.parentElement.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    changeChartType(tab, chartType);
                });
            });

            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const timePeriod = this.dataset.time;
                    const tab = this.dataset.tab || 'overview';

                    // Remove active class from all time buttons for this tab
                    const tabSelector = tab === 'overview' ? ':not([data-tab])' : `[data-tab="${tab}"]`;
                    document.querySelectorAll(`.time-btn${tabSelector}`).forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Show timeframe information
                    showTimeframeInfo(timePeriod);

                    // Load data with new timeframe
                    loadTabData(tab, timePeriod);

                    // Show notification about pattern analysis capabilities
                    if (timePeriod === '5min' || timePeriod === '30min' || timePeriod === '1hour') {
                        showNotification(`Switched to ${timePeriod} timeframe - More candlesticks for detailed pattern analysis!`, 'info');
                    }
                });
            });
        }

        async function loadAllData() {
            console.log('Loading all inspection data...');
            loadTabData('overview');
        }

        async function loadTabData(tab, timePeriod = 'daily') {
            console.log(`Loading data for ${tab} (${timePeriod})`);

            // Handle distribution tab separately
            if (tab === 'distribution') {
                loadDistributionData();
                return;
            }

            try {
                const formType = getFormTypeForTab(tab);

                // Fetch both metrics and form scores
                const [metricsResponse, scoresResponse] = await Promise.all([
                    fetch(`/admin_metrics?form_type=${encodeURIComponent(formType)}&time_frame=${timePeriod}&t=${Date.now()}`),
                    fetch(`/admin_form_scores?form_type=${encodeURIComponent(formType)}&t=${Date.now()}`)
                ]);

                if (!metricsResponse.ok) {
                    throw new Error(`HTTP ${metricsResponse.status}: ${metricsResponse.statusText}`);
                }

                const metricsData = await metricsResponse.json();
                let scoresData = [];

                if (scoresResponse.ok) {
                    scoresData = await scoresResponse.json();
                } else {
                    console.warn('Could not fetch form scores, using dummy data');
                    scoresData = generateDummyScores();
                }

                processInspectionData(tab, metricsData, scoresData, timePeriod);

            } catch (error) {
                console.error(`Error loading data for ${tab}:`, error);
                showErrorMessage(tab, `Failed to load data: ${error.message}`);
                const dummyData = generateDummyData(timePeriod);
                const dummyScores = generateDummyScores();
                processInspectionData(tab, dummyData, dummyScores, timePeriod);
            }
        }

        function getFormTypeForTab(tab) {
            const formTypeMap = {
                'overview': 'all',
                'food': 'Food Establishment',
                'residential': 'Residential',
                'burial': 'Burial',
                'spirit_licence': 'Spirit Licence Premises',
                'swimming_pool': 'Swimming Pool',
                'small_hotels': 'Small Hotel',
                'barbershop': 'Barbershop',
                'institutional': 'Institutional Health'
            };
            return formTypeMap[tab] || 'all';
        }

        function generateDummyData(timePeriod = 'daily') {
            const dates = [];
            const pass = [];
            const fail = [];

            let dataPoints, timeIncrement, dateFormat;

            // Configure data points based on timeframe for intricate analysis
            switch (timePeriod) {
                case '5min':
                    dataPoints = 288; // 24 hours of 5-minute intervals (1440 min / 5 min)
                    timeIncrement = 5 * 60 * 1000; // 5 minutes in milliseconds
                    dateFormat = 'minute';
                    break;
                case '30min':
                    dataPoints = 336; // 7 days of 30-minute intervals (168 hours * 2)
                    timeIncrement = 30 * 60 * 1000; // 30 minutes in milliseconds
                    dateFormat = 'hour';
                    break;
                case '1hour':
                    dataPoints = 168; // 7 days of hourly data (24 * 7)
                    timeIncrement = 60 * 60 * 1000; // 1 hour in milliseconds
                    dateFormat = 'hour';
                    break;
                case 'daily':
                    dataPoints = 30; // 30 days
                    timeIncrement = 24 * 60 * 60 * 1000; // 1 day in milliseconds
                    dateFormat = 'day';
                    break;
                case 'weekly':
                    dataPoints = 52; // 52 weeks
                    timeIncrement = 7 * 24 * 60 * 60 * 1000; // 1 week in milliseconds
                    dateFormat = 'day';
                    break;
                case 'monthly':
                    dataPoints = 12; // 12 months
                    timeIncrement = 30 * 24 * 60 * 60 * 1000; // ~1 month in milliseconds
                    dateFormat = 'day';
                    break;
                default:
                    dataPoints = 30;
                    timeIncrement = 24 * 60 * 60 * 1000;
                    dateFormat = 'day';
            }

            const now = new Date();
            const startTime = new Date(now.getTime() - (dataPoints * timeIncrement));

            for (let i = 0; i < dataPoints; i++) {
                const currentTime = new Date(startTime.getTime() + (i * timeIncrement));

                // Create more realistic patterns for shorter timeframes
                let baseActivity, volatility;

                if (timePeriod === '5min' || timePeriod === '30min') {
                    // Higher frequency, more volatile data for pattern analysis
                    const hour = currentTime.getHours();

                    // Simulate business hours patterns (higher activity 8 AM - 6 PM)
                    if (hour >= 8 && hour <= 18) {
                        baseActivity = 15 + Math.sin(hour / 24 * Math.PI * 2) * 5; // Peak mid-day
                        volatility = 0.3;
                    } else {
                        baseActivity = 3 + Math.random() * 2; // Low activity off-hours
                        volatility = 0.6;
                    }

                    // Add day-of-week patterns
                    const dayOfWeek = currentTime.getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) { // Weekend
                        baseActivity *= 0.4; // Lower weekend activity
                    }

                } else if (timePeriod === '1hour') {
                    // Hourly patterns with realistic fluctuations
                    const hour = currentTime.getHours();
                    baseActivity = 8 + Math.sin((hour - 6) / 24 * Math.PI * 2) * 4;
                    volatility = 0.25;

                } else {
                    // Daily and longer timeframes
                    baseActivity = Math.random() * 15 + 5;
                    volatility = 0.2;
                }

                // Generate pass/fail counts with realistic patterns
                const totalInspections = Math.max(1, Math.round(baseActivity + (Math.random() - 0.5) * baseActivity * volatility));
                const passRate = 0.65 + (Math.random() - 0.5) * 0.3; // 50-80% pass rate with variation

                const passCount = Math.round(totalInspections * passRate);
                const failCount = totalInspections - passCount;

                dates.push(currentTime.toISOString());
                pass.push(passCount);
                fail.push(failCount);
            }

            console.log(`Generated ${dataPoints} data points for ${timePeriod} timeframe`);
            return { dates, pass, fail };
        }

        function generateDummyScores() {
            // Generate realistic inspection scores between 40-100
            const scores = [];
            for (let i = 0; i < 50; i++) {
                const baseScore = Math.random() * 60 + 40; // 40-100 range
                scores.push(Math.round(baseScore));
            }
            return scores;
        }

        function processInspectionData(tab, data, scoresData = [], timePeriod = 'daily') {
            if (!data || !data.dates || !Array.isArray(data.dates)) {
                console.warn(`Invalid data structure for ${tab}, using dummy data`);
                data = generateDummyData(timePeriod);
                scoresData = generateDummyScores();
            }

            const chartData = [];
            let totalPass = 0;
            let totalFail = 0;

            // Use totals from API if available, otherwise calculate
            if (data.total_pass !== undefined && data.total_fail !== undefined) {
                totalPass = data.total_pass;
                totalFail = data.total_fail;
                console.log(`Using API totals for ${tab}: Pass=${totalPass}, Fail=${totalFail}, Total=${totalPass + totalFail}`);
            } else {
                if (data.pass && Array.isArray(data.pass)) {
                    totalPass = data.pass.reduce((sum, count) => sum + (count || 0), 0);
                }
                if (data.fail && Array.isArray(data.fail)) {
                    totalFail = data.fail.reduce((sum, count) => sum + (count || 0), 0);
                }
                console.log(`Calculated totals for ${tab}: Pass=${totalPass}, Fail=${totalFail}, Total=${totalPass + totalFail}`);
            }

            // Enhanced candlestick generation for pattern analysis
            let previousClose = 65; // Starting baseline pass rate

            for (let i = 0; i < data.dates.length; i++) {
                const date = data.dates[i];
                const passCount = data.pass ? (data.pass[i] || 0) : 0;
                const failCount = data.fail ? (data.fail[i] || 0) : 0;
                const total = passCount + failCount;
                const currentPassRate = total > 0 ? (passCount / total) * 100 : previousClose;

                // Create realistic OHLC data for candlestick patterns
                let open, high, low, close;

                if (timePeriod === '5min' || timePeriod === '30min') {
                    // More volatile data for shorter timeframes
                    const volatility = timePeriod === '5min' ? 3 : 2;
                    open = previousClose + (Math.random() - 0.5) * volatility;
                    close = currentPassRate;

                    // Create realistic high/low with occasional spikes
                    const range = Math.abs(close - open) + volatility;
                    high = Math.max(open, close) + Math.random() * range * 0.8;
                    low = Math.min(open, close) - Math.random() * range * 0.8;

                } else if (timePeriod === '1hour') {
                    // Medium volatility for hourly data
                    const volatility = 1.5;
                    open = previousClose + (Math.random() - 0.5) * volatility;
                    close = currentPassRate;

                    const range = Math.abs(close - open) + volatility;
                    high = Math.max(open, close) + Math.random() * range * 0.6;
                    low = Math.min(open, close) - Math.random() * range * 0.6;

                } else {
                    // Lower volatility for daily+ timeframes
                    const volatility = 1;
                    open = previousClose;
                    close = currentPassRate;

                    high = Math.max(open, close) + Math.random() * volatility;
                    low = Math.min(open, close) - Math.random() * volatility;
                }

                // Ensure values stay within realistic bounds (0-100%)
                open = Math.max(0, Math.min(100, open));
                high = Math.max(0, Math.min(100, high));
                low = Math.max(0, Math.min(100, low));
                close = Math.max(0, Math.min(100, close));

                // Ensure high >= max(open, close) and low <= min(open, close)
                high = Math.max(high, open, close);
                low = Math.min(low, open, close);

                const timestamp = Math.floor(new Date(date).getTime() / 1000);

                chartData.push({
                    time: timestamp,
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: parseFloat(close.toFixed(2)),
                    value: parseFloat(close.toFixed(2))
                });

                previousClose = close;
            }

            // Calculate and store statistics
            const statistics = calculateStatistics(scoresData);
            currentStatistics[tab] = statistics;

            updateMetricsDisplay(tab, totalPass, totalFail, scoresData);
            updateChart(tab, chartData, timePeriod);
            currentData[tab] = chartData;

            console.log(`Processed ${chartData.length} candlesticks for ${tab} (${timePeriod})`);
        }

        function calculateStatistics(scores) {
            if (!scores || scores.length === 0) {
                return { mean: null, median: null, mode: null };
            }

            const validScores = scores.filter(score => !isNaN(score) && score >= 0);

            if (validScores.length === 0) {
                return { mean: null, median: null, mode: null };
            }

            return {
                mean: calculateMean(validScores),
                median: calculateMedian(validScores),
                mode: calculateMode(validScores)
            };
        }

        function updateMetricsDisplay(tab, totalPass, totalFail, scoresData = []) {
            const total = totalPass + totalFail;
            const passRate = total > 0 ? ((totalPass / total) * 100).toFixed(1) : 0;

            const suffix = tab === 'overview' ? '' : `-${tab}`;

            const passRateEl = document.getElementById(`passRate${suffix}`);
            const totalEl = document.getElementById(`totalInspections${suffix}`);
            const failedEl = document.getElementById(`failedInspections${suffix}`);
            const meanEl = document.getElementById(`meanScore${suffix}`);
            const medianEl = document.getElementById(`medianScore${suffix}`);
            const modeEl = document.getElementById(`modeScore${suffix}`);

            if (passRateEl) passRateEl.textContent = `${passRate}%`;
            if (totalEl) totalEl.textContent = total;
            if (failedEl) failedEl.textContent = totalFail;

            // Calculate statistical measures from actual form scores
            if (scoresData && scoresData.length > 0) {
                const scores = scoresData.filter(score => !isNaN(score) && score >= 0);

                if (scores.length > 0) {
                    const mean = calculateMean(scores);
                    const median = calculateMedian(scores);
                    const mode = calculateMode(scores);

                    if (meanEl) meanEl.textContent = `${mean.toFixed(1)}%`;
                    if (medianEl) medianEl.textContent = `${median.toFixed(1)}%`;
                    if (modeEl) modeEl.textContent = `${mode.toFixed(1)}%`;
                } else {
                    if (meanEl) meanEl.textContent = '0%';
                    if (medianEl) medianEl.textContent = '0%';
                    if (modeEl) modeEl.textContent = '0%';
                }
            } else {
                // Fallback to using pass rate data if no form scores available
                const currentData = getCurrentDataForTab(tab);
                if (currentData && currentData.length > 0) {
                    const scores = currentData.map(d => d.value).filter(v => !isNaN(v));

                    if (scores.length > 0) {
                        const mean = calculateMean(scores);
                        const median = calculateMedian(scores);
                        const mode = calculateMode(scores);

                        if (meanEl) meanEl.textContent = `${mean.toFixed(1)}%`;
                        if (medianEl) medianEl.textContent = `${median.toFixed(1)}%`;
                        if (modeEl) modeEl.textContent = `${mode.toFixed(1)}%`;
                    } else {
                        if (meanEl) meanEl.textContent = '0%';
                        if (medianEl) medianEl.textContent = '0%';
                        if (modeEl) modeEl.textContent = '0%';
                    }
                }
            }
        }

        function getCurrentDataForTab(tab) {
            return currentData[tab] || [];
        }

        function calculateMean(scores) {
            if (scores.length === 0) return 0;
            const sum = scores.reduce((acc, score) => acc + score, 0);
            return sum / scores.length;
        }

        function calculateMedian(scores) {
            if (scores.length === 0) return 0;
            const sorted = [...scores].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);

            if (sorted.length % 2 === 0) {
                return (sorted[mid - 1] + sorted[mid]) / 2;
            } else {
                return sorted[mid];
            }
        }

        function calculateMode(scores) {
            if (scores.length === 0) return 0;

            // Round scores to nearest whole number for mode calculation
            const roundedScores = scores.map(score => Math.round(score));

            const frequency = {};
            let maxCount = 0;
            let mode = roundedScores[0];

            roundedScores.forEach(score => {
                frequency[score] = (frequency[score] || 0) + 1;
                if (frequency[score] > maxCount) {
                    maxCount = frequency[score];
                    mode = score;
                }
            });

            return mode;
        }

        function updateChart(tab, data, timePeriod = 'daily') {
            const chartObj = charts[tab];
            if (!chartObj || !chartObj.chart) return;

            try {
                // Remove all existing series including statistics lines
                if (chartObj.series) {
                    chartObj.chart.removeSeries(chartObj.series);
                }

                // Remove all statistics lines
                Object.keys(chartObj.statisticLines).forEach(stat => {
                    if (chartObj.statisticLines[stat]) {
                        chartObj.chart.removeSeries(chartObj.statisticLines[stat]);
                        chartObj.statisticLines[stat] = null;
                    }
                });

                // Configure time scale based on timeframe for better pattern visibility
                let timeScaleOptions = {
                    borderColor: '#2a2e39',
                    timeVisible: true,
                    secondsVisible: false,
                };

                switch (timePeriod) {
                    case '5min':
                        timeScaleOptions.timeVisible = true;
                        timeScaleOptions.secondsVisible = false;
                        break;
                    case '30min':
                    case '1hour':
                        timeScaleOptions.timeVisible = true;
                        timeScaleOptions.secondsVisible = false;
                        break;
                    case 'daily':
                    case 'weekly':
                    case 'monthly':
                        timeScaleOptions.timeVisible = false;
                        timeScaleOptions.secondsVisible = false;
                        break;
                }

                chartObj.chart.applyOptions({
                    timeScale: timeScaleOptions
                });

                switch (chartObj.currentType) {
                    case 'candlestick':
                        chartObj.series = chartObj.chart.addCandlestickSeries({
                            upColor: '#26a69a',
                            downColor: '#ef5350',
                            borderVisible: false,
                            wickUpColor: '#26a69a',
                            wickDownColor: '#ef5350',
                            priceFormat: {
                                type: 'price',
                                precision: 2,
                                minMove: 0.01,
                            },
                        });
                        chartObj.series.setData(data);
                        break;

                    case 'line':
                        chartObj.series = chartObj.chart.addLineSeries({
                            color: '#26a69a',
                            lineWidth: 2,
                            priceFormat: {
                                type: 'price',
                                precision: 2,
                                minMove: 0.01,
                            },
                        });
                        const lineData = data.map(d => ({
                            time: d.time,
                            value: d.value
                        }));
                        chartObj.series.setData(lineData);
                        break;

                    case 'area':
                        chartObj.series = chartObj.chart.addAreaSeries({
                            topColor: 'rgba(38, 166, 154, 0.56)',
                            bottomColor: 'rgba(38, 166, 154, 0.04)',
                            lineColor: 'rgba(38, 166, 154, 1)',
                            lineWidth: 2,
                            priceFormat: {
                                type: 'price',
                                precision: 2,
                                minMove: 0.01,
                            },
                        });
                        const areaData = data.map(d => ({
                            time: d.time,
                            value: d.value
                        }));
                        chartObj.series.setData(areaData);
                        break;
                }

                chartObj.chart.timeScale().fitContent();

                console.log(`Chart updated with ${data.length} data points for ${timePeriod} timeframe`);
            } catch (error) {
                console.error(`Error updating chart for ${tab}:`, error);
            }
        }

        function changeChartType(tab, newType) {
            const chartObj = charts[tab];
            if (!chartObj) return;

            chartObj.currentType = newType;

            if (currentData[tab]) {
                // Get current timeframe from active button
                const activeTimeBtn = document.querySelector(`.time-btn.active[data-tab="${tab}"], .time-btn.active:not([data-tab])`);
                const currentTimeframe = activeTimeBtn ? activeTimeBtn.dataset.time : 'daily';

                updateChart(tab, currentData[tab], currentTimeframe);

                // Reapply active statistics lines
                document.querySelectorAll(`.stat-toggle[data-tab="${tab}"].active`).forEach(btn => {
                    const stat = btn.dataset.stat;
                    toggleStatisticLine(tab, stat, true);
                });
            }
        }

        // Add timeframe information tooltip
        function showTimeframeInfo(timePeriod) {
            const info = {
                '5min': 'Shows 24 hours of data with 5-minute intervals (288 candlesticks) - Perfect for intraday pattern analysis',
                '30min': 'Shows 7 days of data with 30-minute intervals (336 candlesticks) - Great for short-term trend analysis',
                '1hour': 'Shows 7 days of data with hourly intervals (168 candlesticks) - Ideal for detailed weekly patterns',
                'daily': 'Shows 30 days of daily data (30 candlesticks) - Standard daily trend analysis',
                'weekly': 'Shows 52 weeks of data (52 candlesticks) - Long-term seasonal patterns',
                'monthly': 'Shows 12 months of data (12 candlesticks) - Yearly trend analysis'
            };

            console.log(`Timeframe: ${timePeriod} - ${info[timePeriod] || 'Custom timeframe'}`);
        }

        function viewForm(formId, formType) {
            let endpoint;
            switch (formType) {
                case 'Food Establishment': endpoint = `/inspection/${formId}`; break;
                case 'Residential': endpoint = `/residential/inspection/${formId}`; break;
                case 'Burial': endpoint = `/burial/inspection/${formId}`; break;
                case 'Spirit Licence Premises': endpoint = `/spirit_licence/inspection/${formId}`; break;
                case 'Swimming Pool': endpoint = `/swimming_pool/inspection/${formId}`; break;
                case 'Small Hotel': endpoint = `/small_hotels/inspection/${formId}`; break;
                case 'Barbershop': endpoint = `/barbershop/inspection/${formId}`; break;
                case 'Institutional Health': endpoint = `/institutional/inspection/${formId}`; break;
                case 'Institutional': endpoint = `/institutional/inspection/${formId}`; break;
                case 'Meat Processing': endpoint = `/meat_processing/inspection/${formId}`; break;
                default: endpoint = `/inspection/${formId}`;
            }
            window.location.href = endpoint;
        }

        function downloadForm(formId, formType) {
            console.log(`Download form ${formId} of type ${formType}`);
        }

        function showErrorMessage(tab, message) {
            const suffix = tab === 'overview' ? '' : `-${tab}`;
            const passRateEl = document.getElementById(`passRate${suffix}`);
            const totalEl = document.getElementById(`totalInspections${suffix}`);
            const failedEl = document.getElementById(`failedInspections${suffix}`);
            const meanEl = document.getElementById(`meanScore${suffix}`);
            const medianEl = document.getElementById(`medianScore${suffix}`);
            const modeEl = document.getElementById(`modeScore${suffix}`);

            if (passRateEl) passRateEl.textContent = 'Error';
            if (totalEl) totalEl.textContent = message;
            if (failedEl) failedEl.textContent = '‚ö†Ô∏è';
            if (meanEl) meanEl.textContent = 'Error';
            if (medianEl) medianEl.textContent = 'Error';
            if (modeEl) modeEl.textContent = 'Error';
        }

        // ========================================
        // STATISTICS FUNCTIONALITY
        // ========================================
        function initializeStatisticsToggles() {
            document.querySelectorAll('.stat-toggle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const stat = this.dataset.stat;
                    const tab = this.dataset.tab;

                    this.classList.toggle('active');
                    toggleStatisticLine(tab, stat, this.classList.contains('active'));
                });
            });
        }

        function toggleStatisticLine(tab, statType, show) {
            const chartObj = charts[tab];
            if (!chartObj || !chartObj.chart) return;

            const statistics = currentStatistics[tab];
            if (!statistics) return;

            if (show) {
                // Remove existing line if any
                if (chartObj.statisticLines[statType]) {
                    chartObj.chart.removeSeries(chartObj.statisticLines[statType]);
                }

                // Add new line
                const value = statistics[statType];
                if (value !== null && !isNaN(value)) {
                    const color = getStatisticColor(statType);
                    const lineSeries = chartObj.chart.addLineSeries({
                        color: color,
                        lineWidth: 2,
                        lineStyle: 2, // Dashed line
                        priceLineVisible: true,
                        priceLineWidth: 2,
                        priceLineColor: color,
                        priceLineStyle: 2,
                        title: statType.charAt(0).toUpperCase() + statType.slice(1),
                    });

                    // Create horizontal line data
                    const lineData = [];
                    if (currentData[tab] && currentData[tab].length > 0) {
                        currentData[tab].forEach(point => {
                            lineData.push({
                                time: point.time,
                                value: value
                            });
                        });
                    }

                    lineSeries.setData(lineData);
                    chartObj.statisticLines[statType] = lineSeries;
                }
            } else {
                // Remove line
                if (chartObj.statisticLines[statType]) {
                    chartObj.chart.removeSeries(chartObj.statisticLines[statType]);
                    chartObj.statisticLines[statType] = null;
                }
            }
        }

        function getStatisticColor(statType) {
            const colors = {
                mean: '#FF6B6B',    // Red
                median: '#4ECDC4',  // Teal
                mode: '#FFE66D'     // Yellow
            };
            return colors[statType] || '#FFFFFF';
        }

        // ========================================
        // ALERT SIDEBAR FUNCTIONALITY (Option B)
        // ========================================

        // Initialize alert sidebar on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize alert sidebar
            loadAlertSidebar();

            // Load saved threshold setting
            loadGlobalThreshold();

            // Setup alert sidebar toggle
            document.getElementById('alertSidebarToggle').addEventListener('click', toggleAlertSidebar);

            // Poll for new alerts every 30 seconds
            setInterval(loadAlertSidebar, 30000);
        });

        let currentAlertFilter = 'all';
        let allAlerts = [];

        function toggleAlertSidebar() {
            const sidebar = document.getElementById('alertSidebar');
            sidebar.classList.toggle('open');

            if (sidebar.classList.contains('open')) {
                loadAlertSidebar();
                loadGlobalThreshold();
            }
        }

        function updateGlobalThreshold(value) {
            fetch('/api/admin/save_threshold', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chart_type: 'global',
                    threshold_value: parseFloat(value),
                    enabled: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Global threshold updated to:', value);
                    // Show confirmation
                    const msg = document.createElement('div');
                    msg.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #4caf50; color: white; padding: 12px 20px; border-radius: 6px; z-index: 10001;';
                    msg.textContent = `‚úì Alert threshold set to ${value}%`;
                    document.body.appendChild(msg);
                    setTimeout(() => msg.remove(), 3000);
                }
            })
            .catch(error => {
                console.error('Error updating threshold:', error);
            });
        }

        function loadGlobalThreshold() {
            fetch('/api/admin/get_thresholds')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.thresholds && data.thresholds.global) {
                    document.getElementById('globalThreshold').value = data.thresholds.global.value;
                }
            })
            .catch(error => {
                console.error('Error loading threshold:', error);
            });
        }

        function saveThresholdSetting() {
            const value = document.getElementById('globalThreshold').value;
            const statusEl = document.getElementById('thresholdSaveStatus');

            fetch('/api/admin/save_threshold', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chart_type: 'global',
                    threshold_value: parseFloat(value),
                    enabled: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Global threshold saved to:', value);

                    // Show saved status
                    statusEl.style.display = 'inline';
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);

                    // Show notification
                    showNotification(`Threshold saved: ${value}%`, 'success');
                }
            })
            .catch(error => {
                console.error('Error saving threshold:', error);
                showNotification('Failed to save threshold', 'error');
            });
        }

        function loadAlertSidebar() {
            console.log('Loading alert sidebar...');
            fetch('/api/admin/threshold_alerts/list')
                .then(response => response.json())
                .then(data => {
                    console.log('Alert data received:', data);
                    if (data.success) {
                        allAlerts = data.alerts || [];
                        console.log('Number of alerts:', allAlerts.length);
                        console.log('Alerts:', allAlerts);
                        renderAlerts(allAlerts);
                        updateAlertBadge(allAlerts.filter(a => !a.acknowledged).length);
                    } else {
                        console.error('API returned success: false');
                        showEmptyAlerts();
                    }
                })
                .catch(error => {
                    console.error('Error loading alerts:', error);
                    showEmptyAlerts();
                });
        }

        function renderAlerts(alerts) {
            const alertList = document.getElementById('sidebarAlertList');
            console.log('Rendering alerts. Element found:', !!alertList);
            console.log('Total alerts to render:', alerts ? alerts.length : 0);

            if (!alerts || alerts.length === 0) {
                console.log('No alerts - showing empty state');
                showEmptyAlerts();
                return;
            }

            // Filter alerts based on current filter
            let filteredAlerts = alerts;
            console.log('Current filter:', currentAlertFilter);

            if (currentAlertFilter === 'acknowledged') {
                filteredAlerts = alerts.filter(a => a.acknowledged);
            } else if (currentAlertFilter === 'unacknowledged') {
                filteredAlerts = alerts.filter(a => !a.acknowledged);
            } else if (currentAlertFilter !== 'all') {
                // Form type filter
                filteredAlerts = alerts.filter(a =>
                    a.form_type.toLowerCase().includes(currentAlertFilter)
                );
            }

            console.log('Filtered alerts:', filteredAlerts.length);

            if (filteredAlerts.length === 0) {
                console.log('No filtered alerts - showing empty state');
                showEmptyAlerts();
                return;
            }

            const alertsHTML = filteredAlerts.map(alert => {
                const timeAgo = getTimeAgo(alert.created_at);
                const acknowledgedClass = alert.acknowledged ? 'acknowledged' : '';

                return `
                    <div class="alert-card ${acknowledgedClass}" data-alert-id="${alert.id}">
                        <div class="alert-card-header">
                            <div class="alert-card-title">
                                ${alert.acknowledged ? '‚úì' : '‚ö†Ô∏è'} ${alert.form_type}
                            </div>
                            <div class="alert-card-time">${timeAgo}</div>
                        </div>
                        <div class="alert-card-body">
                            Inspector: <strong>${alert.inspector_name || 'Unknown'}</strong><br>
                            Score: <strong>${alert.score.toFixed(1)}%</strong> (Threshold: ${alert.threshold_value}%)
                        </div>
                        <div class="alert-card-details">
                            <span>üìã ID: ${alert.inspection_id || 'N/A'}</span>
                            ${alert.acknowledged ? `<span>‚úì By: ${alert.acknowledged_by || 'Unknown'}</span>` : ''}
                        </div>
                        ${!alert.acknowledged ? `
                            <div class="alert-card-actions">
                                <button class="alert-action-btn acknowledge" onclick="acknowledgeAlert(${alert.id})">
                                    ‚úì Acknowledge
                                </button>
                                <button class="alert-action-btn view" onclick="viewInspection(${alert.inspection_id}, '${alert.form_type}')">
                                    üëÅÔ∏è View
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            alertList.innerHTML = alertsHTML;
        }

        function showEmptyAlerts() {
            const alertList = document.getElementById('sidebarAlertList');
            if (alertList) {
                alertList.innerHTML = `
                    <div class="alert-empty">
                        <div class="alert-empty-icon">üì≠</div>
                        <div>No alerts found</div>
                    </div>
                `;
            }
        }

        function filterAlerts(filter) {
            currentAlertFilter = filter;

            // Update active button
            document.querySelectorAll('.alert-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter || btn.textContent.toLowerCase().includes(filter)) {
                    btn.classList.add('active');
                }
            });

            renderAlerts(allAlerts);
        }

        function acknowledgeAlert(alertId) {
            fetch(`/api/admin/threshold_alerts/acknowledge/${alertId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    acknowledged_by: '{{ session.get("username", "admin") }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAlertSidebar(); // Reload alerts
                }
            })
            .catch(error => {
                console.error('Error acknowledging alert:', error);
            });
        }

        function acknowledgeAllAlerts() {
            const unacknowledgedAlerts = allAlerts.filter(a => !a.acknowledged);

            if (unacknowledgedAlerts.length === 0) {
                alert('No unacknowledged alerts to acknowledge');
                return;
            }

            if (!confirm(`Acknowledge ${unacknowledgedAlerts.length} alert(s)?`)) {
                return;
            }

            Promise.all(unacknowledgedAlerts.map(alert =>
                fetch(`/api/admin/threshold_alerts/acknowledge/${alert.id}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        acknowledged_by: '{{ session.get("username", "admin") }}'
                    })
                })
            ))
            .then(() => {
                loadAlertSidebar();
            })
            .catch(error => {
                console.error('Error acknowledging all alerts:', error);
            });
        }

        function clearAcknowledgedAlerts() {
            const acknowledgedAlerts = allAlerts.filter(a => a.acknowledged);

            if (acknowledgedAlerts.length === 0) {
                alert('No acknowledged alerts to clear');
                return;
            }

            if (!confirm(`Clear ${acknowledgedAlerts.length} acknowledged alert(s)?`)) {
                return;
            }

            fetch('/api/admin/threshold_alerts/clear_acknowledged', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAlertSidebar();
                }
            })
            .catch(error => {
                console.error('Error clearing alerts:', error);
            });
        }

        function updateAlertBadge(count) {
            const badge = document.getElementById('alertSidebarBadge');
            const alertBtn = document.getElementById('alertSidebarToggle');

            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
                // Add glowing effect when there are alerts
                if (alertBtn) {
                    alertBtn.classList.add('has-alerts');
                }
            } else {
                badge.style.display = 'none';
                // Remove glowing effect when no alerts
                if (alertBtn) {
                    alertBtn.classList.remove('has-alerts');
                }
            }
        }

        function viewInspection(inspectionId, formType) {
            // Use existing viewForm function
            viewForm(inspectionId, formType);
        }

        function getTimeAgo(timestamp) {
            const now = new Date();
            const alertTime = new Date(timestamp);
            const diffMs = now - alertTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${diffDays}d ago`;
        }

        // ========================================
        // ADMIN TOOLS FUNCTIONALITY
        // ========================================

        function initializeAdminTools() {
    // Admin Tools Toggle
    document.getElementById('adminToolsButton').addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent event bubbling
        const container = document.getElementById('adminToolsContainer');
        container.classList.toggle('open');
    });

    // Close admin tools when clicking outside
    document.addEventListener('click', function(e) {
        const adminToolsButton = document.getElementById('adminToolsButton');
        const adminToolsContainer = document.getElementById('adminToolsContainer');

        if (!adminToolsButton.contains(e.target) && !adminToolsContainer.contains(e.target)) {
            adminToolsContainer.classList.remove('open');
        }
    });

    // Load initial alerts
    loadAlerts();
}

        // ========================================
        // FORM CREATION FUNCTIONALITY
        // ========================================

        function toggleFormCreator() {
            const dropdown = document.getElementById('formDropdown');
            dropdown.classList.toggle('open');
        }

        function createForm(formUrl) {
            // Close the dropdown
            document.getElementById('formDropdown').classList.remove('open');

            // Navigate to the form creation page
            window.location.href = formUrl;
        }

        // Close modals when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('open');
    }

    // Close admin tools container when clicking outside
    const adminToolsButton = document.getElementById('adminToolsButton');
    const adminToolsContainer = document.getElementById('adminToolsContainer');

    if (adminToolsContainer && adminToolsContainer.classList.contains('open') &&
        !adminToolsButton.contains(e.target) &&
        !adminToolsContainer.contains(e.target)) {
        adminToolsContainer.classList.remove('open');
    }
});

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(`${modalId}_modal`);
            if (modal) {
                modal.classList.add('open');

                // Load data based on modal type
                switch(modalId) {
                    case 'active_users':
                        loadActiveUsers();
                        break;
                    case 'audit_log':
                        loadAuditLog();
                        break;
                    case 'inspector_performance':
                        loadInspectorPerformance();
                        break;
                    case 'alerts':
                        loadSystemAlerts();
                        break;
                    case 'inspection_map':
                        loadInspectionMap();
                        break;
                    case 'user_management':
                        loadUsers();
                        break;
                    case 'system_health':
                        loadSystemHealth();
                        break;
                    case 'task_assignment':
                        loadTasks();
                        break;
                    case 'security_metrics':
                        loadSecurityMetrics();
                        break;
                    case 'inspector_dashboard_view':
                        // Refresh the iframe to ensure latest data
                        document.getElementById('inspectorDashboardFrame').src = '/dashboard?t=' + Date.now();
                        break;
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(`${modalId}_modal`);
            if (modal) {
                modal.classList.remove('open');
            }
        }

        // New Task Functions
        function openNewTaskForm() {
            const modal = document.getElementById('newTaskModal');
            if (modal) {
                modal.classList.add('open');
                // Set default due date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const formattedDate = tomorrow.toISOString().slice(0, 16);
                document.getElementById('taskDueDate').value = formattedDate;

                // Load inspectors dynamically
                loadInspectorsForTaskForm();
            }
        }

        async function loadInspectorsForTaskForm() {
            try {
                console.log('Loading users for task form...');
                const response = await fetch('/api/admin/users');

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const users = await response.json();
                console.log('Loaded users:', users);

                const assigneeSelect = document.getElementById('taskAssignee');
                // Clear existing options except first one
                assigneeSelect.innerHTML = '<option value="">Select User...</option>';

                if (!Array.isArray(users) || users.length === 0) {
                    console.warn('No users returned from API');
                    assigneeSelect.innerHTML += '<option value="">No users available</option>';
                    return;
                }

                // Group users by role for better organization
                const usersByRole = {};
                users.forEach(user => {
                    if (!usersByRole[user.role]) {
                        usersByRole[user.role] = [];
                    }
                    usersByRole[user.role].push(user);
                });

                console.log('Users grouped by role:', usersByRole);

                // Add users organized by role
                Object.keys(usersByRole).sort().forEach(role => {
                    // Add role header
                    const roleHeader = document.createElement('optgroup');
                    roleHeader.label = role.charAt(0).toUpperCase() + role.slice(1) + 's';
                    assigneeSelect.appendChild(roleHeader);

                    // Add users for this role
                    usersByRole[role].forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = `${user.username} (${user.email})`;
                        roleHeader.appendChild(option);
                    });
                });

                // Add "All Users" option at the end
                const allOption = document.createElement('option');
                allOption.value = 'all';
                allOption.textContent = 'All Users';
                allOption.style.fontWeight = 'bold';
                assigneeSelect.appendChild(allOption);

                console.log('Successfully populated dropdown with', users.length, 'users');

            } catch (error) {
                console.error('Error loading users:', error);
                // Fallback to basic options if API fails
                const assigneeSelect = document.getElementById('taskAssignee');
                assigneeSelect.innerHTML = `
                    <option value="">Select User...</option>
                    <option value="all">All Users</option>
                    <option value="">Error loading users - check console</option>
                `;
            }
        }

        function closeNewTaskForm() {
            const modal = document.getElementById('newTaskModal');
            if (modal) {
                modal.classList.remove('open');
                document.getElementById('newTaskForm').reset();
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('open');
            }
        });

        // Admin Tools API Functions
        async function loadActiveUsers() {
            try {
                const response = await fetch('/api/admin/login_history');
                const users = await response.json();

                const tbody = document.querySelector('#activeUsersTable tbody');
                tbody.innerHTML = '';

                // Show recent logins as "active users"
                users.slice(0, 10).forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.login_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.login_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.ip_address || 'Unknown'}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading active users:', error);
                showNotification('Failed to load active users', 'error');
            }
        }

        async function loadAuditLog() {
            try {
                const response = await fetch('/api/admin/audit_log');
                const logs = await response.json();

                const tbody = document.querySelector('#auditLogTable tbody');
                tbody.innerHTML = '';

                logs.forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${log.timestamp}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.user}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.action}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.details || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${log.ip_address || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading audit log:', error);
                showNotification('Failed to load audit log', 'error');
            }
        }

        async function loadInspectorPerformance() {
            try {
                const response = await fetch('/api/admin/inspector_performance');
                const data = await response.json();

                const tbody = document.querySelector('#performanceTable tbody');
                tbody.innerHTML = '';

                data.inspectors.forEach(inspector => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${inspector.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${inspector.completed}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${inspector.pass_rate}%</td>
                        <td class="px-6 py-4 whitespace-nowrap">${inspector.avg_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">
                                Good
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading inspector performance:', error);
                showNotification('Failed to load performance data', 'error');
            }
        }

        async function loadSystemAlerts() {
            try {
                const response = await fetch('/api/admin/alerts');
                const alerts = await response.json();

                const container = document.getElementById('alertsContainer');
                container.innerHTML = '';

                alerts.forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `p-4 rounded-lg border-l-4 ${
                        alert.severity === 'critical' ? 'bg-red-50 border-red-500' :
                        alert.severity === 'warning' ? 'bg-yellow-50 border-yellow-500' :
                        'bg-blue-50 border-blue-500'
                    }`;

                    alertDiv.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">${alert.title}</h4>
                                <p class="text-gray-600 mt-1">${alert.description}</p>
                                <p class="text-sm text-gray-500 mt-2">${alert.timestamp}</p>
                            </div>
                        </div>
                    `;

                    container.appendChild(alertDiv);
                });
            } catch (error) {
                console.error('Error loading alerts:', error);
                showNotification('Failed to load alerts', 'error');
            }
        }

        async function loadInspectionMap() {
            try {
                // Initialize map if not already done
                if (!window.inspectionMap) {
                    window.inspectionMap = L.map('map').setView([18.1096, -77.2975], 10);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(window.inspectionMap);
                }

                // Clear existing markers
                window.inspectionMap.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        window.inspectionMap.removeLayer(layer);
                    }
                });

                // Fetch real logged-in users from API
                const response = await fetch('/api/admin/active_users_map');
                const data = await response.json();

                console.log(`[Inspection Map] Loaded ${data.count} active users`);

                // Add marker for each logged-in user
                data.users.forEach(user => {
                    // Different colors for different roles
                    const roleColors = {
                        'inspector': '#4CAF50',
                        'admin': '#2196F3',
                        'medical_officer': '#FF9800'
                    };
                    const color = roleColors[user.role] || '#757575';

                    // Create custom icon with user indicator
                    const icon = L.divIcon({
                        className: 'user-marker',
                        html: `<div style="background:${color};color:white;padding:8px;border-radius:50%;width:40px;height:40px;text-align:center;line-height:24px;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);font-size:18px;">üë§</div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    });

                    // Add marker with popup
                    L.marker([user.lat, user.lng], {icon: icon})
                        .bindPopup(`
                            <div style="min-width:150px;">
                                <strong style="font-size:14px;">${user.username}</strong><br>
                                <span style="color:#666;">Role:</span> <strong>${user.role.replace('_', ' ').toUpperCase()}</strong><br>
                                <span style="color:#666;">Parish:</span> ${user.parish}<br>
                                <span style="color:#666;">Login:</span> ${new Date(user.login_time).toLocaleTimeString()}<br>
                                <span style="color:#666;">Last Active:</span> ${new Date(user.last_activity).toLocaleTimeString()}
                            </div>
                        `)
                        .addTo(window.inspectionMap);
                });

                // Show notification if no users are active
                if (data.count === 0) {
                    console.log('[Inspection Map] No active users to display');
                }

                // Auto-refresh map every 60 seconds to show updated user positions
                setTimeout(loadInspectionMap, 60000);

            } catch (error) {
                console.error('Error loading inspection map:', error);
                showNotification('Failed to load map data', 'error');
            }
        }

        async function loadUsers() {
            try {
                // Add cache-busting timestamp to prevent stale data
                const timestamp = new Date().getTime();
                const response = await fetch(`/api/admin/users?_t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const users = await response.json();

                console.log(`[User Management] Loaded ${users.length} users from database`);

                // Update user count badge
                const countBadge = document.getElementById('userCountBadge');
                if (countBadge) {
                    countBadge.textContent = `(${users.length} total users)`;
                }

                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No users found</td></tr>';
                    if (countBadge) countBadge.textContent = '(0 users)';
                    return;
                }

                users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${user.username}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${user.email || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">
                                ${user.role}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded ${user.is_flagged ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
                                ${user.is_flagged ? 'Flagged' : 'Active'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="toggleUserFlag(${user.id}, ${!user.is_flagged})" class="text-${user.is_flagged ? 'green' : 'red'}-600 hover:text-${user.is_flagged ? 'green' : 'red'}-900 mr-2">
                                ${user.is_flagged ? 'Unflag' : 'Flag'}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                console.log(`[User Management] Displayed ${users.length} users in table`);
            } catch (error) {
                console.error('Error loading users:', error);
                showNotification('Failed to load users', 'error');
            }
        }

        async function loadSystemHealth() {
            try {
                const response = await fetch('/api/admin/system_health');
                const health = await response.json();

                document.getElementById('uptimeValue').textContent = `${health.uptime}%`;
                document.getElementById('responseValue').textContent = `${health.db_response}ms`;
                document.getElementById('errorValue').textContent = `${health.error_rate}%`;

                const tbody = document.getElementById('healthTableBody');
                tbody.innerHTML = '';

                // Sample services
                const services = [
                    { name: 'Database', status: 'healthy', response_time: health.db_response, last_check: new Date().toLocaleString() },
                    { name: 'Web Server', status: 'healthy', response_time: '25ms', last_check: new Date().toLocaleString() },
                    { name: 'File Storage', status: 'healthy', response_time: '15ms', last_check: new Date().toLocaleString() }
                ];

                services.forEach(service => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${service.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">
                                ${service.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${service.response_time}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${service.last_check}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading system health:', error);
                showNotification('Failed to load system health', 'error');
            }
        }

        async function loadTasks() {
            try {
                const response = await fetch('/api/admin/tasks');
                const tasks = await response.json();

                const tbody = document.querySelector('#tasksTable tbody');
                tbody.innerHTML = '';

                tasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${task.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${task.assignee}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-800">
                                Medium
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${task.due_date}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">
                                ${task.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button onclick="editTask(${task.id})" class="text-blue-600 hover:text-blue-900 mr-2">Edit</button>
                            <button onclick="deleteTask(${task.id})" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading tasks:', error);
                showNotification('Failed to load tasks', 'error');
            }
        }

        async function loadSecurityMetrics() {
            try {
                const response = await fetch('/api/admin/security_metrics');
                const metrics = await response.json();

                document.getElementById('mfaAdoption').textContent = `${Math.round((metrics.mfa_enabled / (metrics.mfa_enabled + metrics.mfa_disabled)) * 100)}%`;
                document.getElementById('securityEvents').textContent = metrics.events.length;

                const tbody = document.querySelector('#securityEventsTable tbody');
                tbody.innerHTML = '';

                metrics.events.forEach(event => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${event.timestamp}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${event.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${event.user}</td>
                        <td class="px-6 py-4 whitespace-nowrap">N/A</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">
                                Success
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading security metrics:', error);
                showNotification('Failed to load security metrics', 'error');
            }
        }

        // Alert Functions
        async function loadAlerts() {
            try {
                const response = await fetch('/api/admin/alerts');
                const alerts = await response.json();

                const alertList = document.getElementById('alertList');
                if (!alertList) return;

                alertList.innerHTML = '';

                if (alerts.length === 0) {
                    alertList.innerHTML = '<p class="text-gray-500">No recent alerts</p>';
                    document.getElementById('alertBadge').style.display = 'none';
                    return;
                }

                alerts.slice(0, 5).forEach(alert => {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert-item ${alert.severity}`;
                    alertDiv.innerHTML = `
                        <h4 class="font-semibold">${alert.title}</h4>
                        <p class="text-sm">${alert.description}</p>
                        <p class="text-xs text-gray-500">${alert.timestamp}</p>
                    `;
                    alertList.appendChild(alertDiv);
                });

                const badge = document.getElementById('alertBadge');
                if (alerts.length > 0) {
                    badge.textContent = alerts.length;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }

        // Toggle alert bell dropdown
        document.getElementById('alertBell').addEventListener('click', function() {
            const dropdown = document.getElementById('alertDropdown');
            dropdown.classList.toggle('open');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const alertBell = document.getElementById('alertBell');
            const dropdown = document.getElementById('alertDropdown');

            if (!alertBell.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        // Utility Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-black' :
                'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                max-width: 350px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                background: ${type === 'success' ? 'linear-gradient(135deg, #28a745, #20c997)' :
                           type === 'error' ? 'linear-gradient(135deg, #dc3545, #e83e8c)' :
                           type === 'warning' ? 'linear-gradient(135deg, #ffc107, #fd7e14)' :
                           'linear-gradient(135deg, #007bff, #6610f2)'};
                animation: slideInNotification 0.3s ease-out;
            `;

            // Add slide-in animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInNotification {
                    from {
                        opacity: 0;
                        transform: translateX(100%);
                    }
                    to {
                        opacity: 1;
                        transform: translateX(0);
                    }
                }
            `;
            document.head.appendChild(style);

            document.body.appendChild(notification);

            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideInNotification 0.3s ease-out reverse';
                setTimeout(() => {
                    notification.remove();
                    style.remove();
                }, 300);
            }, 5000);
        }

        function showComingSoon(feature) {
            showNotification(`${feature} feature coming soon!`, 'info');
        }

        // Placeholder functions for user management
        function editUser(userId) {
            showNotification('Edit user functionality coming soon', 'info');
        }

        function toggleUserFlag(userId, flagStatus) {
            showNotification(`User ${flagStatus ? 'flagged' : 'unflagged'} successfully`, 'success');
        }

        function editTask(taskId) {
            showNotification('Edit task functionality coming soon', 'info');
        }

        function deleteTask(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                showNotification('Task deleted successfully', 'success');
            }
        }

        function searchAuditLog() {
            showNotification('Audit log search functionality working', 'success');
        }

        function markAllAlertsRead() {
            showNotification('All alerts marked as read', 'success');
        }

        function updateInspectionMap() {
            showNotification('Map updated with current filters', 'success');
        }

        // Comprehensive Dashboard Functions
        function generateDashboard() {
            const inspectionType = document.getElementById('reportInspectionType').value;
            const timeframe = document.getElementById('reportTimeframe').value;

            let startDate, endDate;
            if (timeframe === 'custom') {
                startDate = document.getElementById('startDate').value;
                endDate = document.getElementById('endDate').value;
                if (!startDate || !endDate) {
                    showNotification('Please select both start and end dates for custom range', 'error');
                    return;
                }
            } else {
                const days = parseInt(timeframe);
                endDate = new Date().toISOString().split('T')[0];
                startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            }

            // Show loading state
            document.getElementById('dashboardInitial').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'none';
            document.getElementById('dashboardLoading').style.display = 'block';

            // Generate all dashboard data
            Promise.all([
                generateSummaryData(inspectionType, startDate, endDate),
                generateTrendData(inspectionType, startDate, endDate),
                generateInspectorData(inspectionType, startDate, endDate),
                generateScoresData(inspectionType, startDate, endDate),
                generateMonthlyData(inspectionType, startDate, endDate),
                generateEstablishmentData(inspectionType, startDate, endDate)
            ])
            .then(([summary, trend, inspector, scores, monthly, establishment]) => {
                displayDashboard(summary, trend, inspector, scores, monthly, establishment);
                document.getElementById('downloadDashboardBtn').disabled = false;
                window.currentDashboardData = {summary, trend, inspector, scores, monthly, establishment, inspectionType, startDate, endDate};
            })
            .catch(error => {
                console.error('Dashboard generation error:', error);
                showNotification('Error generating dashboard: ' + error.message, 'error');
                document.getElementById('dashboardLoading').style.display = 'none';
                document.getElementById('dashboardInitial').style.display = 'block';
            });
        }

        // Generate individual data sections
        function generateSummaryData(inspectionType, startDate, endDate) {
            return fetch('/api/admin/generate_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reportType: 'basic_summary',
                    inspectionType,
                    startDate,
                    endDate
                })
            }).then(response => response.json());
        }

        function generateTrendData(inspectionType, startDate, endDate) {
            return fetch('/api/admin/generate_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reportType: 'trend_analysis',
                    inspectionType,
                    startDate,
                    endDate
                })
            }).then(response => response.json());
        }

        function generateInspectorData(inspectionType, startDate, endDate) {
            return fetch('/api/admin/generate_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reportType: 'inspector_performance',
                    inspectionType,
                    startDate,
                    endDate
                })
            }).then(response => response.json());
        }

        function generateScoresData(inspectionType, startDate, endDate) {
            // This will use a new endpoint for scores by type
            return fetch('/api/admin/generate_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reportType: 'scores_by_type',
                    inspectionType,
                    startDate,
                    endDate
                })
            }).then(response => response.json());
        }

        function generateMonthlyData(inspectionType, startDate, endDate) {
            return fetch('/api/admin/generate_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reportType: 'monthly_trends',
                    inspectionType,
                    startDate,
                    endDate
                })
            }).then(response => response.json());
        }

        function generateEstablishmentData(inspectionType, startDate, endDate) {
            return fetch('/api/admin/generate_report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    reportType: 'establishment_ranking',
                    inspectionType,
                    startDate,
                    endDate
                })
            }).then(response => response.json());
        }

        // Dashboard Display Functions
        function displayDashboard(summary, trend, inspector, scores, monthly, establishment) {
            // Hide loading, show content
            document.getElementById('dashboardLoading').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';

            // Display summary cards
            displaySummaryCards(summary.report);

            // Display charts
            displayTrendChart(trend.report);
            displayInspectorChart(inspector.report);
            displayScoresChart(scores.report);
            displayMonthlyChart(monthly.report);
            displayEstablishmentChart(establishment.report);

            showNotification('Analytics dashboard generated successfully!', 'success');
        }

        function displaySummaryCards(summaryData) {
            const container = document.getElementById('summaryCards');
            const summary = summaryData.summary || {};

            container.innerHTML = `
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold">${summary.total_inspections || 0}</div>
                    <div class="text-sm opacity-90">Total Inspections</div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold">${summary.pass_percentage || 0}%</div>
                    <div class="text-sm opacity-90">Pass Rate</div>
                </div>
                <div class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold">${summary.failed_inspections || 0}</div>
                    <div class="text-sm opacity-90">Failed</div>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold">${summary.average_daily_inspections || 0}</div>
                    <div class="text-sm opacity-90">Daily Average</div>
                </div>
            `;
        }

        function displayTrendChart(trendData) {
            const container = document.getElementById('trendChart');
            const weeklyData = trendData.weekly_data || [];

            if (weeklyData.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No trend data available</div>';
                return;
            }

            // Simple chart using CSS and HTML
            const maxTotal = Math.max(...weeklyData.map(d => d.total));
            let chartHTML = '<div class="space-y-2">';

            weeklyData.slice(0, 8).forEach(week => {
                const barWidth = maxTotal > 0 ? (week.total / maxTotal * 100) : 0;
                const failureRate = week.failure_rate || 0;

                chartHTML += `
                    <div class="flex items-center space-x-2 text-xs">
                        <div class="w-16 text-right">${week.week}</div>
                        <div class="flex-1 bg-gray-200 rounded h-4 relative">
                            <div class="bg-blue-500 h-full rounded" style="width: ${barWidth}%"></div>
                            <div class="absolute right-1 top-0 text-white text-xs leading-4">${week.total}</div>
                        </div>
                        <div class="w-12 text-red-600">${failureRate}%</div>
                    </div>
                `;
            });
            chartHTML += '</div>';

            container.innerHTML = chartHTML;
        }

        function displayInspectorChart(inspectorData) {
            const container = document.getElementById('inspectorChart');
            const performance = inspectorData.inspector_performance || [];

            if (performance.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No inspector data available</div>';
                return;
            }

            const maxInspections = Math.max(...performance.map(p => p.total_inspections));
            let chartHTML = '<div class="space-y-2">';

            performance.slice(0, 6).forEach(perf => {
                const barWidth = maxInspections > 0 ? (perf.total_inspections / maxInspections * 100) : 0;
                const passRateColor = perf.pass_rate >= 80 ? 'bg-green-500' : perf.pass_rate >= 60 ? 'bg-yellow-500' : 'bg-red-500';

                chartHTML += `
                    <div class="flex items-center space-x-2 text-xs">
                        <div class="w-20 text-right truncate" title="${perf.inspector}">${perf.inspector}</div>
                        <div class="flex-1 bg-gray-200 rounded h-5 relative">
                            <div class="${passRateColor} h-full rounded" style="width: ${barWidth}%"></div>
                            <div class="absolute right-1 top-0 text-white text-xs leading-5">${perf.total_inspections}</div>
                        </div>
                        <div class="w-12 font-semibold">${perf.pass_rate}%</div>
                    </div>
                `;
            });
            chartHTML += '</div>';

            container.innerHTML = chartHTML;
        }

        function displayScoresChart(scoresData) {
            const container = document.getElementById('scoresChart');

            if (!scoresData || !scoresData.scores_by_type || scoresData.scores_by_type.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No scores data available</div>';
                return;
            }

            let chartHTML = '<div class="space-y-3">';
            scoresData.scores_by_type.forEach((item, index) => {
                const barWidth = typeof item.avg_score === 'number' ? (item.avg_score / 100) * 100 : 0;
                const color = typeof item.avg_score === 'number' && item.avg_score >= 70 ? 'bg-green-500' : 'bg-red-500';

                chartHTML += `
                    <div class="flex items-center justify-between">
                        <div class="w-24 text-sm font-medium">${item.type}</div>
                        <div class="flex-1 mx-4">
                            <div class="w-full bg-gray-200 rounded-full h-6">
                                <div class="${color} h-6 rounded-full flex items-center justify-center text-white text-xs font-bold"
                                     style="width: ${barWidth}%">
                                    ${typeof item.avg_score === 'number' ? item.avg_score.toFixed(1) : item.avg_score}
                                </div>
                            </div>
                        </div>
                        <div class="w-16 text-sm text-gray-600">${item.count} inspections</div>
                    </div>
                `;
            });
            chartHTML += '</div>';

            container.innerHTML = chartHTML;
        }

        function displayMonthlyChart(monthlyData) {
            const container = document.getElementById('monthlyChart');

            if (!monthlyData || !monthlyData.monthly_trends || monthlyData.monthly_trends.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No monthly data available</div>';
                return;
            }

            const maxValue = Math.max(...monthlyData.monthly_trends.map(m => m.total));

            let chartHTML = '<div class="space-y-2">';
            monthlyData.monthly_trends.forEach((month, index) => {
                const totalHeight = (month.total / maxValue) * 100;
                const passedHeight = (month.passed / maxValue) * 100;
                const failedHeight = (month.failed / maxValue) * 100;

                chartHTML += `
                    <div class="flex items-end justify-between">
                        <div class="w-16 text-xs font-medium">${month.month}</div>
                        <div class="flex-1 mx-2 flex items-end justify-center">
                            <div class="relative w-8 bg-gray-200 rounded-t" style="height: ${Math.max(totalHeight, 20)}px;">
                                <div class="absolute bottom-0 w-full bg-green-500 rounded-t"
                                     style="height: ${passedHeight}px;"
                                     title="Passed: ${month.passed}"></div>
                                <div class="absolute bottom-0 w-full bg-red-500 rounded-t"
                                     style="height: ${failedHeight}px; margin-left: ${passedHeight > 0 ? '0' : '0'}px"
                                     title="Failed: ${month.failed}"></div>
                            </div>
                        </div>
                        <div class="w-16 text-xs text-gray-600">
                            <div>${month.total}</div>
                            <div class="text-green-600">${month.pass_rate}%</div>
                        </div>
                    </div>
                `;
            });
            chartHTML += '</div>';

            container.innerHTML = chartHTML;
        }

        function displayEstablishmentChart(establishmentData) {
            const container = document.getElementById('establishmentChart');

            if (!establishmentData || (!establishmentData.top_performers && !establishmentData.worst_performers)) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">No establishment data available</div>';
                return;
            }

            let chartHTML = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';

            // Top Performers
            if (establishmentData.top_performers && establishmentData.top_performers.length > 0) {
                chartHTML += `
                    <div>
                        <h4 class="text-sm font-bold text-green-700 mb-2">üèÜ Top Performers</h4>
                        <div class="space-y-1">
                `;

                establishmentData.top_performers.slice(0, 5).forEach((est, index) => {
                    chartHTML += `
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex-1 truncate">
                                <div class="font-medium">${est.establishment}</div>
                                <div class="text-gray-500">${est.type}</div>
                            </div>
                            <div class="w-12 text-right">
                                <div class="text-green-600 font-bold">${est.avg_score}</div>
                                <div class="text-gray-500">${est.inspection_count} insp.</div>
                            </div>
                        </div>
                    `;
                });

                chartHTML += '</div></div>';
            }

            // Worst Performers
            if (establishmentData.worst_performers && establishmentData.worst_performers.length > 0) {
                chartHTML += `
                    <div>
                        <h4 class="text-sm font-bold text-red-700 mb-2">‚ö†Ô∏è Needs Improvement</h4>
                        <div class="space-y-1">
                `;

                establishmentData.worst_performers.slice(0, 5).forEach((est, index) => {
                    chartHTML += `
                        <div class="flex items-center justify-between text-xs">
                            <div class="flex-1 truncate">
                                <div class="font-medium">${est.establishment}</div>
                                <div class="text-gray-500">${est.type}</div>
                            </div>
                            <div class="w-12 text-right">
                                <div class="text-red-600 font-bold">${est.avg_score}</div>
                                <div class="text-gray-500">${est.inspection_count} insp.</div>
                            </div>
                        </div>
                    `;
                });

                chartHTML += '</div></div>';
            }

            chartHTML += '</div>';

            container.innerHTML = chartHTML;
        }

        function downloadDashboardPDF() {
            if (!window.currentDashboardData) {
                showNotification('Please generate dashboard first', 'error');
                return;
            }

            const data = window.currentDashboardData;
            const params = new URLSearchParams({
                reportType: 'dashboard_pdf',
                inspectionType: data.inspectionType,
                startDate: data.startDate,
                endDate: data.endDate,
                format: 'pdf'
            });

            const url = `/api/admin/download_report?${params.toString()}`;
            const link = document.createElement('a');
            link.href = url;
            link.download = `inspection_dashboard_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('üì• Dashboard PDF download started!', 'success');
        }

        // NEW: Generate Custom Report Function
        function generateCustomReport() {
            const reportType = document.getElementById('reportType').value;
            const inspectionType = document.getElementById('reportInspectionType').value;
            const timeframe = document.getElementById('reportTimeframe').value;

            let startDate, endDate;
            const today = new Date();

            if (timeframe === 'custom') {
                startDate = document.getElementById('startDate').value;
                endDate = document.getElementById('endDate').value;

                if (!startDate || !endDate) {
                    showNotification('Please select both start and end dates', 'error');
                    return;
                }
            } else if (timeframe === 'all') {
                startDate = '2020-01-01';
                endDate = today.toISOString().split('T')[0];
            } else {
                const daysAgo = parseInt(timeframe);
                const startDateObj = new Date();
                startDateObj.setDate(today.getDate() - daysAgo);
                startDate = startDateObj.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
            }

            // Show loading state
            document.getElementById('dashboardInitial').style.display = 'none';
            document.getElementById('reportContent').style.display = 'none';
            document.getElementById('dashboardLoading').style.display = 'block';

            // Store current report parameters
            window.currentReportParams = {
                reportType,
                inspectionType,
                startDate,
                endDate
            };

            // Fetch report data
            fetch('/api/admin/generate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    report_type: reportType,
                    inspection_type: inspectionType,
                    start_date: startDate,
                    end_date: endDate
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('dashboardLoading').style.display = 'none';

                if (data.success) {
                    displayReport(data.report, reportType);
                    // Enable export buttons
                    document.getElementById('exportPDFBtn').disabled = false;
                    document.getElementById('exportCSVBtn').disabled = false;
                    showNotification('Report generated successfully!', 'success');
                } else {
                    document.getElementById('dashboardInitial').style.display = 'block';
                    showNotification('Error generating report: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                document.getElementById('dashboardLoading').style.display = 'none';
                document.getElementById('dashboardInitial').style.display = 'block';
                showNotification('Error generating report: ' + error.message, 'error');
            });
        }

        // Display report in the UI
        function displayReport(reportData, reportType) {
            const reportContent = document.getElementById('reportContent');
            const reportTitle = document.getElementById('reportTitle');
            const reportSubtitle = document.getElementById('reportSubtitle');
            const reportBody = document.getElementById('reportBody');

            // Set title
            const reportTitles = {
                'comprehensive': 'üìä Comprehensive Dashboard',
                'basic_summary': 'üìÑ Executive Summary Report',
                'trend_analysis': 'üìà Trend Analysis Report',
                'failure_breakdown': '‚ùå Failure Breakdown Analysis',
                'inspector_performance': 'üë§ Inspector Performance Report',
                'scores_by_type': 'üéØ Scores by Inspection Type',
                'monthly_trends': 'üìÖ Monthly Trends Analysis',
                'establishment_ranking': 'üèÜ Establishment Rankings',
                'parish_analysis': 'üó∫Ô∏è Parish-Level Analysis'
            };

            reportTitle.textContent = reportTitles[reportType] || 'Inspection Report';
            reportSubtitle.textContent = `${reportData.title || ''} | Period: ${window.currentReportParams.startDate} to ${window.currentReportParams.endDate}`;

            // Build report body HTML
            let html = '';

            // Summary cards
            if (reportData.summary) {
                html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">';
                const summary = reportData.summary;

                html += `
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div class="text-sm text-blue-600 font-medium">Total Inspections</div>
                        <div class="text-3xl font-bold text-blue-900">${summary.total_inspections || 0}</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <div class="text-sm text-green-600 font-medium">Passed</div>
                        <div class="text-3xl font-bold text-green-900">${summary.passed_inspections || 0}</div>
                        <div class="text-xs text-green-600">${summary.pass_percentage || 0}%</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                        <div class="text-sm text-red-600 font-medium">Failed</div>
                        <div class="text-3xl font-bold text-red-900">${summary.failed_inspections || 0}</div>
                        <div class="text-xs text-red-600">${summary.fail_percentage || 0}%</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <div class="text-sm text-purple-600 font-medium">Avg Score</div>
                        <div class="text-3xl font-bold text-purple-900">${summary.average_score || 0}%</div>
                    </div>
                `;
                html += '</div>';
            }

            // Trend Data Chart
            if (reportData.trend_data && reportData.trend_data.length > 0) {
                html += '<div class="mb-6"><h4 class="text-lg font-bold mb-3">üìà Pass/Fail Trend Over Time</h4>';
                html += '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Date</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Total</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Passed</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Failed</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Pass Rate</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Avg Score</th>';
                html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

                reportData.trend_data.slice(0, 30).forEach(day => {
                    html += `<tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">${day.date}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-semibold">${day.total}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-green-600">${day.passed}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-red-600">${day.failed}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium">${day.pass_rate}%</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">${day.avg_score}%</td>
                    </tr>`;
                });
                html += '</tbody></table></div></div>';
            }

            // Top Inspectors with Perfect Scores
            if (reportData.top_inspectors) {
                html += '<div class="mb-6"><h4 class="text-lg font-bold mb-3">üèÜ Top Performing Inspectors</h4>';
                html += '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Inspector</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Total</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Perfect Scores</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Avg Overall</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Avg Critical</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Pass Rate</th>';
                html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

                reportData.top_inspectors.forEach((inspector, idx) => {
                    const rowClass = inspector.perfect_scores > 0 ? 'bg-yellow-50' : '';
                    html += `<tr class="${rowClass}">
                        <td class="px-4 py-2 whitespace-nowrap font-medium">${inspector.name}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${inspector.total_inspections}</td>
                        <td class="px-4 py-2 whitespace-nowrap ${inspector.perfect_scores > 0 ? 'text-green-600 font-bold' : ''}">${inspector.perfect_scores} ${inspector.perfect_scores > 0 ? '‚≠ê' : ''}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${inspector.avg_overall_score}%</td>
                        <td class="px-4 py-2 whitespace-nowrap">${inspector.avg_critical_score}%</td>
                        <td class="px-4 py-2 whitespace-nowrap font-medium">${inspector.pass_rate}%</td>
                    </tr>`;
                });
                html += '</tbody></table></div></div>';
            }

            // Most Failed Checklist Items
            if (reportData.common_failures && reportData.common_failures.length > 0) {
                html += '<div class="mb-6"><h4 class="text-lg font-bold mb-3">‚ùå Most Failed Checklist Items</h4>';
                html += '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Item ID</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Form Type</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Total Checks</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Failures</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Failure Rate</th>';
                html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

                reportData.common_failures.forEach(failure => {
                    const severity = failure.failure_rate > 50 ? 'bg-red-50' : failure.failure_rate > 25 ? 'bg-yellow-50' : '';
                    html += `<tr class="${severity}">
                        <td class="px-4 py-2 whitespace-nowrap font-mono">${failure.item_id}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm">${failure.form_type}</td>
                        <td class="px-4 py-2 whitespace-nowrap">${failure.total_checks}</td>
                        <td class="px-4 py-2 whitespace-nowrap font-bold text-red-600">${failure.failure_count}</td>
                        <td class="px-4 py-2 whitespace-nowrap font-medium">${failure.failure_rate}%</td>
                    </tr>`;
                });
                html += '</tbody></table></div></div>';
            }

            // Top Establishments
            if (reportData.top_establishments && reportData.top_establishments.length > 0) {
                html += '<div class="mb-6"><h4 class="text-lg font-bold mb-3">üèÜ Top Performing Establishments</h4>';
                html += '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Establishment</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Type</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Inspections</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Avg Score</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Best/Worst</th>';
                html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

                reportData.top_establishments.forEach(est => {
                    html += `<tr class="bg-green-50">
                        <td class="px-4 py-2 font-medium">${est.name}</td>
                        <td class="px-4 py-2 text-sm">${est.type}</td>
                        <td class="px-4 py-2">${est.count}</td>
                        <td class="px-4 py-2 font-bold text-green-600">${est.avg_score}%</td>
                        <td class="px-4 py-2 text-sm">${est.best_score}% / ${est.worst_score}%</td>
                    </tr>`;
                });
                html += '</tbody></table></div></div>';
            }

            // Failing Establishments
            if (reportData.failing_establishments && reportData.failing_establishments.length > 0) {
                html += '<div class="mb-6"><h4 class="text-lg font-bold mb-3">‚ö†Ô∏è Failing Establishments (Need Attention)</h4>';
                html += '<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Establishment</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Type</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Inspections</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Avg Score</th>';
                html += '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Best/Worst</th>';
                html += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

                reportData.failing_establishments.forEach(est => {
                    html += `<tr class="bg-red-50">
                        <td class="px-4 py-2 font-medium">${est.name}</td>
                        <td class="px-4 py-2 text-sm">${est.type}</td>
                        <td class="px-4 py-2">${est.count}</td>
                        <td class="px-4 py-2 font-bold text-red-600">${est.avg_score}%</td>
                        <td class="px-4 py-2 text-sm">${est.best_score}% / ${est.worst_score}%</td>
                    </tr>`;
                });
                html += '</tbody></table></div></div>';
            }

            reportBody.innerHTML = html;
            reportContent.style.display = 'block';
        }

        // Export report as PDF
        function exportReportPDF() {
            if (!window.currentReportParams) {
                showNotification('Please generate a report first', 'error');
                return;
            }

            const params = window.currentReportParams;
            const url = `/api/admin/download_report?${new URLSearchParams({
                report_type: params.reportType,
                inspection_type: params.inspectionType,
                start_date: params.startDate,
                end_date: params.endDate,
                format: 'pdf'
            }).toString()}`;

            window.open(url, '_blank');
            showNotification('üìÑ PDF report download started!', 'success');
        }

        // Export report as CSV
        function exportReportCSV() {
            if (!window.currentReportParams) {
                showNotification('Please generate a report first', 'error');
                return;
            }

            const params = window.currentReportParams;
            const url = `/api/admin/download_report?${new URLSearchParams({
                report_type: params.reportType,
                inspection_type: params.inspectionType,
                start_date: params.startDate,
                end_date: params.endDate,
                format: 'csv'
            }).toString()}`;

            window.open(url, '_blank');
            showNotification('üìä CSV report download started!', 'success');
        }

        // Show custom date range when selected
        document.getElementById('reportTimeframe').addEventListener('change', function() {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customRange.style.display = 'grid';
            } else {
                customRange.style.display = 'none';
            }
        });

        function displayReportPreview(report) {
            const resultsDiv = document.getElementById('reportResults');
            const contentDiv = document.getElementById('reportContent');

            if (report.error) {
                contentDiv.innerHTML = `<div class="text-red-600 p-4">Error: ${report.error}</div>`;
                resultsDiv.style.display = 'block';
                return;
            }

            let html = `<h3 class="text-xl font-bold mb-4">${report.title || 'Report Preview'}</h3>`;

            // Basic Summary Report
            if (report.summary) {
                html += `
                    <div class="report-summary mb-4">
                        <h4 class="text-lg font-bold text-blue-600 mb-2">üìä Summary Statistics</h4>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-blue-50 p-3 rounded">
                                <div class="text-2xl font-bold text-blue-600">${report.summary.total_inspections || 0}</div>
                                <div class="text-sm text-gray-600">Total Inspections</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded">
                                <div class="text-2xl font-bold text-green-600">${report.summary.passed_inspections || 0}</div>
                                <div class="text-sm text-gray-600">Passed</div>
                            </div>
                            <div class="bg-red-50 p-3 rounded">
                                <div class="text-2xl font-bold text-red-600">${report.summary.failed_inspections || 0}</div>
                                <div class="text-sm text-gray-600">Failed</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded">
                                <div class="text-2xl font-bold text-green-600">${report.summary.pass_percentage || 0}%</div>
                                <div class="text-sm text-gray-600">Pass Rate</div>
                            </div>
                            <div class="bg-red-50 p-3 rounded">
                                <div class="text-2xl font-bold text-red-600">${report.summary.fail_percentage || 0}%</div>
                                <div class="text-sm text-gray-600">Fail Rate</div>
                            </div>
                            <div class="bg-blue-50 p-3 rounded">
                                <div class="text-2xl font-bold text-blue-600">${report.summary.average_daily_inspections || 0}</div>
                                <div class="text-sm text-gray-600">Daily Average</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Trend Analysis specific content
            if (report.trend_direction) {
                html += `
                    <div class="trend-analysis mb-4">
                        <h4 class="text-lg font-bold text-orange-600 mb-2">üìà Trend Analysis</h4>
                        <p class="mb-2"><strong>Trend Direction:</strong> ${report.trend_direction}</p>
                        <p class="mb-2"><strong>Average Weekly Inspections:</strong> ${report.summary.avg_weekly_inspections || 0}</p>
                        <p class="mb-2"><strong>Average Failure Rate:</strong> ${report.summary.avg_failure_rate || 0}%</p>
                    </div>
                `;
            }

            // Failure Breakdown specific content
            if (report.top_failed_items) {
                html += `
                    <div class="failure-breakdown mb-4">
                        <h4 class="text-lg font-bold text-red-600 mb-2">‚ùå Most Common Failures</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Failure Reason</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Count</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                `;

                report.top_failed_items.slice(0, 5).forEach(item => {
                    html += `
                        <tr>
                            <td class="px-4 py-2 text-sm">${item.item}</td>
                            <td class="px-4 py-2 text-sm font-semibold">${item.count}</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // Inspector Performance specific content
            if (report.inspector_performance) {
                html += `
                    <div class="inspector-performance mb-4">
                        <h4 class="text-lg font-bold text-purple-600 mb-2">üë§ Inspector Performance</h4>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Inspector</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Pass Rate</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                `;

                report.inspector_performance.slice(0, 5).forEach(perf => {
                    html += `
                        <tr>
                            <td class="px-4 py-2 text-sm">${perf.inspector}</td>
                            <td class="px-4 py-2 text-sm">${perf.total_inspections}</td>
                            <td class="px-4 py-2 text-sm font-semibold">${perf.pass_rate}%</td>
                        </tr>
                    `;
                });

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            contentDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function downloadReport() {
            if (!window.currentReportData) {
                showNotification('Please generate a report first', 'error');
                return;
            }

            const reportType = document.getElementById('reportType').value;
            const inspectionType = document.getElementById('reportInspectionType').value;
            const timeframe = document.getElementById('reportTimeframe').value;

            let startDate, endDate;
            if (timeframe === 'custom') {
                startDate = document.getElementById('startDate').value;
                endDate = document.getElementById('endDate').value;
            } else {
                const days = parseInt(timeframe);
                endDate = new Date().toISOString().split('T')[0];
                startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            }

            // Create download URL
            const params = new URLSearchParams({
                reportType,
                inspectionType,
                startDate,
                endDate,
                format: 'pdf'
            });

            const url = `/api/admin/download_report?${params.toString()}`;

            // Create hidden link and trigger download
            const link = document.createElement('a');
            link.href = url;
            link.download = `inspection_report_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification('üì• Report downloaded as PDF!', 'success');
        }

        function scheduleReport() {
            showNotification('üìÖ Report scheduling feature coming soon!', 'info');
        }

        // This function is now defined above for simplified reports

        // ADD THESE FUNCTIONS TO YOUR EXISTING <script> SECTION

// Open Add User Form
function openAddUserForm() {
    document.getElementById('add_user_modal').classList.add('open');

    // Reset form
    document.getElementById('addUserForm').reset();
    document.getElementById('addUserError').style.display = 'none';
    document.getElementById('addUserSuccess').style.display = 'none';
}

// Handle Add User Form Submission
document.getElementById('addUserForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const userData = {
        username: formData.get('username'),
        email: formData.get('email'),
        password: formData.get('password'),
        role: formData.get('role')
    };

    const confirmPassword = formData.get('confirmPassword');

    // Clear previous messages
    document.getElementById('addUserError').style.display = 'none';
    document.getElementById('addUserSuccess').style.display = 'none';

    // Validate passwords match
    if (userData.password !== confirmPassword) {
        showFormError('addUser', 'Passwords do not match');
        return;
    }

    // Validate required fields
    if (!userData.username || !userData.email || !userData.password || !userData.role) {
        showFormError('addUser', 'All fields are required');
        return;
    }

    try {
        const response = await fetch('/api/admin/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(userData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
            showFormSuccess('addUser', 'User created successfully!');
            console.log('[User Management] New user created, reloading list...');

            // Clear form and reload users table immediately
            document.getElementById('addUserForm').reset();

            // Reload users table with a small delay to ensure DB commit
            setTimeout(async () => {
                await loadUsers();
                closeModal('add_user');
                showNotification('User added successfully!', 'success');
            }, 500);

        } else {
            showFormError('addUser', result.error || 'Failed to create user');
        }

    } catch (error) {
        console.error('Error creating user:', error);
        showFormError('addUser', 'Network error. Please try again.');
    }
});

// Handle New Task Form Submission
document.getElementById('newTaskForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const taskData = {
        title: formData.get('title'),
        description: formData.get('description'),
        assignee: formData.get('assignee'),
        priority: formData.get('priority'),
        due_date: formData.get('due_date')
    };

    // Validate required fields
    if (!taskData.title || !taskData.description || !taskData.assignee || !taskData.due_date) {
        alert('All fields are required');
        return;
    }

    try {
        const response = await fetch('/api/admin/tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(taskData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
            alert('Task created successfully!');
            closeNewTaskForm();
            // Reload tasks if there's a loadTasks function
            if (typeof loadTasks === 'function') {
                loadTasks();
            }
        } else {
            alert(result.error || 'Failed to create task');
        }

    } catch (error) {
        console.error('Error creating task:', error);
        alert('Network error. Please try again.');
    }
});

// Helper functions for form messages
function showFormError(formType, message) {
    const errorEl = document.getElementById(`${formType}Error`);
    if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
    }
}

function showFormSuccess(formType, message) {
    const successEl = document.getElementById(`${formType}Success`);
    if (successEl) {
        successEl.textContent = message;
        successEl.style.display = 'block';
    }
}

        // Window resize handler for charts
        window.addEventListener('resize', function() {
            if (typeof charts !== 'undefined' && charts) {
                Object.values(charts).forEach(chartObj => {
                    if (chartObj && chartObj.chart && chartObj.chart.resize && typeof chartObj.chart.resize === 'function') {
                        try {
                            chartObj.chart.resize();
                        } catch (error) {
                            console.log('Chart resize error:', error);
                        }
                    }
                });
            }
        });

        // Debug functions
        window.forceRefreshData = function(tab = 'overview') {
            console.log(`Force refreshing data for ${tab}`);
            loadTabData(tab, 'daily');
        };

        window.checkRealCounts = async function() {
            try {
                const response = await fetch('/api/inspection_counts');
                const counts = await response.json();
                console.log('Real inspection counts from database:', counts);
                return counts;
            } catch (error) {
                console.error('Could not fetch real counts:', error);
            }
        };

        // Legacy function compatibility - prevent errors from old buttons
        function generateReport() {
            console.log('generateReport called - redirecting to dashboard');
            generateDashboard();
        }

        function generateComprehensiveReport() {
            console.log('generateComprehensiveReport called - redirecting to dashboard');
            generateDashboard();
        }

        // Make functions globally available
        window.generateReport = generateReport;
        window.generateComprehensiveReport = generateComprehensiveReport;

        // Load dynamic form types for dropdown
        async function loadFormTypes() {
            try {
                // Get form types from API with counts from existing database
                const response = await fetch('/api/inspection_counts');
                const counts = await response.json();

                const dropdown = document.getElementById('reportInspectionType');
                if (!dropdown) return;

                // Clear existing options
                dropdown.innerHTML = '';

                // Add "All Types" option with total count
                const totalCount = Object.values(counts).reduce((sum, count) => sum + count, 0);
                dropdown.innerHTML += `<option value="all">All Types (${totalCount} total)</option>`;

                // Add standard form types with counts
                const standardFormTypes = {
                    'Food Establishment': counts.food_establishment || 0,
                    'Small Hotel': counts.small_hotel || 0,
                    'Swimming Pool': counts.swimming_pool || 0,
                    'Institutional Health': counts.institutional_health || 0,
                    'Spirit Licence Premises': counts.spirit_licence || 0,
                    'Barbershop': counts.barbershop || 0,
                    'Residential': counts.residential || 0,
                    'Burial': counts.burial || 0
                };

                // Add standard form types that have data
                Object.entries(standardFormTypes).forEach(([formType, count]) => {
                    if (count > 0) {
                        const displayName = formType === 'Burial' ? 'Burial Site' : formType;
                        dropdown.innerHTML += `<option value="${formType}">${displayName} (${count})</option>`;
                    }
                });

                // Add any custom form types from the API
                const standardKeys = Object.keys(standardFormTypes).map(k => k.toLowerCase().replace(' ', '_'));
                Object.entries(counts).forEach(([key, count]) => {
                    if (!standardKeys.includes(key) && count > 0) {
                        // Convert key back to display format
                        const displayName = key.split('_').map(word =>
                            word.charAt(0).toUpperCase() + word.slice(1)
                        ).join(' ');
                        dropdown.innerHTML += `<option value="${displayName}">${displayName} (${count})</option>`;
                    }
                });

                console.log('Form types loaded successfully');
            } catch (error) {
                console.error('Error loading form types:', error);
                // Fallback to static options if API fails
                const dropdown = document.getElementById('reportInspectionType');
                if (dropdown) {
                    dropdown.innerHTML = `
                        <option value="all">All Types</option>
                        <option value="Food Establishment">Food Establishment</option>
                        <option value="Small Hotel">Small Hotel</option>
                        <option value="Swimming Pool">Swimming Pool</option>
                        <option value="Institutional Health">Institutional Health</option>
                        <option value="Spirit Licence Premises">Spirit Licence Premises</option>
                        <option value="Barbershop">Barbershop</option>
                        <option value="Residential">Residential</option>
                        <option value="Burial">Burial Site</option>
                    `;
                }
            }
        }

        // Close messaging panel when clicking outside
        document.addEventListener('click', function(e) {
            const messagingPanel = document.getElementById('messagingPanel');
            const messagingBtn = document.getElementById('messagingToggleBtn');
            const chatWindow = document.getElementById('chatWindow');

            if (messagingOpen &&
                !messagingPanel.contains(e.target) &&
                !messagingBtn.contains(e.target) &&
                !chatWindow.contains(e.target)) {
                toggleMessaging();
            }
        });

        // Debug function
        window.testMessaging = function() {
            console.log('Testing messaging system...');
            toggleMessaging();
        };

        // Distribution Chart Variables
        let distributionCharts = {
            formTypeChart: null,
            passFailChart: null
        };

        // Load Distribution Data
        async function loadDistributionData() {
            console.log('Loading distribution data...');

            try {
                const response = await fetch(`/api/admin/form_distribution?t=${Date.now()}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Distribution data loaded:', data);

                // Update summary cards
                document.getElementById('totalDistributionCount').textContent = data.total_inspections || 0;
                document.getElementById('formTypesCount').textContent = data.distribution.length || 0;

                // Calculate overall pass rate
                let totalPass = 0;
                let totalFail = 0;
                data.pass_fail.forEach(item => {
                    totalPass += item.pass;
                    totalFail += item.fail;
                });
                const overallPassRate = totalPass + totalFail > 0
                    ? ((totalPass / (totalPass + totalFail)) * 100).toFixed(1)
                    : 0;
                document.getElementById('overallPassRate').textContent = `${overallPassRate}%`;

                // Render charts
                renderDistributionCharts(data);

                // Populate table
                populateDistributionTable(data);

            } catch (error) {
                console.error('Error loading distribution data:', error);
                showNotification('Failed to load distribution data: ' + error.message, 'error');
            }
        }

        // Render Distribution Charts
        function renderDistributionCharts(data) {
            // Destroy existing charts if they exist
            if (distributionCharts.formTypeChart) {
                distributionCharts.formTypeChart.destroy();
            }
            if (distributionCharts.passFailChart) {
                distributionCharts.passFailChart.destroy();
            }

            // Color palette
            const colors = [
                '#4F46E5', // Indigo
                '#10B981', // Green
                '#F59E0B', // Amber
                '#EF4444', // Red
                '#8B5CF6', // Purple
                '#06B6D4', // Cyan
                '#EC4899', // Pink
                '#14B8A6', // Teal
                '#F97316'  // Orange
            ];

            // Chart 1: Form Type Distribution
            const formTypeCtx = document.getElementById('formTypeDistributionChart').getContext('2d');
            distributionCharts.formTypeChart = new Chart(formTypeCtx, {
                type: 'pie',
                data: {
                    labels: data.distribution.map(item => item.form_type),
                    datasets: [{
                        data: data.distribution.map(item => item.count),
                        backgroundColor: colors.slice(0, data.distribution.length),
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Chart 2: Pass/Fail by Form Type
            const passFailCtx = document.getElementById('passFailByTypeChart').getContext('2d');
            const formTypes = data.pass_fail.map(item => item.form_type);
            const passData = data.pass_fail.map(item => item.pass);
            const failData = data.pass_fail.map(item => item.fail);

            distributionCharts.passFailChart = new Chart(passFailCtx, {
                type: 'bar',
                data: {
                    labels: formTypes,
                    datasets: [
                        {
                            label: 'Pass',
                            data: passData,
                            backgroundColor: '#10B981',
                            borderColor: '#059669',
                            borderWidth: 1
                        },
                        {
                            label: 'Fail',
                            data: failData,
                            backgroundColor: '#EF4444',
                            borderColor: '#DC2626',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: false,
                            ticks: {
                                font: {
                                    size: 10
                                },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const datasetIndex = context.datasetIndex;
                                    const formIndex = context.dataIndex;
                                    const passCount = passData[formIndex];
                                    const failCount = failData[formIndex];
                                    const total = passCount + failCount;
                                    const percentage = total > 0
                                        ? ((context.parsed.y / total) * 100).toFixed(1)
                                        : 0;
                                    return `${percentage}% of ${total} total`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Populate Distribution Table
        function populateDistributionTable(data) {
            const tbody = document.getElementById('distributionTableBody');
            tbody.innerHTML = '';

            // Combine distribution and pass_fail data
            const tableData = data.distribution.map(dist => {
                const passFail = data.pass_fail.find(pf => pf.form_type === dist.form_type) || { pass: 0, fail: 0 };
                return {
                    form_type: dist.form_type,
                    total: dist.count,
                    pass: passFail.pass,
                    fail: passFail.fail,
                    percentage: dist.percentage
                };
            });

            // Sort by total count descending
            tableData.sort((a, b) => b.total - a.total);

            tableData.forEach(row => {
                const passRate = row.total > 0
                    ? ((row.pass / row.total) * 100).toFixed(1)
                    : 0;

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${row.form_type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-700">${row.total}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-green-600 font-medium">${row.pass}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-red-600 font-medium">${row.fail}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-24 bg-gray-200 rounded-full h-2 mr-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${passRate}%"></div>
                            </div>
                            <span class="text-sm font-medium text-gray-700">${passRate}%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                            ${row.percentage}%
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        console.log('Admin Dashboard initialized successfully!');
    </script>
    {% include 'zozi_badge.html' %}
</body>
</html>