<!-- Admin Inline Form Editor - Direct Form Editing -->
<style>
    .admin-edit-controls {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        gap: 15px;
        flex-direction: column;
        z-index: 9999;
    }

    .admin-edit-btn, .admin-save-btn-fixed, .admin-cancel-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(238, 90, 111, 0.5);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .admin-save-btn-fixed {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
        display: none;
        font-size: 24px;
    }

    .admin-cancel-btn {
        background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%);
        box-shadow: 0 6px 20px rgba(255, 165, 0, 0.5);
        display: none;
        font-size: 24px;
    }

    .admin-edit-btn:hover, .admin-save-btn-fixed:hover, .admin-cancel-btn:hover {
        transform: translateY(-3px) scale(1.05);
    }

    /* Make form table editable in admin mode */
    body.admin-editing-mode .inspection-table tbody tr {
        background: rgba(255, 246, 143, 0.3) !important;
        transition: background 0.3s;
    }

    body.admin-editing-mode .inspection-table tbody tr:hover {
        background: rgba(255, 246, 143, 0.5) !important;
    }

    /* Editable cells */
    .editable-cell {
        position: relative;
    }

    .editable-cell input, .editable-cell textarea {
        display: none;
        width: 100%;
        padding: 8px;
        border: 2px solid #667eea;
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        background: white;
        box-sizing: border-box;
    }

    .editable-cell textarea {
        min-height: 60px;
        resize: vertical;
    }

    body.admin-editing-mode .editable-cell input,
    body.admin-editing-mode .editable-cell textarea {
        display: block;
    }

    body.admin-editing-mode .editable-cell .cell-display {
        display: none;
    }

    /* Critical checkbox styling */
    .critical-checkbox {
        display: none;
        margin-top: 5px;
    }

    body.admin-editing-mode .critical-checkbox {
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 12px;
        color: #333;
        background: white;
        padding: 5px 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .critical-checkbox input[type="checkbox"] {
        width: 16px !important;
        height: 16px;
        cursor: pointer;
    }

    /* Edit mode banner */
    .edit-mode-banner {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: bold;
        font-size: 18px;
        z-index: 9998;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    body.admin-editing-mode .edit-mode-banner {
        display: block;
    }

    body.admin-editing-mode {
        padding-top: 60px;
    }

    /* Success message */
    .admin-success-toast {
        position: fixed;
        top: 80px;
        right: 30px;
        background: #4CAF50;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        display: none;
        animation: slideIn 0.3s ease;
    }

    .admin-success-toast.show {
        display: block;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* Delete button for rows */
    .row-delete-btn {
        display: none;
        background: #dc3545;
        color: white;
        border: none;
        padding: 3px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
        margin-left: 5px;
    }

    body.admin-editing-mode .row-delete-btn {
        display: inline-block;
    }

    .row-delete-btn:hover {
        background: #c82333;
    }

    /* Editable text styling */
    body.admin-editing-mode .text-editable {
        cursor: text;
        min-height: 20px;
    }

    body.admin-editing-mode .text-editable:focus {
        outline: 2px solid #667eea !important;
        background: rgba(255, 246, 143, 0.4) !important;
    }

    /* Input field highlighting in edit mode */
    body.admin-editing-mode input:not([type="checkbox"]):not([type="radio"]),
    body.admin-editing-mode textarea,
    body.admin-editing-mode select {
        border: 1px solid rgba(102, 126, 234, 0.5) !important;
        transition: all 0.2s;
    }

    body.admin-editing-mode input:focus:not([type="checkbox"]):not([type="radio"]),
    body.admin-editing-mode textarea:focus,
    body.admin-editing-mode select:focus {
        border: 2px solid #667eea !important;
        background: white !important;
        outline: none;
    }
</style>

<!-- Edit Mode Banner -->
<div class="edit-mode-banner">
    ‚úèÔ∏è EDIT MODE ACTIVE - Everything on the form is now editable (labels, headings, checklist items, and all fields)
</div>

<!-- Success Toast -->
<div class="admin-success-toast" id="adminSuccessToast">
    ‚úÖ Changes saved successfully!
</div>

<!-- Edit Controls -->
<div class="admin-edit-controls">
    <button class="admin-edit-btn" id="adminEditBtn" onclick="enterEditMode()" title="Edit Form (Admin)">
        ‚úèÔ∏è
    </button>
    <button class="admin-save-btn-fixed" id="adminSaveBtn" onclick="saveFormEdits()" title="Save Changes">
        üíæ
    </button>
    <button class="admin-cancel-btn" id="adminCancelBtn" onclick="cancelEditMode()" title="Cancel Edits">
        ‚ùå
    </button>
</div>

<script>
    let adminFormType = '';
    let adminChecklistData = [];
    let adminOriginalData = [];
    let isEditMode = false;

    // Detect form type from page
    function detectFormType() {
        const title = document.title;
        if (title.includes('Food')) return 'Food Establishment';
        if (title.includes('Barbershop')) return 'Barbershop';
        if (title.includes('Burial')) return 'Burial';
        if (title.includes('Hotel')) return 'Small Hotel';
        if (title.includes('Institutional')) return 'Institutional';
        if (title.includes('Meat')) return 'Meat Processing';
        if (title.includes('Residential')) return 'Residential';
        if (title.includes('Spirit')) return 'Spirit Licence Premises';
        if (title.includes('Pool')) return 'Swimming Pool';
        return 'Food Establishment';
    }

    async function enterEditMode() {
        adminFormType = detectFormType();

        // Load current checklist data
        try {
            const response = await fetch(`/api/admin/get_checklist_items?form_type=${encodeURIComponent(adminFormType)}`);
            const data = await response.json();

            if (!data.success) {
                alert('Failed to load checklist items');
                return;
            }

            adminChecklistData = data.items;
            adminOriginalData = JSON.parse(JSON.stringify(data.items)); // Deep copy

            // Enter edit mode
            isEditMode = true;
            document.body.classList.add('admin-editing-mode');
            document.getElementById('adminEditBtn').style.display = 'none';
            document.getElementById('adminSaveBtn').style.display = 'flex';
            document.getElementById('adminCancelBtn').style.display = 'flex';

            // Make form editable
            makeFormEditable();
        } catch (error) {
            console.error('Error entering edit mode:', error);
            alert('Error loading form data');
        }
    }

    function cancelEditMode() {
        if (confirm('Discard all changes?')) {
            isEditMode = false;
            document.body.classList.remove('admin-editing-mode');
            document.getElementById('adminEditBtn').style.display = 'flex';
            document.getElementById('adminSaveBtn').style.display = 'none';
            document.getElementById('adminCancelBtn').style.display = 'none';

            // Reload page to reset form
            window.location.reload();
        }
    }

    function makeFormEditable() {
        // 1. Make all form inputs editable/enabled
        const allInputs = document.querySelectorAll('input, textarea, select');
        allInputs.forEach(input => {
            // Remove readonly and disabled attributes to make them editable
            input.removeAttribute('readonly');
            input.removeAttribute('disabled');
            // Add a visual indicator that it's editable
            input.style.background = 'rgba(255, 246, 143, 0.2)';
        });

        // 2. Make all labels editable
        const allLabels = document.querySelectorAll('label');
        allLabels.forEach(label => {
            makeTextEditable(label);
        });

        // 3. Make all headings editable
        const headings = document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        headings.forEach(heading => {
            makeTextEditable(heading);
        });

        // 4. Make category headers in tables editable
        const categoryHeaders = document.querySelectorAll('.category-header');
        categoryHeaders.forEach(header => {
            makeTextEditable(header);
        });

        // 5. Make table headers editable
        const tableHeaders = document.querySelectorAll('th');
        tableHeaders.forEach(th => {
            makeTextEditable(th);
        });

        // 6. Find the checklist table and make checklist items editable
        const tables = document.querySelectorAll('table');
        let checklistTable = null;

        // Find the table with checklist items
        for (let table of tables) {
            const firstCell = table.querySelector('tbody tr td:first-child');
            if (firstCell && firstCell.textContent.trim().match(/^\d+$/)) {
                checklistTable = table;
                break;
            }
        }

        if (!checklistTable) {
            console.warn('Could not find checklist table');
            return;
        }

        // Add editable fields to each checklist row
        const rows = checklistTable.querySelectorAll('tbody tr');
        let checklistIndex = 0;

        rows.forEach((row) => {
            const cells = row.querySelectorAll('td');
            if (cells.length < 2) return;

            // Skip category header rows
            if (row.classList.contains('category-header')) {
                return;
            }

            const itemIdCell = cells[0];
            const descriptionCell = cells[1];

            // Make item ID editable
            const itemIdText = itemIdCell.textContent.trim();
            itemIdCell.classList.add('editable-cell');
            itemIdCell.innerHTML = `
                <span class="cell-display">${itemIdText}</span>
                <input type="number" value="${itemIdText}" data-index="${checklistIndex}" data-field="item_id" onchange="updateChecklistField(this)" min="1">
            `;

            // Make description editable
            const descText = descriptionCell.textContent.trim();
            descriptionCell.classList.add('editable-cell');
            descriptionCell.innerHTML = `
                <span class="cell-display">${descText}</span>
                <textarea data-index="${checklistIndex}" data-field="description" onchange="updateChecklistField(this)">${descText}</textarea>
                <label class="critical-checkbox">
                    <input type="checkbox" data-index="${checklistIndex}" data-field="is_critical"
                           onchange="updateChecklistField(this)" ${adminChecklistData[checklistIndex]?.is_critical ? 'checked' : ''}>
                    <span>Critical (Shaded)</span>
                </label>
            `;

            // Add weight column if it exists (usually 3rd column)
            if (cells.length >= 3) {
                const weightCell = cells[2];
                const weightText = weightCell.textContent.trim();
                if (weightText.match(/^\d+$/) || weightText.match(/^\d+\.\d+$/)) {
                    weightCell.classList.add('editable-cell');
                    weightCell.innerHTML = `
                        <span class="cell-display">${weightText}</span>
                        <input type="number" value="${weightText}" data-index="${checklistIndex}" data-field="weight" onchange="updateChecklistField(this)" min="1" max="10" step="0.1">
                    `;
                }
            }

            // Add delete button to first cell
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'row-delete-btn';
            deleteBtn.textContent = 'üóëÔ∏è';
            deleteBtn.onclick = () => deleteRow(checklistIndex);
            itemIdCell.appendChild(deleteBtn);

            checklistIndex++;
        });
    }

    // Helper function to make any text element editable
    function makeTextEditable(element) {
        // Skip if element is empty or already editable
        if (!element.textContent.trim() || element.classList.contains('text-editable')) {
            return;
        }

        // Skip elements that contain form controls
        if (element.querySelector('input, textarea, select, button')) {
            return;
        }

        element.classList.add('text-editable');
        const originalText = element.innerHTML;

        // Store original text
        element.setAttribute('data-original-text', originalText);

        // Make contenteditable when in edit mode
        element.setAttribute('contenteditable', 'true');
        element.style.outline = '1px dashed rgba(102, 126, 234, 0.3)';
        element.style.padding = '2px 4px';
        element.style.borderRadius = '3px';
        element.style.transition = 'all 0.2s';

        // Add hover effect
        element.addEventListener('mouseenter', function() {
            if (isEditMode) {
                this.style.background = 'rgba(255, 246, 143, 0.3)';
                this.style.outline = '1px dashed rgba(102, 126, 234, 0.6)';
            }
        });

        element.addEventListener('mouseleave', function() {
            if (isEditMode) {
                this.style.background = 'transparent';
                this.style.outline = '1px dashed rgba(102, 126, 234, 0.3)';
            }
        });
    }

    function updateChecklistField(input) {
        const index = parseInt(input.dataset.index);
        const field = input.dataset.field;

        if (field === 'is_critical') {
            adminChecklistData[index][field] = input.checked ? 1 : 0;
        } else if (field === 'item_id' || field === 'weight') {
            adminChecklistData[index][field] = parseInt(input.value) || 1;
        } else {
            adminChecklistData[index][field] = input.value;
        }
    }

    function deleteRow(index) {
        if (confirm('Delete this checklist item?')) {
            adminChecklistData[index]._deleted = true;
            // Hide the row visually
            const tables = document.querySelectorAll('table tbody tr');
            if (tables[index]) {
                tables[index].style.display = 'none';
            }
        }
    }

    async function saveFormEdits() {
        const saveBtn = document.getElementById('adminSaveBtn');
        saveBtn.textContent = '‚è≥';
        saveBtn.disabled = true;

        try {
            // Separate deleted items
            const deletedIds = adminChecklistData
                .filter(item => item._deleted && item.id)
                .map(item => item.id);

            // Items to save (not deleted)
            const itemsToSave = adminChecklistData.filter(item => !item._deleted);

            const response = await fetch('/api/admin/update_checklist_items', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    form_type: adminFormType,
                    items: itemsToSave.map((item, idx) => ({
                        id: item.id,
                        item_id: item.item_id,
                        description: item.description,
                        weight: item.weight,
                        is_critical: item.is_critical ? 1 : 0,
                        is_new: false
                    })),
                    deleted_ids: deletedIds
                })
            });

            const data = await response.json();

            if (data.success) {
                // Show success toast
                document.getElementById('adminSuccessToast').classList.add('show');
                setTimeout(() => {
                    document.getElementById('adminSuccessToast').classList.remove('show');
                    window.location.reload();
                }, 2000);
            } else {
                alert('Error saving changes: ' + (data.error || 'Unknown error'));
                saveBtn.textContent = 'üíæ';
                saveBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error saving changes:', error);
            alert('Error saving changes. Please try again.');
            saveBtn.textContent = 'üíæ';
            saveBtn.disabled = false;
        }
    }

    // ESC to cancel
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && isEditMode) {
            cancelEditMode();
        }
    });
</script>