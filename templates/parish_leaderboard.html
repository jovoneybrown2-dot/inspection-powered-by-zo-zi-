<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Inspection Intelligence Platform | Ministry Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #0066cc;
            --secondary-blue: #4da6ff;
            --success-green: #00cc66;
            --warning-amber: #ff9900;
            --danger-red: #ff3333;
            --purple-accent: #6633cc;
            --dark-bg: #0f1419;
            --card-bg: #1a1f2e;
            --glass-bg: rgba(26, 31, 46, 0.8);
            --border-color: rgba(77, 166, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --shadow-glow: 0 0 40px rgba(0, 102, 204, 0.3);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a1f2e 50%, #0f1419 100%);
            color: var(--text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Background */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(circle at 20% 80%, rgba(0, 102, 204, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(102, 51, 204, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(0, 204, 102, 0.05) 0%, transparent 50%);
            animation: bgFloat 20s ease-in-out infinite;
        }

        @keyframes bgFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(1deg); }
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(26, 31, 46, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(77, 166, 255, 0.1), transparent);
            animation: headerScan 3s ease-in-out infinite;
        }

        @keyframes headerScan {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .logo-section h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #4da6ff, #00cc66, #6633cc);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .logo-section p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .status-indicators {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: rgba(77, 166, 255, 0.1);
            border: 1px solid rgba(77, 166, 255, 0.3);
            border-radius: 12px;
            font-weight: 600;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.online { background: var(--success-green); }
        .status-dot.warning { background: var(--warning-amber); }
        .status-dot.critical { background: var(--danger-red); }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        /* Main Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto auto auto;
            gap: 20px;
            margin-bottom: 30px;
        }

        /* KPI Cards */
        .kpi-section {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-glow);
            border-color: var(--secondary-blue);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue), var(--success-green));
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .kpi-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .trend-up { color: var(--success-green); }
        .trend-down { color: var(--danger-red); }
        .trend-stable { color: var(--warning-amber); }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .kpi-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Chart Cards */
        .chart-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .chart-card h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Risk Assessment */
        .risk-assessment {
            grid-column: 1 / -1;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .risk-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .risk-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .risk-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .risk-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .risk-high { background: var(--danger-red); }
        .risk-medium { background: var(--warning-amber); }
        .risk-low { background: var(--success-green); }

        .risk-content h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .risk-content p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* AI Insights */
        .ai-insights {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, rgba(102, 51, 204, 0.1), rgba(0, 102, 204, 0.1));
            backdrop-filter: blur(15px);
            border: 1px solid rgba(102, 51, 204, 0.3);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .ai-insights::before {
            content: 'ü§ñ';
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            opacity: 0.3;
        }

        .insight-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-priority {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .priority-high { background: var(--danger-red); }
        .priority-medium { background: var(--warning-amber); }
        .priority-low { background: var(--success-green); }

        /* Map Section */
        .map-section {
            grid-column: 1 / -1;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            height: 500px;
        }

        #map {
            height: 400px;
            border-radius: 12px;
            margin-top: 20px;
        }

        /* Performance Metrics */
        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .logo-section h1 {
                font-size: 2rem;
            }
        }

        /* Loading Animations */
        .loading {
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(90deg, var(--danger-red), var(--warning-amber));
            padding: 12px 24px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            animation: alertPulse 2s ease-in-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-mode.css') }}">
</head>
<body>
    <button class="theme-toggle-btn" onclick="toggleTheme()">Dark</button>

    <div class="bg-animation"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <h1>WRHA Intelligence Platform</h1>
                    <p>Ministry of Health ‚Ä¢ Inspection Analytics & Predictive Intelligence</p>
                </div>
                <div class="status-indicators">
                    <div class="status-indicator">
                        <div class="status-dot online"></div>
                        <span>System Online</span>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot warning"></div>
                        <span>3 Alerts</span>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot critical"></div>
                        <span>Live Data</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Alert Banner -->
        <div class="alert-banner">
            üö® CRITICAL ALERT: 3 facilities require immediate attention ‚Ä¢ Public health risk assessment in progress
        </div>

        <!-- KPI Section -->
        <section class="kpi-section">
            <div class="kpi-card" onclick="drillDown('total')">
                <div class="kpi-header">
                    <span class="kpi-title">Total Inspections</span>
                    <span class="kpi-trend trend-up">‚Üó +12.3%</span>
                </div>
                <div class="kpi-value">44</div>
                <div class="kpi-subtitle">This Quarter</div>
            </div>

            <div class="kpi-card" onclick="drillDown('compliance')">
                <div class="kpi-header">
                    <span class="kpi-title">Compliance Rate</span>
                    <span class="kpi-trend trend-up">‚Üó +5.2%</span>
                </div>
                <div class="kpi-value" style="color: var(--success-green);">87.3%</div>
                <div class="kpi-subtitle">Overall Performance</div>
            </div>

            <div class="kpi-card" onclick="drillDown('risk')">
                <div class="kpi-header">
                    <span class="kpi-title">High Risk Facilities</span>
                    <span class="kpi-trend trend-down">‚Üò -2</span>
                </div>
                <div class="kpi-value" style="color: var(--danger-red);">7</div>
                <div class="kpi-subtitle">Require Immediate Action</div>
            </div>

            <div class="kpi-card" onclick="drillDown('efficiency')">
                <div class="kpi-header">
                    <span class="kpi-title">Inspection Efficiency</span>
                    <span class="kpi-trend trend-up">‚Üó +8.7%</span>
                </div>
                <div class="kpi-value" style="color: var(--secondary-blue);">94.2%</div>
                <div class="kpi-subtitle">Resource Utilization</div>
            </div>

            <div class="kpi-card" onclick="drillDown('prediction')">
                <div class="kpi-header">
                    <span class="kpi-title">AI Prediction Accuracy</span>
                    <span class="kpi-trend trend-up">‚Üó +15.1%</span>
                </div>
                <div class="kpi-value" style="color: var(--purple-accent);">96.8%</div>
                <div class="kpi-subtitle">Machine Learning Model</div>
            </div>

            <div class="kpi-card" onclick="drillDown('cost')">
                <div class="kpi-header">
                    <span class="kpi-title">Cost Savings</span>
                    <span class="kpi-trend trend-up">‚Üó +23.4%</span>
                </div>
                <div class="kpi-value" style="color: var(--success-green);">$2.4M</div>
                <div class="kpi-subtitle">Through Optimization</div>
            </div>
        </section>

        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Inspection Trends Chart -->
            <div class="chart-card">
                <h3>üìà Inspection Trends & Forecasting</h3>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <!-- Compliance Distribution -->
            <div class="chart-card">
                <h3>üéØ Compliance Distribution</h3>
                <div class="chart-container">
                    <canvas id="complianceChart"></canvas>
                </div>
            </div>

            <!-- Risk Assessment Radar -->
            <div class="chart-card">
                <h3>‚ö†Ô∏è Multi-Dimensional Risk Analysis</h3>
                <div class="chart-container">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Risk Assessment Section -->
        <section class="risk-assessment">
            <h3>üõ°Ô∏è Real-Time Risk Assessment & Public Health Impact</h3>
            <div class="risk-grid">
                <div class="risk-item">
                    <div class="risk-indicator risk-high"></div>
                    <div class="risk-content">
                        <h4>Food Establishments - Savanna-la-Mar</h4>
                        <p>3 facilities with critical violations ‚Ä¢ Population at risk: 15,000</p>
                    </div>
                </div>
                <div class="risk-item">
                    <div class="risk-indicator risk-medium"></div>
                    <div class="risk-content">
                        <h4>Swimming Pools - Tourist Areas</h4>
                        <p>Water quality concerns detected ‚Ä¢ 2 facilities pending re-inspection</p>
                    </div>
                </div>
                <div class="risk-item">
                    <div class="risk-indicator risk-high"></div>
                    <div class="risk-content">
                        <h4>Residential Water Systems</h4>
                        <p>Vector breeding sites identified ‚Ä¢ Disease outbreak potential: HIGH</p>
                    </div>
                </div>
                <div class="risk-item">
                    <div class="risk-indicator risk-low"></div>
                    <div class="risk-content">
                        <h4>Spirit Licence Premises</h4>
                        <p>All facilities compliant ‚Ä¢ No immediate concerns</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- AI Insights -->
        <section class="ai-insights">
            <h3>ü§ñ AI-Powered Insights & Recommendations</h3>
            <div class="insight-item">
                <div class="insight-priority priority-high"></div>
                <p><strong>Predictive Alert:</strong> Food establishment at coordinates 18.2208¬∞N, 78.1458¬∞W likely to fail next inspection (89% confidence). Recommend immediate intervention.</p>
            </div>
            <div class="insight-item">
                <div class="insight-priority priority-medium"></div>
                <p><strong>Resource Optimization:</strong> Reallocate 2 inspectors from low-risk zones to high-risk areas for 23% efficiency improvement.</p>
            </div>
            <div class="insight-item">
                <div class="insight-priority priority-high"></div>
                <p><strong>Outbreak Prevention:</strong> Dengue risk elevated in residential areas. Deploy vector control teams to 4 identified hotspots immediately.</p>
            </div>
            <div class="insight-item">
                <div class="insight-priority priority-low"></div>
                <p><strong>Training Opportunity:</strong> Inspector performance variance detected. Recommend specialized training for water quality assessments.</p>
            </div>
        </section>

        <!-- Performance Metrics -->
        <section class="chart-card">
            <h3>üìä Advanced Performance Analytics</h3>
            <div class="performance-grid">
                <div class="metric-card" onclick="showDetails('response')">
                    <div class="metric-value" style="color: var(--success-green);">2.3h</div>
                    <div class="metric-label">Avg Response Time</div>
                </div>
                <div class="metric-card" onclick="showDetails('satisfaction')">
                    <div class="metric-value" style="color: var(--secondary-blue);">94.7%</div>
                    <div class="metric-label">Stakeholder Satisfaction</div>
                </div>
                <div class="metric-card" onclick="showDetails('prevention')">
                    <div class="metric-value" style="color: var(--purple-accent);">156</div>
                    <div class="metric-label">Incidents Prevented</div>
                </div>
                <div class="metric-card" onclick="showDetails('automation')">
                    <div class="metric-value" style="color: var(--warning-amber);">73%</div>
                    <div class="metric-label">Process Automation</div>
                </div>
            </div>
        </section>

        <!-- Geographic Risk Map -->
        <section class="map-section">
            <h3>üó∫Ô∏è Geographic Risk Intelligence & Heat Mapping</h3>
            <div id="map"></div>
        </section>
    </div>

    <script>
        // Chart variables
        let trendsChart = null;
        let currentInspectionCount = 44;
        let notificationQueue = [];
        let notificationIndex = 0;

        // Pre-defined notification messages for continuous updates
        const notificationMessages = [
            { message: 'üöÄ Healthcare Intelligence Platform initialized. AI models active.', type: 'success' },
            { message: 'üìä Real-time data stream established. Monitoring 247 facilities.', type: 'info' },
            { message: 'üîç AI detected anomaly in water quality data - investigating...', type: 'warning' },
            { message: 'üìà New inspection completed! Dashboard updated with latest data.', type: 'info' },
            { message: 'ü§ñ Predictive model updated with 99.2% accuracy rate.', type: 'success' },
            { message: '‚ö†Ô∏è High-risk facility alert - Savanna-la-Mar Food Establishment flagged.', type: 'warning' },
            { message: 'üìã Weekly compliance report generated automatically.', type: 'info' },
            { message: 'üéØ Resource allocation optimized - 15% efficiency gain detected.', type: 'success' },
            { message: 'üîÑ Vector control deployment recommended for 3 locations.', type: 'warning' },
            { message: 'üì± Mobile inspection unit dispatched to high-priority site.', type: 'info' },
            { message: 'üè• Public health risk assessment completed - updating protocols.', type: 'success' },
            { message: 'üìà Trend analysis shows 23% improvement in response times.', type: 'success' },
            { message: 'üîî Automated alert: Temperature monitoring threshold exceeded.', type: 'warning' },
            { message: 'üí° AI recommendation: Redistribute inspection teams for optimal coverage.', type: 'info' },
            { message: 'üéâ Milestone achieved: 1000+ successful inspections this quarter!', type: 'success' }
        ];

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            initializeMap();
            startContinuousNotifications();
            startRealTimeUpdates();
            startAdvancedMonitoring();
        });

        // Continuous notification system
        function startContinuousNotifications() {
            // Show first notification immediately
            setTimeout(() => {
                showNextNotification();
            }, 500);

            // Continue showing notifications every 3-6 seconds
            setInterval(() => {
                showNextNotification();
            }, getRandomInterval(3000, 6000));
        }

        function showNextNotification() {
            if (notificationMessages.length > 0) {
                const notification = notificationMessages[notificationIndex];
                showAlert(notification.message, notification.type);

                notificationIndex = (notificationIndex + 1) % notificationMessages.length;
            }
        }

        function getRandomInterval(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Enhanced real-time updates
        function startRealTimeUpdates() {
            // Update KPIs every 8-12 seconds
            setInterval(() => {
                updateKPIs();
            }, getRandomInterval(8000, 12000));

            // Simulate data stream every 2 seconds
            setInterval(() => {
                simulateDataStream();
            }, 2000);
        }

        // Advanced monitoring system
        function startAdvancedMonitoring() {
            // System health checks every 15 seconds
            setInterval(() => {
                performSystemHealthCheck();
            }, 15000);

            // Update status indicators every 5 seconds
            setInterval(() => {
                updateStatusIndicators();
            }, 5000);
        }

        function performSystemHealthCheck() {
            const healthMessages = [
                { message: 'üíö System health check: All modules operational.', type: 'success' },
                { message: 'üîß Performing routine maintenance - no impact on monitoring.', type: 'info' },
                { message: 'üìä Database optimization complete - query speed improved.', type: 'success' },
                { message: 'üîí Security scan completed - all systems secure.', type: 'success' }
            ];

            const randomHealth = healthMessages[Math.floor(Math.random() * healthMessages.length)];
            if (Math.random() > 0.7) { // 30% chance
                showAlert(randomHealth.message, randomHealth.type);
            }
        }

        function updateStatusIndicators() {
            const statusDots = document.querySelectorAll('.status-dot');
            statusDots.forEach(dot => {
                // Add extra pulse animation
                dot.style.animation = 'none';
                setTimeout(() => {
                    dot.style.animation = 'pulse 2s ease-in-out infinite';
                }, 10);
            });
        }

        // Charts Configuration
        function initializeCharts() {
            // Trends Chart
            const trendsCtx = document.getElementById('trendsChart').getContext('2d');
            trendsChart = new Chart(trendsCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Inspections Completed',
                        data: [28, 35, 42, 38, 44, null, null, null, null, null, null, null],
                        borderColor: '#4da6ff',
                        backgroundColor: 'rgba(77, 166, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'AI Predicted',
                        data: [30, 37, 45, 41, 47, 54, 51, 58, 64, 61, 68, 75],
                        borderColor: '#6633cc',
                        backgroundColor: 'rgba(102, 51, 204, 0.1)',
                        borderDash: [5, 5],
                        fill: false,
                        tension: 0.4
                    }, {
                        label: 'Current Position',
                        data: [null, null, null, null, 44, null, null, null, null, null, null, null],
                        borderColor: '#ff3333',
                        backgroundColor: '#ff3333',
                        pointBackgroundColor: '#ff3333',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3,
                        pointRadius: 10,
                        pointHoverRadius: 12,
                        showLine: false,
                        fill: false,
                        pointStyle: 'circle'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });

            startRedDotBlinking();

            // Compliance Chart
            const complianceCtx = document.getElementById('complianceChart').getContext('2d');
            new Chart(complianceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Excellent (90-100%)', 'Good (80-89%)', 'Fair (70-79%)', 'Poor (<70%)'],
                    datasets: [{
                        data: [12, 18, 10, 4],
                        backgroundColor: ['#00cc66', '#4da6ff', '#ff9900', '#ff3333'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#ffffff', padding: 20 }
                        }
                    }
                }
            });

            // Risk Chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            new Chart(riskCtx, {
                type: 'radar',
                data: {
                    labels: ['Food Safety', 'Water Quality', 'Sanitation', 'Structural', 'Documentation', 'Staff Training'],
                    datasets: [{
                        label: 'Current Risk Level',
                        data: [85, 92, 78, 88, 95, 82],
                        borderColor: '#4da6ff',
                        backgroundColor: 'rgba(77, 166, 255, 0.2)',
                        pointBackgroundColor: '#4da6ff'
                    }, {
                        label: 'Target Level',
                        data: [95, 95, 90, 95, 98, 90],
                        borderColor: '#00cc66',
                        backgroundColor: 'rgba(0, 204, 102, 0.1)',
                        pointBackgroundColor: '#00cc66'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        r: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.3)' },
                            pointLabels: { color: '#ffffff' }
                        }
                    }
                }
            });
        }

        // Red dot blinking function
        function startRedDotBlinking() {
            setInterval(() => {
                if (trendsChart) {
                    const canvas = trendsChart.canvas;
                    canvas.style.filter = 'drop-shadow(0 0 15px rgba(255, 51, 51, 0.8))';
                    setTimeout(() => {
                        canvas.style.filter = 'drop-shadow(0 0 5px rgba(255, 51, 51, 0.3))';
                    }, 500);
                }
            }, 1000);
        }

        // Update chart when KPI changes
        function updateTrendsChart(newInspectionCount) {
            if (trendsChart) {
                const inspectionData = trendsChart.data.datasets[0].data;
                const baseCount = 44;
                const startMonth = 4; // May
                const increment = newInspectionCount - baseCount;
                const currentMonth = Math.min(startMonth + Math.floor(increment / 3), 11);
                const currentMonthValue = baseCount + increment;

                // Update completed line
                for (let i = startMonth; i <= currentMonth; i++) {
                    if (i === currentMonth) {
                        inspectionData[i] = currentMonthValue;
                    } else if (i > startMonth && i < currentMonth) {
                        const progress = (i - startMonth) / (currentMonth - startMonth);
                        inspectionData[i] = Math.round(baseCount + (increment * progress));
                    }
                }

                // Update red dot position
                const redDotData = trendsChart.data.datasets[2].data;
                for (let i = 0; i < redDotData.length; i++) {
                    redDotData[i] = null;
                }
                redDotData[currentMonth] = currentMonthValue;

                trendsChart.update('active');

                // Extra pulse when updating
                const canvas = trendsChart.canvas;
                canvas.style.filter = 'drop-shadow(0 0 25px rgba(255, 51, 51, 1))';
                setTimeout(() => {
                    canvas.style.filter = 'drop-shadow(0 0 5px rgba(255, 51, 51, 0.3))';
                }, 1000);
            }
        }

        // Initialize Map
        function initializeMap() {
            const map = L.map('map').setView([18.2208, -78.1458], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Risk markers
            const riskData = [
                { lat: 18.2208, lng: -78.1458, risk: 'high', type: 'Food Establishment', details: 'Critical violations detected' },
                { lat: 18.1956, lng: -78.1325, risk: 'medium', type: 'Swimming Pool', details: 'Water quality concerns' },
                { lat: 18.2456, lng: -78.1687, risk: 'low', type: 'Spirit Licence', details: 'Compliant facility' },
                { lat: 18.2108, lng: -78.1258, risk: 'high', type: 'Residential', details: 'Vector breeding sites' },
                { lat: 18.1856, lng: -78.1425, risk: 'medium', type: 'Small Hotel', details: 'Minor violations' }
            ];

            riskData.forEach(location => {
                const color = location.risk === 'high' ? '#ff3333' :
                             location.risk === 'medium' ? '#ff9900' : '#00cc66';

                L.circleMarker([location.lat, location.lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    radius: location.risk === 'high' ? 12 : 8
                }).addTo(map)
                .bindPopup(`<strong>${location.type}</strong><br>${location.details}`);
            });
        }

        // Enhanced KPI Updates
        function updateKPIs() {
            const kpiValues = document.querySelectorAll('.kpi-value');

            // Always update inspections count (more frequent)
            if (Math.random() > 0.4) { // 60% chance
                const current = parseInt(kpiValues[0].textContent);
                const newValue = current + 1;
                currentInspectionCount = newValue;
                kpiValues[0].textContent = newValue;
                kpiValues[0].style.animation = 'kpiUpdate 2s ease';

                updateTrendsChart(newValue);
                showAlert('üìà New inspection completed! Dashboard updated with latest data.', 'info');
            }

            // Update other KPIs occasionally
            if (Math.random() > 0.8) { // 20% chance
                const complianceEl = kpiValues[1];
                const currentCompliance = parseFloat(complianceEl.textContent);
                const newCompliance = (currentCompliance + (Math.random() - 0.5) * 0.2).toFixed(1);
                complianceEl.textContent = newCompliance + '%';
                complianceEl.style.animation = 'kpiUpdate 2s ease';
                showAlert(`üìä Compliance rate updated to ${newCompliance}% - trend analysis complete.`, 'info');
            }
        }

        function simulateDataStream() {
            // Visual feedback for live data
            const statusDots = document.querySelectorAll('.status-dot');
            statusDots.forEach(dot => {
                dot.style.animation = 'none';
                setTimeout(() => {
                    dot.style.animation = 'pulse 2s ease-in-out infinite';
                }, 10);
            });

            // Occasional automatic alerts
            if (Math.random() > 0.9) { // 10% chance
                const streamMessages = [
                    'üîÑ Data synchronization complete - all sensors online.',
                    'üì° Satellite connection established - remote facilities connected.',
                    'üîç Pattern recognition algorithm detected compliance improvement.',
                    '‚ö° Real-time processing: 247 data points analyzed per second.'
                ];
                const randomMsg = streamMessages[Math.floor(Math.random() * streamMessages.length)];
                showAlert(randomMsg, 'info');
            }
        }

        // Interactive Functions
        function drillDown(metric) {
            showAlert(`üîç Analyzing ${metric} data... Opening detailed drill-down view`, 'info');

            setTimeout(() => {
                showAlert(`üìä Deep analysis complete for ${metric}. Detailed insights available.`, 'success');
            }, 2000);
        }

        function showDetails(metric) {
            showAlert(`üìã Loading detailed ${metric} analytics... Preparing executive report`, 'info');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 140px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? 'rgba(0, 204, 102, 0.9)' :
                           type === 'warning' ? 'rgba(255, 153, 0, 0.9)' :
                           'rgba(77, 166, 255, 0.9)'};
                color: white;
                border-radius: 12px;
                font-weight: 600;
                z-index: 1000;
                animation: slideIn 0.5s ease, slideOut 0.5s ease 4s;
                max-width: 400px;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => alertDiv.remove(), 5000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            @keyframes kpiUpdate {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); color: var(--success-green); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // Executive Summary Generation
        function generateExecutiveSummary() {
            showAlert('üìÑ Generating executive summary with AI insights...', 'info');
            setTimeout(() => {
                showAlert('‚úÖ Executive summary ready for Ministry review!', 'success');
            }, 3000);
        }
    </script>
    {% include 'zozi_badge.html' %}
    <script src="{{ url_for('static', filename='js/dark-mode.js') }}"></script>
</body>
</html>